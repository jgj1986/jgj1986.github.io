---
title: mysql use
date: 2014-11-10 17:12:28 +0800
tags: database 
- a
- b
---

* toc 
{:toc}

> 使用mysql的过程中，有些东西查询才知道怎么，这里就记录下，算是个笔记。

## 修改最大连接数  

系统发出告警，mysql打开的连接超过100个，汗，100个的连接，不多。有时候设置上几个连接池可能就要有100个连接。所以修改下myql允许的最大连接数。  

###配置文件  

在my.cnf修改为 max_connections=1000，然后重启mysql服务。  

###客户端  

但是在更多的情况下，线上服务的mysql是不能重启，这时候，可以通过客户端来修改。  

    > show variables like '%max_connections%'  --查看
    > set GLOBAL max_connections=1000 -- 修改
    
## 修改连接超时时间  

可以增加最大连接数，到mysql后台查看进程数 `show processlist`，发现有依然保持有比较多的连接，而这些连接当前都是`SLEEP`状态。
在说明一个问题，有比较多的连接都已经不再使用了，在与mysql的连接还一直保留着，基于这样情况，就有必要调短些mysql的连接超时时间。  

###配置文件   

my.cnf中修改配置，然后重启mysql。默认的时间是28800（8小时，前面单位是分钟）

    wait_timeout=600
    interactive_timeout=600
    
###客户端

    > show variables like '%timeout%';   
    > set global wait_timeout=600;
    > set global interactive_timeout=600;

*注意：* 要同时修改wait_timeout和interactive_timeout，不然wait_timeout会被interactive_time覆盖


## ibdata文件过大

ibdata1文件存放的是数据文件而不是日志文件等，如果直接删除，数据也就丢失了。解决方法：数据文件单独存放(共享表空间如何改为每个表独立的表空间文件)。
1. 备份数据库
$ mysqldump -q -umysql -ppassword --all-databases > bak.sql

2. 修改配置文件

    cat my.cnf
    [mysqld]
    innodb_file_per_table=1   # 添加
    
    
3. 关闭 mysql
  
   $ sudo serive mysql stop
   
4. 删除文件
  
   $ rm ibdata1 ib_logfile*

5. 重启mysql
  
   $ sudo service mysql start   
   
6. 恢复数据  

    $ mysql -uusername -pyourpassword < bak.sql

## 
