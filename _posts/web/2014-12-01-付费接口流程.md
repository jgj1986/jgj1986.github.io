---
title: 付费接口流程
date: 2014-12-01 15:12:28 +0800
tags: web
- a
- b
---

* toc 
{:toc}

>需要实现一个功能接口，调用银联或者支付宝等来给自己的服务充值。只要牵扯到钱，对安全性、一致性就要有比较苛刻的要求了，那付费接口的流程又应该是什么样子的呢？


###要求

1. 付费过程即使被别人截获，也不能有什么损失，这个过程就需要加密。能正确的调用到支付服务商（银联、支付宝）后，就由服务商来保证安全

2. 在没有收到支付服务商告知付费成功之前，我们就认为付费没有成功；而在收到通知之后，我方应该给服务商反馈，告知已经收到。而服务商为保证成功支付这个事件能通知到我们，也需要我方的一个反馈，没有没有收到这个反馈，会尝试多发几次

3. 因为一些网络延迟等，所以我方可能会收到多条支付成功的通知，对此，我方就需要能做好去重


###流程

有些以上的想法，大体就可以整理出付费接口的一个流程。参考 Agent`K 的 [手机网游开发指南-付费接口](http://www.cnblogs.com/agent-k/archive/2012/08/13/2636185.html){:target="_blank"}，虽然是移动终端的付费，但可以管中窥豹，确切的知道流程

1. 向支付提供商发起充值请求。

    如果是手机端的，请求可能要先得到用户的账号和密码；但大部分是直接访问api，进入到提供商自己的界面上。
  
    这种请求有指定API，一般为发起http请求，post方式发送指定格式的数据。出于安全考虑，这些数据需要进行加密、签名，支付商会提供一些编号、密钥之类的信息，并要求在加密、签名过程中使用。请求返回结果称为“充值申请”结果，并不是最终的充值结果。
  
2. 等待充值提供商的通知。

   通知方式为，回调我方指定的http地址（可能会被要求必须是80端口）。这个地址可以在提供商的后台指定，也可以在发起充值请求的参数中指定（个人认为，大多数的应该是在参数中指定回调地址）。
   
4. 收到通知后续操作

    进行解密、签名验证以及其他后续操作，最后按指定格式响应接收通知成功或失败。
    
    注意，可能需要做相应的去重处理。

###自身情况

系统先实现简单功能，先没有直接充值，计划先用金币来代替：当某项服务或模块需要付费时扣除金币即可，当金币不足时，再由充值系统来购买金币。
在这样一个系统中，各个模块和金币系统都在同一个网络或同一机器上，且消费金币只是简单的修改数据库，所以就没有必要在通过回调等机制来实现！

