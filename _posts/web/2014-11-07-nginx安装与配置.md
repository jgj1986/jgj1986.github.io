---
title: nginx install and config
date: 2014-11-07 19:12:28 +0800
tags: web 
- a
- b
---

* toc 
{:toc}


> [nginx](http://nginx.org/){:"target"="_blank"}也火了很久了，最近因为实际的需求，要使用nginx，也就好好的了解下。  


##安装  

总的来说，安装还是比较简单的  

    $ wget http://nginx.org/download/nginx-1.6.2.tar.gz
    $ tar zxf nginx-1.6.2.tar.gz && cd nginx-1.6.2
    # ./configure && make && make install 

或者只用用Linux发行版提供的软件包安装即可  
    
    $ audo aptitude install nginx
        
但是默认的nginx会少一些库，比如我们想将和lua结合使用，默认情况可能下就没有。为此，我们在编译的时候使用 --add-module 的参数来添加我们需要的这些模块。
比较详细的说明，nginx的[wiki](http://wiki.nginx.org/Modules){:"target"="_blank"}上有对所有模块的说明。这里只是我只是列出来，我需要的几个模块。
在一个新安装的ubuntu系统上可能缺少一些文件包，这里也一并列出:  

    $ sudo install lua5.1 liblua5.1-dev  liblua5.1-socket2 liblua5.1-json
    $ sudo aptitude install libpcre++-dev libpcre++0
    $ sudo aptitude install libcurl-ssl-dev libssl-dev  libssl1.0.0
    $ sudo aptitude install zip libzip-dev
    $ ./configure --prefix=/opt/nginx --add-module=/home/work/nginx/lua-nginx-module-0.9.8 --with-http_ssl_module --with-http_addition_module --add-module=/home/work/nginx/ngx_devel_kit-0.2.19 --add-module=/home/work/nginx/redis2-nginx-module-0.11 --add-module=/home/work/nginx/set-misc-nginx-module-0.26
    # make && make install

想用lua访问redis，还需要lua正对redis的插件，参考nginx的[wiki](http://wiki.nginx.org/LuaRedisParser){:"target"="_blank"}。这个过程简略如下：  

    $ cd lua-redis-parser-0.10
    $ export LUA_INCLUDE_DIR=/usr/include/lua5.1
    $ make CC=gcc
    $ sudo make install CC=gcc

这样所需要的安装过程就完成了，剩下的就是配置方面的事情了。在做配置前，我们可以先用nginx默认的配置文件启动服务感受下：  

    $ cd /opt/nginx
    $ sudo ./sbin/nginx -c /opt/install/conf/nginx.conf

当配置文件更新后，想让配置文件生效，则重新做加载配置文件：  

    $ sudo ./sbin/nginx -s reload  

执行 `-s reload` 后，没有提示错误信息，但是修改的内容不生效，这时候看下nginx的error日志能看到出错的地方。  

这样安装需要在编译时就指定好要使用什么模块，以后需要添加的模块或lua库也可以通过 `lua_package_path "/path/to/*.lua;;";`的方式使用。
可以参考[nginx与lua安装教程](http://blog.kissdata.com/2014/11/14/nginx-lua-install.html){:target="_blank"}。

##配置  

###配置文件说明    

刚安装好的服务也会提供一份简单的配置文件，nginx.conf。此处先记录下对配置文件的一些认识：  

* 通大多数的配置问价一样，也是 以"#" 来做注释的 
* 自己用到的配置文件提供events与http，样例中有关于mail等的配置，目前没有用到 
* 在http中提供server，server中配置域名等信息，通过这个域名（dns或hosts识别）即可访问这个server所提供的服务 
* http中配置反向映射，负载均衡等。关于nginx和lvs负载均衡，应在出篇博客 
* 配置文件可以拆成多个文件，用 include /path/to/*.conf 引用即可 

更加详细的信息，网上有很多，这里列上[一](http://www.cnblogs.com/xiaogangqq123/archive/2011/03/02/1969006.html){:"target"="_blank"}、
[两](http://kingj.iteye.com/blog/1420187){:"target"="_blank"}个，如果将来需要去上查看，就不在浪费篇章。
官网[wiki](http://wiki.nginx.org/Configuration){:"target"="_blank"}上有更加详细的说明。  


###与lua结合 

先提供一个简单配置:  

    user www-data;
    worker_processes  1;
    events {
        worker_connections  1024;
    }
    http {
      include       mime.types;
        default_type  application/octet-stream;
        keepalive_timeout  65;
        server {
        listen       80;
            server_name  test.fengzi.com;

            root /data/html/test;
            index  index.html index.htm;

            location /lua {
            content_by_lua_file /data/nginx_lua_files/lua.lua;
            }
        }
    }

    cat lua.lua
    #!/usr/bin/env lua
    ngx.header.content_type = "text/html; charset=utf8"
    ngx.print("hello fengzi")
    ngx.say("fengzi say hello ")  
    
在/etc/hosts中配置好 127.0.0.1   test.fengzi.com，则就可以在浏览器中访问 test.fengzi.com/lua 了。  

###初始化   

    http{
        ...
        init_by_lua_file /home/work/web/access_init.lua;
        lua_shared_dict access_add_1_dict 1M;
        ...
    }


第一个是用lua文件中代码做初始化，第二个是设置一个变量。这个两处设置都是设置为全局的变量，常驻内存，可在lua代码中直接使用 :) 。 详细信息请参考博客：[ngx_lua模块中的共享内存字典项API](http://blog.csdn.net/weiyuefei/article/details/38487475){:target="_blank"} 。 


###修改不重启生效

    location = /test {
        lua_code_cache off;
        ... ...
    }
                            
这个会影响nginx的性能，但是在开发机上如此配置，可以提高开发效率。如果添加或修改了一些.so之类的库文件还是要重启的

###nginx负载均衡

此处提供个简单配置例子：  

    http {
     ...
        upstream webservers {
            server 192.168.1.201 weight=1 max_fails=2 fail_timeout=2;
            server 192.168.1.202 weight=1 max_fails=2 fail_timeout=2;
            #server 127.0.0.1:8080 backup;
        }
        server {
            listen       80;
            server_name  localhost;
            #charset koi8-r;
            #access_log  logs/host.access.log  main;
            location / {
                proxy_pass      http://webservers;
                proxy_set_header  X-Real-IP  $remote_addr;
            }
        }
    }
  
陈明乾在其博客 [Nginx 反向代理、负载均衡、页面缓存、URL重写及读写分离详解](http://freeloda.blog.51cto.com/2033581/1288553){:"target":"_blank"}中以实践的形式给出的详细的说明，解释。可多看几次  
    
###nginx备份   
nginx和Keepalive可以实现双机热备份，现在还都是在测试环境下，还没有做实践，先记录着，以后配置时有什么问题再记录。查阅到两篇博客
[nginx+keepalived实现双机热备的高可用](https://www.centos.bz/2012/02/nginx-keepalived-high-availability/){:target="_blank"}，
[nginx主主集群](http://www.2cto.com/os/201109/106387.html){:target="_blank"} 。
前一篇博客是创建一个双机热备份的过程，介绍的比较详细，后一篇则是，让nginx 的master-backup也做到负载均衡。对两篇文章的说明实现 。




