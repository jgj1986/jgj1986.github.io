---
title:  自建ssl
date: 2015-11-17 17:12:28 +0800
tags:  运维 
- a
- b
---

* toc
{:toc}

## 缘起

mqtt中基于安全的考虑，计划使用ssl，在[paho的python手册](https://pypi.python.org/pypi/paho-mqtt){:target="_blank"}中看到，需要提供TLS的配置参数，即

    dict = {'ca_certs':"<ca_certs>",'certfile':"<certfile>",'keyfile':"<keyfile>",'tls_version':"<tls_version>",'ciphers':"<ciphers">}

基于这样情况，需要提供ca证书，cert文件，key文件。   

## 概念

SSL是在客户端和服务器之间建立一条SSL安全通道的安全协议，而OpenSSL是TLS/SSL协议的开源实现，提供开发库和命令行程序。常说的HTTPS是HTTP的加密版，底层使用的加密协议是SSL。

而为了使用TLS/SSL协议，服务端配置时指定 server.crt　和 server.key 两份文件，客户端使用 ca.crt证书文件。

## 生成

该过程中可以理解为先创建ca.crt证书，然后生成生成server端的key和csr(证书请求文件)，使用这些文件生成server的crt文件。参考[Howto: Make Your Own Cert With OpenSSL](http://blog.didierstevens.com/2008/12/30/howto-make-your-own-cert-with-openssl/){:target="_blank"}，具体每步的含义或者扩充的参数，可以参考[用openssl生成SSL使用的私钥和证书，并自己做CA签名](http://www.myhack58.com/Article/60/63/2013/41328.htm){:target="_blank"}。

在完成本文之后，发现生成自签名的ssl证书，可以不用创建ca的证书。详情参考[How to create a self-signed SSL Certificate ...](http://www.akadia.com/services/ssh_test_certificate.html){:target="_blank"}。

### 创建证书

    $ openssl genrsa -out ca.key 2048
    $ openssl req -new -x509 -days 3650 -key ca.key -out ca.crt
    # 此过程会输入很多信息，如国家、省市、单位等

### 生成证书请求文件

    $ openssl genrsa -out server.key 2048 
    $ openssl req -new -key server.key -out server.csr
    # 此处直接使用上面的ca.key文件应该也可以

### 使用ca生成证书

    $ openssl x509 -req -days 3650 -in server.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out server.crt


## 使用

### https中使用

可在nginx中配置https，也就是在nginx的配置中使用如下方式

    server
    {
        listen 443;
        ssl on;
        ssl_certificate /path/to/server.crt;
        ssl_certificate_key /path/to/server.key;
    ...
    }

    # 请求方式，-k可以只做加密不做验证
    $ curl -X xx -k "https://xxxx"

nginx客户端权限验证，参考[此文](http://nategood.com/client-side-certificate-authentication-in-ngi){:target="_blank"}。

### mqtt

请参考[mqtt中使用ssl](http://blog.woshifengzi.com/2015/11/17/mqtt%E4%B8%AD%E4%BD%BF%E7%94%A8ssl.html){:target="_blank"}
 
