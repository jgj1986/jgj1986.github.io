---
title:  heka学习
date: 2014-12-09 14:12:28 +0800
tags: go
- a
- b
---

* toc 
{:toc}

>统计分析时，难免有实时统计、以及日志的转移分发，crontab、scp等可以实现该功能，但是难免显得粗糙且维护比较复杂，而 Heka 可胜任此工作。当然，Heka不只是如此简单的功能。

##简介

Heka是一款拥有数据收集、分析、监视和报表的工具，Mozilla Service团队提供的开源项目，截止到现在，版本已经到 0.9.0。
[Heka的官方文档](https://hekad.readthedocs.org/en/latest){:target="_blank"}有详细和权威的说明，本篇只是记录下使用过程中，觉得有所帮助的东西，能更加快速的认识Heka。

###描述
Heka使用Go语言编写，内部对数据的过滤、转发等，都是采用指针形式，可支撑 10Gb/s 的消息数据（网上说法，自己没有实际测过！）。
目前heka可以支持多种格式的消息，官网上介绍的有：

    AMQP
    Docker
    FilePolling
    Http
    HttpListen
    Kafka
    Logstreamer
    Process
    ProcessDirectory
    StatAccum
    Statsd
    Tcp
    Udp
    
对于这些格式的消息，官方提供的处理方式可满足大部分的需求；若不满足需求，可以自行扩展或开发插件。关于插件的开发流程在下面章节介绍。  
Heka配置文件采用 [.toml 格式](https://github.com/toml-lang/toml){:target="_blank"}。

###架构

一般而言Heka中的数据流要经过5个过程，即

    Inputs
    Decoders
    Filters
    Encoders
    Outputs
    
从这几步的命名中，可以大体知道每步实现的功能。当然这5步不是必须都要有的，如果接受到的数据，没有加密或其他特殊格式，可以直接处理，那Decoders就不需要。
甚至，不想输出任何东西，不提供Outputs都可以，但是这样一来就没有了实际意义。  
PS：在Hekad实际处理时，当数据处理完成之后，要执行类似 `pack.Recycle()` 的操作，来释放所持有的空间，做资源的循环再利用。

##安装

安装编译heka环境的过程还算比较简单，但是要下载一些网络库，这个过程需要翻墙，是个比较**烦心**的事。  
本文使用 [goagent](https://github.com/goagent/goagent){:target="_blank"}翻墙，代理为 127.0.0.1:8087

###安装Heka环境
    
    $ export http_proxy="http://127.0.0.1:8087"
    $ git clone https://github.com/mozilla-services/heka
    $ cd heka
    $ source build.sh  #这个过程会下载一些依赖库，并生成build目录
  
    $ ctest && make ctest  # 做编译测试
    
###添加插件 
  
Heka中真正强大的一点也就在于能通过插件扩展功能，支持各种需求。本篇不介绍插件如何实现，以及插件中的代码结构等问题，因为目前了解的还不够深，介绍的可能也会有偏差，只是介绍下插件如何编译与生效。 

假设我们要实现一个 hello_world 的插件，将插件的代码放在 `heka/externals/hello_world`目录下。有了这样的一个目录，我们在配置文件中指明。配置文件是cmake目录下 `plugin_loader.cmake`，
刚clone下来的heka，没有这个配置文件，手工创建一个。
    
    $ cat cmake/plugin_loader.cmake
    add_external_plugin(svn https://url_to/heka_plugins/hello_world:local)
    
说明，heka的插件会先在本地找插件，如果没有，则根据url的地址去下载；url来源可以是git、svn或hg。  
完成插件的开发，并做好配置之后，就可以重新编译可执行文件

    $ cd heka
    $ source build.sh
    $ cpack

这样，在build目录下，就会有编译好的支持新插件的可执行文件。 

  
##使用

上面编译好的build目录下，有压缩打包文件 `heka-0_9_0-linux-amd64.tar.gz`，里面即包含有运行所需要的二进制文件。
运行Heka时，需要提供配置文件，假设目录为 `conf/hekad.toml`。

###配置heka
heka的配置文件要设置好所需要的 Input/Decoder/Filter/Encoder/Output，（没有用的可以不配置），也提供整个heka所需要的全局的配置，此处提供一个简单的配置如下：

    [hekad]
    cpuprof = "log/cpuprof.log"    #
    memprof = "log/memprof.log"    # heka运行时cpu、mem出错的日志
    maxprocs = 24
    base_dir = "base_dir"
    pid_file = "hekad.pid"

    [LogstreamerInput]
    log_directory = "/opt/nginx/logs"  # 指定input的来源，使用的是 LogstreamerInput 类型的插件
    file_match = 'access\.log'         # 文件，注意，此处使用的是单引号

    [PayloadEncoder]
    append_newlines = false

    [LogOutput]
    message_matcher = "TRUE"
    encoder = "PayloadEncoder"

可用`message_matcher`来设定各种的匹配规则，个人理解，他可以实现Filter的功能，而因为功能比较简单，就合并到Output中了。
更多的配置参考 [Configuring hekad](https://hekad.readthedocs.org/en/latest/config/index.html){:target="_blank"}。

###运行

提供配置所需要的目录，如log，base_dir, 使用命令启动
    
    ./bin/hekad -config=./conf/hekad.toml
    
如果是使用上面的配置，heka会将 `/opt/nginx/logs/access.log` 在屏幕中输出，并且，每当access.log中增加一行，屏幕就会实时输出这么一行！

Heka中有提供了其他的数据流处理，可以多尝试使用。:)

