---
title:  Heka插件的开发笔记
date: 2014-12-26 18:12:28 +0800
tags: go
- a
- b
---

* toc 
{:toc}

##背景

Push 想实现精准推送的功能，这就需要统计的数据来实现。而之前的日志格式和统一后的日志格式不兼容，为此做一个格式转化功能：将Json格式转为 `^B` 分隔的日志。 
在转的过程中，Heka与Redis结合，实现实时统计的功能，并将转化好之后的日志落地。  
本文中的插件的开发使用go语言。

##基本规则

实现一个插件，首先是一些基本的初始化操作，再有需要实现几个基本的接口，即配置方面操作和注册操作。

###初始化操作
Heka插件接口定义了初始化的操作，如下：

    type Plugin interface {
        Init(config interface{}) error
    }
    
例如一个最简单的例子，我们实现一个 `SimpleOutput` 的插件，初始化时，不需要做任何工作，则可以如下：
    
    type SimpleOutput struct {
    }
    
    func (this *Push2KpOutput) Init(config interface{}) (err error) {
        return
    }

###关于配置

从[官网文档](https://hekad.readthedocs.org/en/latest/developing/plugin.html){:target="_blank"} 的 Custom Plugin Config Structs 知道，
`HasConfigStruct`接口只有 `ConfigStruct` 的方法。假设一个简单的插件，不需要指定任何的配置，则如下

    type SimpleOutputConfig struct {
    }
    
    func (this *SimpleOutput) ConfigStruct() interface{} {
        return &SimpleOutputConfig{}
    }

###注册
关于功能实现的部分后面在作介绍。在使用该插件前还有步重要的操作，即注册该插件。开始没有注册时，曾遇到提示

    No registered plugin type: SimpleOutput

而注册插件只需要调用RegisterPlugin方法即可，官网也推荐在init函数中实现，即如下：

    func init() {
        RegisterPlugin("SimpleOutput", func() interface{} {
            return new(SimpleOutput)
        })
    }

###补充

此处说明的是对插件的开发中的一些过程，[Heka使用学习](http://blog.woshifengzi.com/2014/12/09/Heka%E4%BD%BF%E7%94%A8%E5%AD%A6%E4%B9%A0.html)中的 `添加插件`部分的说明，更应该最开始的第一步操作。  

    $ cmake/plugin_loader.cmake
    add_external_plugin(svn https://url_to/heka_plugins/simple:local)
    
    $ ls externals/simple/simple_output.go
    
要新增加的插件在配置的目录下。

测试时还有一点浪费了一些时间，即配置文件中output的MessageMatcher先设成TRUE，让第一步的测试能看到结果，

    [Simple_output]
    type = "SimpleOutput"
    message_matcher = "TRUE"
    
    


##功能实现部分待续
