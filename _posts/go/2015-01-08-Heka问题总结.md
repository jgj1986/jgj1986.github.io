---
title:  Heka问题总结
date: 2015-01-08 15:12:28 +0800
tags: go
- a
- b
---

* toc 
{:toc}

> Heka在使用的过程零星的遇到些问题，在此处记录下来，以后再有问题也会逐步添加

###100 packs have been idle more than 120 seconds

同样的程序和配置，在另外三台上运行都很正常，而在其中的一台上运行就有如下的问题：

    Diagnostics: 100 packs have been idle more than 120 seconds.
    Diagnostics: (input) Plugin names and quantities found on idle packs:
    Diagnostics:       xxxx: 100
    
搜到 [heka-1228](https://github.com/mozilla-services/heka/issues/1228){:target="_blank"}，
说有死锁，可通过修改 `plugin_chansize` 或  `maxprocs` 配置来调整，试了下不成功。  
[heka error with Diagnostics](https://mail.mozilla.org/pipermail/heka/2014-January/000058.html){:target="_blank"}中说到:
input 中的 idle packs 绝大多数是output中缺少 `Recycle()` 导致的。

重新检查output插件的代码，发现有个地方少用了，添加上之后，ok了！

    err = json.Unmarshal([]byte(*pack.Message.Payload), &pushMessage)
    if err != nil {
        pack.Recycle()  // 此处缺少！！
        continue
    }  
    ...
    err = json.Unmarshal([]byte(*pack.Message.Payload), &pushMessage3)
    pack.Recycle()
    ...
    
