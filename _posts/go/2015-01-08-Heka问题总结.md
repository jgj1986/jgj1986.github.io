---
title:  Heka问题总结
date: 2015-01-08 15:12:28 +0800
tags: go
- a
- b
---

* toc 
{:toc}

> Heka在使用的过程零星的遇到些问题，在此处记录下来，以后再有问题也会逐步添加

### heka 插件问题定位

在Heka插件运行时，遇到错误多会就直接退出，并输出很多的错误信息，而这些错误信息很有帮助，几乎可以直接定位到时哪行出现的问题

    panic: runtime error: invalid memory address or nil pointer dereference
    [signal 0xb code=0x1 addr=0x0 pc=0x5602ca]

    goroutine 16 [running]:
    runtime.panic(0xb78b00, 0x120fa53)
    /usr/local/go/src/pkg/runtime/panic.c:279 +0xf5
    git.hub.net/xxxx/heka_plugins/mjhbase.(*RealHbasePushOutput).testThriftConnection(0xc208029500, 0x0, 0x0)
    /home/work/heka/build/heka/src/git.hub.net/vincentzhwg/heka_plugins/mjhbase/real_hbase_push_output.go:479 +0x2fa
    git.hub.net/xxxx/heka_plugins/mjhbase.(*RealHbasePushOutput).Init(0xc208029500, 0x9d2420, 0xc2080cc840, 0x0, 0x0)
    /home/work/heka/build/heka/src/git.hub.net/vincentzhwg/heka_plugins/mjhbase/real_hbase_push_output.go:509 +0x13f
    ...

已经有很明显的提示，real_hbase_push_output.go 的 479行有错误，有个变量未初始化，于是定位到问题这行

    c, err = redis.Dial("tcp", mj.RedisServer)
            
仔细翻阅代码，原来是拼写错误，应该是

    c, err = redis.Dial("tcp", mj.redisServer)      
    


###100 packs have been idle more than 120 seconds

同样的程序和配置，在另外三台上运行都很正常，而在其中的一台上运行就有如下的问题：

    Diagnostics: 100 packs have been idle more than 120 seconds.
    Diagnostics: (input) Plugin names and quantities found on idle packs:
    Diagnostics:       xxxx: 100
    
搜到 [heka-1228](https://github.com/mozilla-services/heka/issues/1228){:target="_blank"}，
说有死锁，可通过修改 `plugin_chansize` 或  `maxprocs` 配置来调整，试了下不成功。  
[heka error with Diagnostics](https://mail.mozilla.org/pipermail/heka/2014-January/000058.html){:target="_blank"}中说到:
input 中的 idle packs 绝大多数是output中缺少 `Recycle()` 导致的。

重新检查output插件的代码，发现有个地方少用了，添加上之后，ok了！

    err = json.Unmarshal([]byte(*pack.Message.Payload), &pushMessage)
    if err != nil {
        pack.Recycle()  // 此处缺少！！
        continue
    }  
    ...
    err = json.Unmarshal([]byte(*pack.Message.Payload), &pushMessage3)
    pack.Recycle()
    ...

需要注意下，有个地方不需要执行pack.Recycle()

    select {
    case pack, ok = <-inChan:
    if !ok {
        // pack.Recycle()  // !!! not need REcycle here!
        break
    }   


补充  
最近也遇到一个类似的情景，停止的原因不是缺少 output 中一些地方少了 `pack.Recycle()`。
仔细看日志，能看到 output 插件的进程已经停止了，原来是有这样的一个bug：
    
    ok := true
    for ok {
        select {
        case pack, ok = <-inChan:
            if !ok {
                break
            }   
            ...
            if appid, ok = appdict[id]; ok {
            ...

在循环里面有别的判断条件使用也使用了 `ok` 变量，结果可想而知，当里面 ok 为false了，到了for循环处就退出了。   


### 非法宕机

一次机器被运维误关机，heka在启动时出错：

    Plugin 'log_tcp_output' error: StreamOutput stopped: can't get record: can't unmarshal record: proto: wrong 
    Plugin 'log_tcp_output' error: can't get record: can't unmarshal record: proto: wrong wireType = 4 for field Payload
    Plugin 'log_tcp_output': stopped
    Plugin 'log_tcp_output': has stopped, shutting down.

开始以为是 proto 不支持的问题，多次尝试后，原来是heka非法退出，base_dir/output中的一些偏移发生错误。
将base_dir/output中的文件给修复，就好了。
 
