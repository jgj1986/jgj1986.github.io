---
title:  go语言问题总结
date: 2015-01-07 10:12:28 +0800
tags: go
- a
- b
---

* toc 
{:toc}

###panic: runtime error: index out of range

在用heka操作redis的时候，报这样的错误：

    panic: runtime error: index out of range

    goroutine 48 [running]:
    runtime.panic(0xae42e0, 0x11284fc)
        /usr/local/go/src/pkg/runtime/panic.c:279 +0xf5
    git.hub.net/xxx/heka_plugins/kptj.(*KptjHistoryRedisOutput).Run(0xc2080be600, 0x7f43e5600840, 0xc2080ec000, 0x7f43e56008f8, 0xc20807a000, 0x0, 0x0)
        /home/work/heka/build/heka/src/git.hub.net/vincentzhwg/heka_plugins/kptj/history_redis_output.go:178 +0x1b0c
    github.com/mozilla-services/heka/pipeline.(*foRunner).Starter(0xc2080ec000, 0x7f43e56008f8, 0xc20807a000, 0xc2080f02c0)
        /home/work/heka/build/heka/src/github.com/mozilla-services/heka/pipeline/plugin_runners.go:631 +0x73e
    created by github.com/mozilla-services/heka/pipeline.(*foRunner).Start
        /home/work/heka/build/heka/src/github.com/mozilla-services/heka/pipeline/plugin_runners.go:530 +0x543

    goroutine 16 [chan receive]:
    github.com/mozilla-services/heka/pipeline.Run(0xc20807a000)
        /home/work/heka/build/heka/src/github.com/mozilla-services/heka/pipeline/pipeline_runner.go:268 +0x1007
    main.main()
        /home/work/heka/build/heka/src/github.com/mozilla-services/heka/cmd/hekad/main.go:190 +0xf64

在网上看到： [Go语言中的数组（array）和数组切片（slice）](http://www.cnblogs.com/ghj1976/archive/2013/02/17/2914646.html){:target="_blank"}，主要是使用数组或数组切片越界导致的。
查看自己的代码，将使用切片的地方都加上判断，发现可以了。最后的问题定位在这样的一段代码处：

    conn := this.RedisPool.Get()
    strs, err := redis.Strings(conn.Do("KEYS", keyPre))
    conn.Close()

    if err != nil {
        fmt.Println("collate err:", err)
    } else {
        for _, s := range strs {
        ...
    }
    
如果是redis中的key为空，err未必就非nil，于是加上对strs长度的判断，即
    
        ...
        if err != nil || len(strs) <= 0{
            ...
        } else {
            ..
        }

问题得到解决。这个过程可以知道两点：
* go 代码的 index out of range 错误，很可能是数组或切片的越界访问导致的
* 与redis、mysql、mongodb操作的返回时，不能简单的通过返回err是否为nil来判断！
