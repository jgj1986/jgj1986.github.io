---
title:  mqtt的使用
date: 2015-11-12 10:12:28 +0800
tags: tools
- a
- b
---

* toc
{:toc}

> mqtt隐然有成为物联网标准协议的趋势，计划使用mqtt做一些简单的测试。

## 简单测试

关于mqtt标准是怎么一回事，此处就不在赘述了。只是说一下个人理解，她只是个协议的标准，目前有比较多的实现版本。个人了解到的服务端实现起来比较困难，而客户端(client)则相对容易一些。

[NodeMCU使用mqtt](http://www.allaboutcircuits.com/projects/introduction-to-the-mqtt-protocol-on-nodemcu/){:target="_blank"} 一文中，使用了介绍了使用使用开源的mqtt项目[mosquitto](http://mosquitto.org/){:target="_blank"}做服务端，最近

自己在阅读 [emqttd](https://github.com/emqtt/emqttd){:target="_blank"}的一些源代码。做了如下一个测试，服务端用emqttd，客户端分别用 [emqttc](https://github.com/emqtt/emqttc){:target="_blank"}和[Paho Python Client]

(https://www.eclipse.org/paho/clients/python/)做客户端。

使用emqttc中的simple_example.erl 和 Paho 示例的sub.py，修改其中的服务端，并且将Topic都改为 "TopicA"

    $ ./sub.py
    TopicA 0 hello

    $ erl -pz /path/to/emqttc/ebin -pz /path/to/emqttc/deps/gen_logger/ebin
    > c(simple_example).
    > simple_example:start().

## NodeMcu 使用 emqtt

copy了[NodeMCU使用mqtt](http://www.allaboutcircuits.com/projects/introduction-to-the-mqtt-protocol-on-nodemcu/){:target="_blank"} 中的一些代码做测试，能验证整个服务可以打通。此处列出相关代码，应该没有版权纠纷吧 :-) 

mqtt.lua

    m_dis = {}
    MQTT_CLIENTID = "esp-blinkenlite"
    MQTT_HOST = "EMQTTD host"
    MQTT_PORT = 1883

    function animate(m, pl)
        m:publish("/mcu/status", "--> ANIMATE COMMAND", 0, 0,
            function(m) print("ANIMATE COMMAND") end)
    
        if pl == "0" then
            m:publish("/mcu/status", "--> LED OFF", 0, 0,
                function(m) print("LED OFF") end)
            tmr.stop(1)

        elseif pl == "1" then
            m:publish("/mcu/status", "--> R-G-B Mode", 0, 0,
                function(m) print("RGB Mode") end)
            tmr.stop(1)
        
        elseif pl == "2" then
            m:publish("/mcu/status", "--> Random-Breathe Mode", 0, 0,
                function(m) print("Random-Breathe Mode") end)    
            tmr.stop(1)
        
        elseif pl == "3" then
            m:publish("/mcu/status", "--> Disco Mode", 0, 0,
                function(m) print("Disco Mode") end) 
            tmr.stop(1)
        
        else
            m:publish("/mcu/status", "--> Error: Unknown Command", 0, 0,
                function(m) print("ERROR: UNKNOWN COMMAND") end)
        end
    end


    m_dis["/mcu/cmd/animate"] = animate

    m = mqtt.Client(MQTT_CLIENTID, 60, "", "") -- Living dangerously. No password!

    m:on("connect", function(m) 
            print ("\n\n", MQTT_CLIENTID, " connected to MQTT host ", MQTT_HOST,
            " on port ", MQTT_PORT, "\n\n")
            m:subscribe("/mcu/cmd/#", 0,
            function(m) print("Subscribed to CMD Topic") end)
        end)


    m:on("offline", function(m)
            print ("\n\nDisconnected from broker")
            print("Heap: ", node.heap())
        end)


    m:on("message", function(m,t,pl)
        print("PAYLOAD: ", pl)
        print("TOPIC: ", t)
    
        if pl~=nil and m_dis[t] then
            m_dis[t](m,pl)
        end
    end)

    m:connect(MQTT_HOST, MQTT_PORT, 0, 1)


init.lua


    wifi.setmode(wifi.STATION)
    wifi.sta.config("Baidu2728","12345678")
    ip, nm, gw = wifi.sta.getip()

    local wifi_counter = 0

    tmr.alarm(0, 1000, 1, function()
        if wifi.sta.getip() == nil then
            print("Connecting to AP...\n")

            -- Rotate through RGB colors while waiting
            wifi_counter = wifi_counter + 1;
        else
            ip, nm, gw = wifi.sta.getip()
    
            -- Debug info
            print("\n\nIP Info: \nIP Address: ",ip)
            print("Netmask: ",nm)
            print("Gateway Addr: ",gw,'\n')

            tmr.stop(0)     -- Stop the polling loop

            -- Continue to main function after network connection
            dofile("mqtt.lua")
        end
    end)


使用luatool工具将代码写入，并执行

    $sudo luatool -f mqtt.lua -t mqtt.lua -vr
    $sudo luatool -f init.lua -d -vr

这时候，就会等 /mcu/cmd/animate 这个topic的消息，

    publish.single("/mcu/cmd/animate", "1", hostname="EMQTTD host")

nodemcu收到消息后，会向/mcu/status 发布消息，如果订阅这个topic，就可以收到模拟的状态信息。



