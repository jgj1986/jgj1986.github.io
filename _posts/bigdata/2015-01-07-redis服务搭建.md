---
title:  redis服务搭建
date: 2015-01-07 17:12:28 +0800
tags: go
- a
- b
---

* toc 
{:toc}

如果只是简单的启动一个redis服务，直接使用redis-server命令就好了。这儿主要是想探讨下搭建可靠与安全的redis服务。
[More about Codis](http://blog.woshifengzi.com/2015/11/13/codis.html){:target="_blank"}

###redis集群
期待已久的redis 3.0 版本终于还是没有稳定版，但是已经有了 unstable 的分支可以搭建个集群使用。
[redis的官网文档 集群教程](http://redisdoc.com/topic/cluster-tutorial.htm){:target="_blank"} 比较详细的描述了配置和使用redis集群。 
关于配置redis集群可以简单的描述为如下：

设定配置文件(./redis.conf)，重点是允许使用集群 `cluster-enabled yes`
    
    port 7000
    cluster-enabled yes
    cluster-config-file nodes.conf
    cluster-node-timeout 5000
    appendonly yes

启动多个这个的节点，如端口依次是 7000,7001,7002
    
    /path/to/redis-server ./redis.conf
    
然后使用命令启动集群：

    ./redis-trib.rb create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002    

李万川在[摩羯wiki](wiki.mjyun.com/index.php/Redis){:target="_blank"}上有关于创建的介绍说明。当然更加详细的说明还是看看官网上的介绍！

但不管怎么说，这个版本还是unstable版本，不建议直接用在线上环境。
补充一点，这样的集群中其实也是两个节点之间有主、从关系。如果相应的主从都挂掉了，数据也就无法访问了。

###主从备份

不想memcache，redis本身就可以内容写回磁盘，通过好的配置，定期向磁盘写回数据，机器redis进程挂掉、服务器挂掉，重启后依然可以正常服务。  
但是如果磁盘也损坏了，或者对数据的要求很高，在重启服务这段时间不能访问会带来很严重的影响。这种情况下就可以采用主从备份。  
搭建过程参考[redis的复制](http://redisdoc.com/topic/replication.html){:target="_blank"}。

线上机器确实也搭建了主从服务，但是主服务一直没有宕掉过，也就没有机会体验下主从快速切换的惊心动魄。
但是有了主从之后，确实也带来了一个好处，就是对外部的一些服务查询，直接使用从服务器，减少了主服务的压力，不知道这样设计是否有不妥之处。

### Twemproxy

如果不只是简单的主从，又想使用redis的集群，而感觉unstable又不是那么放心，那么通过 Proxy 的方式来实现存储集群就是比较好的选择了，
常见即是twitter的[Twemproxy](https://github.com/twitter/twemproxy){:target="_blank"}。

twemproxy的安装过程不在介绍，可以参考[基于Twemproxy的Redis集群方案](http://www.cnblogs.com/haoxinyue/p/redis.html){:target="_blank"}。
    
    ./twemproxy -c twemproxy.xml -d -v 4 -s 51002 -p twemproxy.pid -o twemproxy.log
    
我们线上实现时，twemproxy只是做一个代理，请求key会根据hash分到不同的redis节点上，这样会带来一个问题：如果某个节点过了，在启动前，上面的数据也就访问不到了。  
关于其优缺点参考 [Redis 代理服务Twemproxy](http://blog.csdn.net/hguisu/article/details/9174459){:target="_blank"}

###访问权限

从安全角度来讲，redis不能知道端口就能访问，特别是有外网的情况，所以就要设置访问密码。只用是在配置文件中添加，如：

    requirepass "password"
    
还可以在redis的交互式命令行下添加，如
    
    > config set requirepass password   

