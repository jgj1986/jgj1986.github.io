<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="jgj" />
        <meta name="viewport" content="width=device-width" /> 
        <title>记录生活工作中的点滴 | 我是疯子</title>
        

        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- bootstrap source -->
        <!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <!-- 可选的Bootstrap主题文件（一般不用引入） -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
        <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
        <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
        <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
        <script src="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="/asset/css/kissdata.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <link href="/feed.html" rel="alternate" title="jgj" type="application/atom+xml" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="icon" href="/favicon.ico" />

        <style type="text/css">
            body {
                padding-top: 55px;
                padding-bottom: 30px;
                background-color: #EEE;
            }
        </style>

        <link rel="stylesheet" href="/asset/js/google-code-prettify/prettify.css">
        <script src="/asset/js/google-code-prettify/prettify.js"></script>

        <script type="text/javascript">
            $(document).ready(function () {

                // go to top
                var bt = $('#toolBackTop'); var sw = $(document.body)[0].clientWidth; var limitsw = (sw - 840) / 2 - 80; if (limitsw > 0){ limitsw = parseInt(limitsw); bt.css("right",limitsw); } $(window).scroll(function() { var st = $(window).scrollTop(); if(st > 30){ bt.show(); }else{ bt.hide(); } });

                // google-code-prettify
                $("pre").addClass("prettyprint linenums"); prettyPrint();

            })
        </script>

        <!-- kp747 
        
        -->
    </head>
    <body>
            <div id="header">
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand normal-a" href="javascript:void(0)" onclick="javascript:void(0)">
                    <span id="site_name">我是疯子</span>
                </a>
            </div>

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/categories.html">分类</a></li>
                    <li><a href="/guestbook.html">留言</a></li>
                    <li><a href="/about.html">关于</a></li>
                    <li><a href="/feed.html">RSS</a></li>
                    <li><a href="javascript:void(0)" class="normal-a" onclick="javascript:void(0)"><span id="site_description">在此停留片刻，偶有所得！</span></a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>


            <div class="container">
                <div class="row">
                    <div class="col-md-9" id="main-left">
                        <h1>记录生活工作中的点滴</h1>

<hr class="small-margin" />

<div>
    
    <div class="post-card">
        <div class="head"><a href="/2014/11/16/linux%E7%9F%A5%E8%AF%86%E7%82%B9%E6%B1%87%E6%80%BB.html"><span class="title">Linux知识点汇总</span></a><span class="date">2014-11-16</span></div>
        <div class="content"><ul id="markdown-toc">
  <li><a href="#md5">md5</a></li>
  <li><a href="#redis">redis乱码</a></li>
  <li><a href="#ssh">ssh免密码登录</a></li>
  <li><a href="#pythonhttp">python快速搭建http服务</a></li>
  <li><a href="#mysqlctrl-c">MySQL中的Ctrl C</a></li>
  <li><a href="#section">编码转义</a></li>
  <li><a href="#vim">vim特殊字符</a></li>
  <li><a href="#date">一些Date命令</a></li>
  <li><a href="#sort">sort</a></li>
  <li><a href="#linux">查看安装的linux发行版</a></li>
  <li><a href="#glibc">查看glibc版本</a></li>
  <li><a href="#tmux">tmux假死</a></li>
  <li><a href="#sort-1">sort</a></li>
  <li><a href="#grepawk">grep与awk结果不同</a></li>
  <li><a href="#ab">ab工具安装</a></li>
</ul>

<h3 id="md5">md5</h3>

<p>使用md5sum命令得到的md5，和用md5.lua得到的md5值不一样，如下：</p>

<pre><code>$ echo "hello" | md5sum
b1946ac92492d2347c6235b4d2611184  -
</code></pre>

<p>使用md5.lua进行测试</p>

<pre><code>$ lua
Lua 5.1.4  Copyright (C) 1994-2008 Lua.org, PUC-Rio
&gt; print(require("md5").sumhexa("hello"))
5d41402abc4b2a76b9719d911017c592    
</code></pre>

<p>这就比较奇怪了，md5加密的算法应该是为唯一的，怎么还会不一样呢？经过搜素，原来是echo中的回车导致的：</p>

<pre><code>$ echo -n "hello" | md5sum
5d41402abc4b2a76b9719d911017c592  -
</code></pre>

<h3 id="redis">redis乱码</h3>

<p>在redis 中存储中文，读取会出现乱码，如何在get时取到它的中文呢？只需要在redis-cli 后面加上 <code>--raw</code></p>

<pre><code>./redis-cli --raw
redis&gt; get test
"我们"
</code></pre>

<h3 id="ssh">ssh免密码登录</h3>

<p>第一创建时，将机器A的id_dsa.pub的内容，直接写到（比如用vim打开）机器B的authorized_keys中，及时将权限修改正确</p>

<pre><code>ls -l /home/work/.ssh
-rw-rw-r-- 1 work work  2379 May 26  2014 authorized_keys
-rw------- 1 work work   668 Dec 30  2013 id_dsa
-rw-r--r-- 1 work work   599 Dec 30  2013 id_dsa.pub
-rw-r--r-- 1 work work 20836 Nov 18 20:38 known_hosts
</code></pre>

<p>这个时候，也是往往不生效，而直接使用</p>

<pre><code>cat id_dsa.pub &gt; ~/.ssh/authorized_keys
</code></pre>

<p>则往往可以。</p>

<h3 id="pythonhttp">python快速搭建http服务</h3>

<p>在线上服务器拷贝文件的方法：
在服务器的相应文件目录下，用python开启一个服务</p>

<pre><code>python -m SimpleHTTPServer 8080  #(端口)
</code></pre>

<p>本地下载相应文件</p>

<pre><code>wget "http://ip:8088/filename"
</code></pre>

<h3 id="mysqlctrl-c">MySQL中的Ctrl C</h3>

<p>mysql中输入了一些命令后，发现有问题，或者这条命令不是我们想要的，直接 <code>Ctrl-C</code> ，就退出MySQL了。</p>

<p>可以用 <code>home</code>键 或 <code>Ctrl-a-a</code> 到命令行首，输入 <code>#</code> ，然后回车即可。</p>

<p>可以理解为注释掉这行，不让他执行了。</p>

<h3 id="section">编码转义</h3>

<pre><code>iconv -f gbk -t utf8 file &gt; new_file
</code></pre>

<h3 id="vim">vim特殊字符</h3>

<p>vim中有^M ^B ^A的形式，怎么样替换呢，或怎么样输入了</p>

<pre><code>:%s/^M/|/g，
</code></pre>

<p>其中输入是Ctrl-v Ctrl-m</p>

<h3 id="date">一些Date命令</h3>

<p>前一天
    # date –date=’1 days ago’ +%Y-%m-%d
    # date -d ‘1 days ago’ +%Y-%m-%d
    # date -d yesterday +%Y-%m-%d
    # date -d yesterday +%Y-%-m-%-d
明天
    # date –date=’1 days’ +%Y-%m-%d
    # date -d ‘1 days’ +%Y-%m-%d
    # date -d tomorrow +%Y-%m-%d</p>

<p>时间与时间戳</p>

<pre><code>date -d "2013-12-12 00:00:00" +%s
date -d @1386777600  "+%Y%m/%d"
date -d @1386777600  "+%Y-%m-%d %H:%M:%S"   
date --date='1 hour ago' +%Y%m%d%H%M
</code></pre>

<h3 id="sort">sort</h3>
<p>sort使用-t指定分隔符，默认的是’\t’和’ ‘，如果限制是’\t’的话，需要使用$符号，也就是</p>

<pre><code>sort -t $'\t'    
</code></pre>

<h3 id="linux">查看安装的linux发行版</h3>

<pre><code> cat /etc/issue
 lsb_release -a
 cat /proc/version
</code></pre>

<h3 id="glibc">查看glibc版本</h3>

<pre><code>  rpm -qi glibc
  ldd --version   
  /lib/libc.so.6
</code></pre>

<h3 id="tmux">tmux假死</h3>

<p>tmux是开发的利器。在实际使用过程中，遇到到假死的现象，即进去到某个session中，光标没有反应，但是可以正常的切换等。<br />
使用<code>Ctrl +  Q</code> 命令可以恢复。注意不是 ‘Ctrl-B + Q ‘</p>

<h3 id="sort-1">sort</h3>
<p>sort使用-t指定分隔符，默认的是’\t’和’ ‘，如果限制是’\t’的话，需要使用$符号，也就是 
    sort -t $’\t’ </p>

<h3 id="grepawk">grep与awk结果不同</h3>
<p>先看看几个命令统计的结果</p>

<pre><code>$ cat */* | awk -F'^B' '{if ($3="394428706") print $5}' |sort | uniq | wc -l
79489
$ cat */* |grep "394428706" |  awk -F'^B' '{print $5}' | sort | uniq | wc -l
2913
$ grep 394428706 */*  |  awk -F'^B' '{print $5}' | sort |uniq | wc -l
791
</code></pre>

<p>分析日志文件，看到里面有这样的内容：</p>

<pre><code>    ... ^B42218def915cbdb7^B^@^@:^@^@:^@^@:^@^@:^@^@:^@^@^B865163021157151^B^B^B1.2.0^B4^B^B    
</code></pre>

<p>后面在执行的时候就受到影响。为什么呢?</p>

<pre><code>man awk: 
awk cannot handle ascii NUL \0 in the source or data files
</code></pre>

<p>写段c代码可以看到 \0 的输出</p>

<pre><code>#include &lt;stdio.h&gt;
int main(int argc, char *argv[]) {
    printf("##%c###\n", '\0');
    return 0;
}
</code></pre>

<p>在vim中看到输出 ##^@###，这样awk处理时会就有问题！</p>

<h3 id="ab">ab工具安装</h3>
<p>ubuntu: aptitude install apache2-utils
centos: yum install httpd-tools.x86_64</p>

</div>
        <div class="more text-right"><a href="/2014/11/16/linux%E7%9F%A5%E8%AF%86%E7%82%B9%E6%B1%87%E6%80%BB.html">继续阅读全文</a></div>
    </div>
    
    <div class="post-card">
        <div class="head"><a href="/2014/11/12/shell%E6%93%8D%E4%BD%9Cmemcache.html"><span class="title">Shell操作memcache</span></a><span class="date">2014-11-12</span></div>
        <div class="content">
</div>
        <div class="more text-right"><a href="/2014/11/12/shell%E6%93%8D%E4%BD%9Cmemcache.html">继续阅读全文</a></div>
    </div>
    
    <div class="post-card">
        <div class="head"><a href="/2014/11/11/%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E4%B8%8E%E9%98%B2%E8%8C%83.html"><span class="title">网络攻击与防范</span></a><span class="date">2014-11-11</span></div>
        <div class="content"><p>网络安全</p>

<ul id="markdown-toc">
  <li><a href="#sql-">SQL 注入攻击</a>    <ul>
      <li><a href="#section">产生攻击的原因</a></li>
      <li><a href="#section-1">预防</a></li>
    </ul>
  </li>
  <li><a href="#section-2">跨站脚本攻击</a>    <ul>
      <li><a href="#section-3">原理</a></li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>公司要以网络形式提供一系列的对外接口，而这些接口难免会有网络安全的问题。此处列出一些常见的网络攻击方式，知道原理，在代码中就避免潜在的网络安全问题。</p>
</blockquote>

<h2 id="sql-">SQL 注入攻击</h2>

<h3 id="section">产生攻击的原因</h3>
<p>参考<a href="http://jingyan.baidu.com/article/37bce2becf7ae31002f3a293.html" target="_blank">SQL注入攻击的方法有哪些</a></p>

<p><strong>1. 没有正确过滤转义字符</strong></p>

<p>在用户的输入没有为转义字符过滤时，就会发生这种形式的注入式攻击，它会被传递给一个SQL语句。这样就会导致应用程序的终端用户对数据库上的语句实施操纵。比方说，下面的这行代码就会演示这种漏洞：</p>

<pre><code>statement := "SELECT* FROM users WHERE name = '" + userName + "';"
</code></pre>

<p>这种代码的设计目的是将一个特定的用户从其用户表中取出，但是，如果用户名被一个恶意的用户用一种特定的方式伪造，这个语句所执行的操作可能就不仅仅是代码的作者所期望的那样了。例如，将用户名变量(即username)设置为：
<code>a' or 't'='t</code>，此时原始语句发生了变化：</p>

<pre><code>SELECT * FROM users WHERE name = 'a' OR 't'='t';
</code></pre>

<p>如果这种代码被用于一个认证过程，那么这个例子就能够强迫选择一个合法的用户名，因为赋值’t’=’t’永远是正确的。</p>

<p>在一些SQL服务器上，如在SQL　Server中，任何一个SQL命令都可以通过这种方法被注入，包括执行多个语句。下面语句中的username的值将会导致删除“users”表，又可以从“data”表中选择所有的数据(实际上就是透露了每一个用户的信息)。</p>

<pre><code>a';DROP TABLE users; SELECT * FROM data WHERE name LIKE '%
</code></pre>

<p>这就将最终的SQL语句变成下面这个样子：</p>

<pre><code>SELECT * FROM users WHERE name = 'a';DROP TABLE users; SELECT *
FROM DATA WHERE name LIKE '%';
</code></pre>

<p>其它的SQL执行不会将执行同样查询中的多个命令作为一项安全措施。这会防止攻击者注入完全独立的查询，不过却不会阻止攻击者修改查询。</p>

<p><strong>2. Incorrect type handling</strong></p>

<p>如果一个用户提供的字段并非一个强类型，或者没有实施类型强制，就会发生这种形式的攻击。当在一个SQL语句中使用一个数字字段时，如果程序员没有检查用户输入的合法性(是否为数字型)就会发生这种攻击。例如：</p>

<pre><code>statement := "SELECT * FROM data WHERE id = " + a_variable + ";"
</code></pre>

<p>　　从这个语句可以看出，作者希望a_variable是一个与“id”字段有关的数字。不过，如果终端用户选择一个字符串，就绕过了对转义字符的需要。例如，将a_variable设置为:<code>1;DROP TABLE users</code>，它会将“users”表从数据库中删除，SQL语句变成：</p>

<pre><code>SELECT * FROM DATA WHERE id = 1;DROP TABLE users;
</code></pre>

<p><strong>3. 数据库服务器中的漏洞</strong></p>

<p>有时，数据库服务器软件中也存在着漏洞，如MYSQL服务器中<code>mysql_real_escape_string()</code>函数漏洞。这种漏洞允许一个攻击者根据错误的统一字符编码执行一次成功的SQL注入式攻击。</p>

<p><strong>4. 盲目SQL注入式攻击</strong></p>

<p>当一个Web应用程序易于遭受攻击而其结果对攻击者却不见时，就会发生所谓的盲目SQL注入式攻击。有漏洞的网页可能并不会显示数据，而是根据注入到合法语句中的逻辑语句的结果显示不同的内容。这种攻击相当耗时，因为必须为每一个获得的字节而精心构造一个新的语句。但是一旦漏洞的位置和目标信息的位置被确立以后，一种称为Absinthe的工具就可以使这种攻击自动化。</p>

<p><strong>5. 条件响应</strong></p>

<p>注意，有一种SQL注入迫使数据库在一个普通的应用程序屏幕上计算一个逻辑语句的值：</p>

<pre><code>SELECT booktitle FROM booklist WHERE bookId = 'OOk14cd' AND 1=1
</code></pre>

<p>这会导致一个标准的面面，而语句</p>

<pre><code>SELECT booktitle FROM booklist WHERE bookId = 'OOk14cd' AND 1=2
</code></pre>

<p>在页面易于受到SQL注入式攻击时，它有可能给出一个不同的结果。如此这般的一次注入将会证明盲目的SQL注入是可能的，它会使攻击者根据另外一个表中的某字段内容设计可以评判真伪的语句。</p>

<p><strong>6. 条件性差错</strong></p>

<p>如果WHERE语句为真，这种类型的盲目SQL注入会迫使数据库评判一个引起错误的语句，从而导致一个SQL错误。例如：</p>

<pre><code>SELECT 1/0 FROM users WHERE username='Ralph'
</code></pre>

<p>显然，如果用户Ralph存在的话，被零除将导致错误。</p>

<p><strong>7. 时间延误</strong></p>

<p>　　时间延误是一种盲目的SQL注入，根据所注入的逻辑，它可以导致SQL引擎执行一个长队列或者是一个时间延误语句。攻击者可以衡量页面加载的时间，从而决定所注入的语句是否为真。</p>

<h3 id="section-1">预防</h3>
<p>针对sql注入的方式，就应该有相应的预防措施。有网友已经列出一些预防措施，<a href="http://www.iteye.com/topic/617072" target="_blank">http://www.iteye.com/topic/617072</a></p>

<p><strong>1.PreparedStatement</strong><br />
这个方法是对Java这门语言而言的，始终以PreparedStatement代替Statement。</p>

<p><strong>2.正则表达式</strong> </p>

<pre><code>2.1、检测SQL meta-characters的正则表达式 `/(\%27)|(\')|(\-\-)|(\%23)|(#)/ix`  
2.2、修正检测SQL meta-characters的正则表达式 
    `/((\%3D)|(=))[^\n]*((\%27)|(\')|(\-\-) |(\%3B)|(:))/i`  
2.3、典型的 SQL 注入攻击的正则表达式 `/\w*((\%27)|(\'))((\%6F)|o|(\%4F))((\%72)|r|(\ ))/ix`  ' 
2.4、检测SQL注入，UNION查询关键字的正则表达式 `/((\%27)|(\'))union/ix(\%27)|(\')`
    - 单引号和它的hex等值　　union - union关键字。  
2.5、检测MS SQL Server SQL注入攻击的正则表达式 `/exec(\s|\+)+(s|x)p\w+/ix`  
</code></pre>

<p><strong>3.字符串过滤</strong> </p>

<p><strong>4.屏蔽不安全符号</strong><br />
 如检查是否含有”’”,”\”,”/”</p>

<h2 id="section-2">跨站脚本攻击</h2>

<p>跨站脚本攻击(Cross Site Script为了区别于CSS简称为XSS)指的是恶意攻击者往Web页面里插入恶意html代码，当用户浏览该页之时，嵌入其中Web里面的html代码会被执行，从而达到恶意用户的特殊目的。</p>

<h3 id="section-3">原理</h3>

<p>此处使用现有的例子，参考<a href="http://www.2cto.com/Article/201310/254010.html" target="_blank">跨站脚本攻击XSS解析及防御</a></p>

<p>假设有个留言板：</p>

<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;?php include('/components/headerinclude.php');?&gt;&lt;/head&gt;
&lt;style type="text/css"&gt;
    .comment-title{
        font-size:14px;
        margin: 6px 0px 2px 4px;
    }
 
    .comment-body{
        font-size: 14px;
        color:#ccc;
        font-style: italic;
        border-bottom: dashed 1px #ccc;
        margin: 4px;
    }
&lt;/style&gt;
    &lt;script type="text/javascript" src="/js/cookies.js"&gt;&lt;/script&gt;
&lt;body&gt;
&lt;form method="post" action="list.php"&gt;
    &lt;div style="margin:20px;"&gt;
        &lt;div style="font-size:16px;font-weight:bold;"&gt;Your Comment&lt;/div&gt;
        &lt;div style="padding:6px;"&gt;
            Nick Name:
            &lt;br/&gt;
            &lt;input name="name" type="text" style="width:300px;"/&gt;
        &lt;/div&gt;
        &lt;div style="padding:6px;"&gt;
            Comment:
            &lt;br/&gt;
            &lt;textarea name="comment" style="height:100px; width:300px;"&gt;&lt;/textarea&gt;
        &lt;/div&gt;
        &lt;div style="padding-left:230px;"&gt;
            &lt;input type="submit" value="POST" style="padding:4px 0px; width:80px;"/&gt;
        &lt;/div&gt;
        &lt;div style="border-bottom:solid 1px #fff;margin-top:10px;"&gt;
            &lt;div style="font-size:16px;font-weight:bold;"&gt;Comments&lt;/div&gt;
        &lt;/div&gt;
        &lt;?php 
            require('/components/comments.php'); 
            if(!empty($_POST['name'])){
                addElement($_POST['name'],$_POST['comment']);
            }
            renderComments();
        ?&gt;
    &lt;/div&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>可以显示如下的结果</p>

<p><img src="../../images/2014/xss_test.jpg" alt="xss_first" /></p>

<p>如有攻击者提交的Comment为类似如下的评论</p>

<pre><code>&lt;stript type="text/javascript"&gt; 
    console.log("FUCK U"); 
&lt;/script&gt;
</code></pre>

<p>则之后每次提交评论时，页面控制台都会输出 “FUCK U”</p>

</div>
        <div class="more text-right"><a href="/2014/11/11/%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E4%B8%8E%E9%98%B2%E8%8C%83.html">继续阅读全文</a></div>
    </div>
    
    <div class="post-card">
        <div class="head"><a href="/2014/11/11/lua%E5%AD%A6%E4%B9%A0.html"><span class="title">Lua学习</span></a><span class="date">2014-11-11</span></div>
        <div class="content"><ul id="markdown-toc">
  <li><a href="#section">入门</a></li>
  <li><a href="#section-1">类功能</a>    <ul>
      <li><a href="#section-2">缘起</a></li>
      <li><a href="#section-3">基础</a></li>
      <li><a href="#section-4">实现</a></li>
    </ul>
  </li>
  <li><a href="#ngxlua">ngx_lua共享内存字典项</a>    <ul>
      <li><a href="#section-5">配置</a></li>
      <li><a href="#section-6">使用</a></li>
    </ul>
  </li>
</ul>

<p>lua 使用</p>

<blockquote>
  <p>现在做的项目，要提供一些小的http接口，负责与redis交互，日志文件的落地等。从配置、修改的简易上，决定使用ngix+lua，这个过程有幸接触到lua编程。里面的一些探索过程记录在此。关于nginx的安装配置，参考 <a href="http://blog.woshifengzi.com/2014/11/07/nginx-install-conf.html" target="_blank">nginx install conf</a>。</p>
</blockquote>

<h2 id="section">入门</h2>

<p>网上关于lua的基本句法的介绍，很多都是对官网简介的翻译，可以很快在宏观上有个了解， 相比较而言<a href="http://www.lua.org/pil/" target="_blank">Progmming in Lua</a>介绍的就比较详细，觉得理解起来不顺畅，也可阅读<a href="http://wenku.baidu.com/link?url=nQcs7NfWfo0l_3L9lNT2aqAHTL2VrUgBdxCSQ4c8VlShzmfQSHs-H0Reje1gOutUtLRjBGCwr1XlEQEo4Dqj-3zWyPE0HSg6W__F0FeZaku" target="_blank">中文版</a>。</p>

<h2 id="section-1">类功能</h2>

<h3 id="section-2">缘起</h3>

<p>为实现日志落地，开发了一个初始化的类文件，有文件的打开、关闭，而打开的文件句柄设计为全局变量，这样在实际的操作函数中可直接使用该句柄，并能在特定情形下（下一小时），调用文件关闭函数将此文件关闭掉。当只落一种日志，每小时生成一个文件时，该设计比较没有问题。
可后来为了实现系统的监控功能，也设计实现个监控接口，将收到信息落地，此种情况下完全拷贝一份上面的代码也可以，但是代码重复了，比较丑陋。
为此，考虑使用常见的类，将需要的变量、函数放在类中，调用类的对象来实现。</p>

<h3 id="section-3">基础</h3>

<p>参考网上资料，使用了lua的元表功能。对于元表的连接，参考了 <a href="http://blog.csdn.net/xocoder/article/details/9028347" target="_blank">寰子的博客</a>。
引用如下， Lua查找一个表元素时的规则，其实就是如下3个步骤:</p>

<p>1.在表中查找，如果找到，返回该元素，找不到则继续
2.判断该表是否有元表，如果没有元表，返回nil，有元表则继续
3.判断元表有没有__index方法，如果__index方法为nil，则返回nil；如果__index方法是一个表，则重复1、2、3；如果__index方法是一个函数，则返回该函数的返回值</p>

<p>而元表和所谓是__index 是如何使用的呢？</p>

<pre><code>tableA.__index = tableA -- 把tableA的__index方法指向自己
setmetatable(tableB, tableA)   --把B的metatable设置为A
</code></pre>

<h3 id="section-4">实现</h3>

<p>基于此，一个简单的lua类，就可以如博客 <a href="http://blog.csdn.net/losophy/article/details/20311387" target="_blank">lua学习：lua中“类”的实现</a></p>

<pre><code>A = {x=0,y=0}  
--这句是重定义元表的索引，必须要有，  
A.__index = A   
  
--模拟构造体，一般名称为new()  
function A:new(x,y)  
    local self = {}    
    setmetatable(self, A)   --必须要有  
    self.x = x    
    self.y = y   
    return self    
end    
function A:test()  
print(self.x,self.y)  
end  
  
objA = A:new(1,2)  
objA:test()  
print(objA.x,objA.y)
</code></pre>

<h2 id="ngxlua">ngx_lua共享内存字典项</h2>

<h3 id="section-5">配置</h3>

<pre><code>http {
    ... 
    lua_shared_dict monitor_dict 1M;
    ...
}
</code></pre>

<p>这样就定义了个字典项 access_dict，分配的内存大小为1M。</p>

<h3 id="section-6">使用</h3>

<p>博客 <a href="http://blog.csdn.net/weiyuefei/article/details/38487475" target="_blank">ngx_lua模块中的共享内存字典项API</a> 中列了很多字典项的接口，以及使用说明。目前自己的代码中只用到了add 和 delete，具体如下：</p>

<pre><code>-- 首先是使用这个共享内存
local shared_dict = ngx.shared.monitor_dict
local rotate_key = "monitor_log"
while true do
    if cur_hour_level == monitor_log.hour then
        break
    else
        -- 这儿使用共享内存达到锁的目的
        -- 想shard_dict中天剑一个标识，1标示里面只能有一个这个的标识，10，标识当超过10s后没有成功就返回
        local ok, err = shared_dict:add(rotate_key, 1, 10)
        if not ok then
            ngx.sleep(0.01)
        else
            if cur_hour_level &gt; monitor_log.hour then
                monitor_log:close_file()
                monitor_log:open_file()
                if access_add_1_log_fo == nil then
                    nginx_exit("OpenFile Error")
                end
                monitor_log:hour_level_update(cur_hour_level)
            end
            --- 在共享内存中删除这个标识
            shared_dict:delete(rotate_key)
            break
        end
    end
end
</code></pre>

</div>
        <div class="more text-right"><a href="/2014/11/11/lua%E5%AD%A6%E4%B9%A0.html">继续阅读全文</a></div>
    </div>
    
    <div class="post-card">
        <div class="head"><a href="/2014/11/10/mysql%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93.html"><span class="title">Mysql使用问题总结</span></a><span class="date">2014-11-10</span></div>
        <div class="content"><ul id="markdown-toc">
  <li><a href="#section">修改最大连接数</a>    <ul>
      <li><a href="#section-1">配置文件</a></li>
      <li><a href="#section-2">客户端</a></li>
    </ul>
  </li>
  <li><a href="#section-3">修改连接超时时间</a>    <ul>
      <li><a href="#section-4">配置文件</a></li>
      <li><a href="#section-5">客户端</a></li>
    </ul>
  </li>
  <li><a href="#ibdata">ibdata文件过大</a></li>
</ul>

<blockquote>
  <p>使用mysql的过程中，有些东西查询才知道怎么，这里就记录下，算是个笔记。</p>
</blockquote>

<h2 id="section">修改最大连接数</h2>

<p>系统发出告警，mysql打开的连接超过100个，汗，100个的连接，不多。有时候设置上几个连接池可能就要有100个连接。所以修改下myql允许的最大连接数。  </p>

<h3 id="section-1">配置文件</h3>

<p>在my.cnf修改为 max_connections=1000，然后重启mysql服务。  </p>

<h3 id="section-2">客户端</h3>

<p>但是在更多的情况下，线上服务的mysql是不能重启，这时候，可以通过客户端来修改。  </p>

<pre><code>&gt; show variables like '%max_connections%'  --查看
&gt; set GLOBAL max_connections=1000 -- 修改
</code></pre>

<h2 id="section-3">修改连接超时时间</h2>

<p>可以增加最大连接数，到mysql后台查看进程数 <code>show processlist</code>，发现有依然保持有比较多的连接，而这些连接当前都是<code>SLEEP</code>状态。
在说明一个问题，有比较多的连接都已经不再使用了，在与mysql的连接还一直保留着，基于这样情况，就有必要调短些mysql的连接超时时间。  </p>

<h3 id="section-4">配置文件</h3>

<p>my.cnf中修改配置，然后重启mysql。默认的时间是28800（8小时，前面单位是分钟）</p>

<pre><code>wait_timeout=600
interactive_timeout=600
</code></pre>

<h3 id="section-5">客户端</h3>

<pre><code>&gt; show variables like '%timeout%';   
&gt; set global wait_timeout=600;
&gt; set global interactive_timeout=600;
</code></pre>

<p><em>注意：</em> 要同时修改wait_timeout和interactive_timeout，不然wait_timeout会被interactive_time覆盖</p>

<h2 id="ibdata">ibdata文件过大</h2>

<p>ibdata1文件存放的是数据文件而不是日志文件等，如果直接删除，数据也就丢失了。解决方法：数据文件单独存放(共享表空间如何改为每个表独立的表空间文件)。
1. 备份数据库
$ mysqldump -q -umysql -ppassword –all-databases &gt; bak.sql</p>

<ol>
  <li>
    <p>修改配置文件</p>

    <p>cat my.cnf
 [mysqld]
 innodb_file_per_table=1   # 添加</p>
  </li>
  <li>
    <p>关闭 mysql</p>

    <p>$ sudo serive mysql stop</p>
  </li>
  <li>
    <p>删除文件</p>

    <p>$ rm ibdata1 ib_logfile*</p>
  </li>
  <li>
    <p>重启mysql</p>

    <p>$ sudo service mysql start   </p>
  </li>
  <li>
    <p>恢复数据  </p>

    <p>$ mysql -uusername -pyourpassword &lt; bak.sql</p>
  </li>
</ol>

<p>## </p>

</div>
        <div class="more text-right"><a href="/2014/11/10/mysql%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93.html">继续阅读全文</a></div>
    </div>
    
    <div class="post-card">
        <div class="head"><a href="/2014/11/08/hadoop%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB.html"><span class="title">Hadoop问题汇总</span></a><span class="date">2014-11-08</span></div>
        <div class="content"><ul id="markdown-toc">
  <li><a href="#map100reduce">map执行100%，reduce任务不执行</a></li>
  <li><a href="#reduce255">reduce返回255</a></li>
  <li><a href="#mapreduce">mapreduce用法</a></li>
  <li><a href="#hive">hive连接数据库</a></li>
</ul>

<p>hadoop 使用过程中遇到的问题汇总（版本2.2） </p>

<h3 id="map100reduce">map执行100%，reduce任务不执行</h3>
<ul>
  <li>
    <p>定位  </p>

    <p><code>yarn-work-resourcemanage-host-151.log</code>日志文件一直在输出： </p>

    <pre><code>  capacity.LeafQueue (LeafQueue.java:assignToQueue(946)) - default usedResources: &lt;memory:2048, vCores:1&gt; clusterResources: &lt;memory:4096, vCores:2&gt; currentCapacity 0.5 required &lt;memory:4096, vCores:1&gt; potentialNewCapacity: 1.5 (  max-capacity: 1.0)
</code></pre>
  </li>
  <li>
    <p>处理  </p>

    <p><code> yarn-site.xml </code>中<code> yarn.nodemanager.resource.memory-mb </code>设置为了<code> 4096 </code>, 如果改为2048的话，则map也不执行了。查看执行mapreduce的任务，有个启动参数 ` -D ‘mapred.job.reduce.memory.mb=’4096’’  `，将其改为2048则就可以执行了。</p>
  </li>
  <li>
    <p>分析<br />
ok，可以看到在hadoop的配置中，特别是关于分配的内存大小有很多的选项，这么多的选项都是做什么的，在什么地方使用呢。 </p>
  </li>
</ul>

<h3 id="reduce255">reduce返回255</h3>

<ul>
  <li>定位</li>
</ul>

<p>运行mapreduce时，出现如下的错误：</p>

<pre><code>14/11/22 14:45:02 INFO mapreduce.Job:  map 100% reduce 0%
14/11/22 14:45:10 INFO mapreduce.Job: Task Id : attempt_1406010920358_60903_r_000000_0, Status : FAILED
Error: java.lang.RuntimeException: PipeMapRed.waitOutputThreads(): subprocess failed with code 255
    at org.apache.hadoop.streaming.PipeMapRed.waitOutputThreads(PipeMapRed.java:320)
    at org.apache.hadoop.streaming.PipeMapRed.mapRedFinished(PipeMapRed.java:533)
    at org.apache.hadoop.streaming.PipeReducer.close(PipeReducer.java:134)
    at org.apache.hadoop.io.IOUtils.cleanup(IOUtils.java:237)
    at org.apache.hadoop.mapred.ReduceTask.runOldReducer(ReduceTask.java:477)
    at org.apache.hadoop.mapred.ReduceTask.run(ReduceTask.java:408)
    at org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:162)
    at java.security.AccessController.doPrivileged(Native Method)
    at javax.security.auth.Subject.doAs(Subject.java:415)
    at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1491)
    at org.apache.hadoop.mapred.YarnChild.main(YarnChild.java:157)
</code></pre>

<p>搜索<code>failed with code 255</code>，得到信息是reduce运行错误，返回 <code>-1</code> 。看hadoop的reduce的日志，发现时解析应用列表文件出错。</p>

<p>注：hadoop的mapreduce历史记录通过mapreduce接口网站查看，进到每个任务的<code>logs</code>中，不只是看 <code>Note</code> 的内容。如果不是通过网页，而是直接在机器上看日志，或者hadoop上的文件，目前还没有找到在什么地方存放！</p>

<ul>
  <li>处理</li>
</ul>

<p>发现时解析应用列表的json文件出错，而实际上这个文件的json内容是正确的，解析不应该出错。启动mapreduce的时候，配置项如下：</p>

<pre><code>-file $DIR_ROOT/conf/app.conf \
... ...
-cmdenv APP_CONFIG="$DIR_ROOT/conf/app.conf" \
</code></pre>

<p>经咨询，原来是 -cmdenv指定使用哪个文件是，已经用file指定路径和名称了，就不需要在指定路径了，所以做如下修改即可了</p>

<pre><code>-file $DIR_ROOT/conf/app.conf \
... ...
-cmdenv APP_CONFIG="app.conf" \
</code></pre>

<h3 id="mapreduce">mapreduce用法</h3>

<p>翻阅版本2.5.2的 <a href="http://hadoop.apache.org/docs/stable/hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html">MapReduce Tutorial</a>{_target=”_blank”}，记录一些之前没有注意的知识点。</p>

<ul>
  <li>
    <p>设定符号名</p>

    <p>bin/hadoop jar hadoop-mapreduce-examples-<ver>.jar wordcount -files dir1/dict.txt#dict1,dir2/dict.txt#dict2 -archives mytar.tgz#tgzdir input output</ver></p>
  </li>
</ul>

<p>符号名dict1代指/dir1/dict，dict2代指/dir2/dict，tgzdir代指mytar.tgz；使用-files指定了多个文件。</p>

<ul>
  <li>阐述处理流程</li>
</ul>

<p>文档中有提供了一个字数统计的例子，并简要说明了处理的流程。以前就知道 map结果给reduce，reduce做统计。其中有几个更细节的地方：<br />
1、map处理输入文件，生成中间结果，即每个&lt;wordx,1&gt;<br />
2、接下来就由mapreduce的框架，根据key来分类、排序，将排序后的结果给reduce。分组，则一个key下，就可能有多个map的中间结果，即&lt;key, (list of values)&gt;<br />
3、map可以有多个，多个合并到一起有需要排序，这个由reduce来做，必要的情况下还会有两个排序<br />
4、map可以多个，reduce也可以多个  </p>

<pre><code>All intermediate values associated with a given output key are subsequently grouped by the framework, and passed to the Reducer(s) to determine the final output. Users can control the grouping by specifying a Comparator via Job.setGroupingComparatorClass(Class).
The Mapper outputs are sorted and then partitioned per Reducer. The total number of partitions is the same as the number of reduce tasks for the job. Users can control which keys (and hence records) go to which Reducer by implementing a custom Partitioner.
</code></pre>

<ul>
  <li>启动的map、reduce数</li>
</ul>

<p>默认情况下，启动map数由输入文件块决定，即文件块的个数。比如，输入文件是10TB，块大小是128M，则整个过程要启动82,000个maps（如果配置中没有限定MRJobConfig.NUM_MAPS）。</p>

<p>比较好的reduce的个数： 0.95 or 1.75 multiplied by (<no. of="" nodes=""> * <no. of="" maximum="" containers="" per="" node="">)</no.></no.></p>

<p>我们在实际使用的时候，好像没有这么配置，而是根据预估的任务量和node数配置了。</p>

<h3 id="hive">hive连接数据库</h3>

<p>在运行一个hive命令的时候，提示连接Mysql的数据库有问题，但是在代码中没有要连接mysql数据库的地方。
原来hive配置文件<code>hive-site.xml</code>中设定的 </p>

<pre><code>&lt;property&gt;
    &lt;name&gt;hive.stats.dbconnectionstring&lt;/name&gt;
    &lt;value&gt;jdbc:mysql://192.168.1.127:3606/hive_db?createDatabaseIfNotExist=true&lt;/value&gt;
    &lt;description&gt;The default connection string for the database that stores temporary Hive statistics.&lt;/description&gt;
&lt;/property&gt;

&lt;property&gt;
    &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;
    &lt;value&gt;pwd123456&lt;/value&gt;
    &lt;description&gt;password to use against metastore database&lt;/description&gt;
&lt;/property&gt;
</code></pre>

</div>
        <div class="more text-right"><a href="/2014/11/08/hadoop%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB.html">继续阅读全文</a></div>
    </div>
    
    <div class="post-card">
        <div class="head"><a href="/2014/11/07/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE.html"><span class="title">Nginx安装与配置</span></a><span class="date">2014-11-07</span></div>
        <div class="content"><ul id="markdown-toc">
  <li><a href="#section">安装</a></li>
  <li><a href="#section-1">配置</a>    <ul>
      <li><a href="#section-2">配置文件说明</a></li>
      <li><a href="#lua">与lua结合</a></li>
      <li><a href="#section-3">初始化</a></li>
      <li><a href="#section-4">修改不重启生效</a></li>
      <li><a href="#nginx">nginx负载均衡</a></li>
      <li><a href="#nginx-1">nginx备份</a></li>
    </ul>
  </li>
</ul>

<blockquote>
  <p><a href="http://nginx.org/">nginx</a>也火了很久了，最近因为实际的需求，要使用nginx，也就好好的了解下。  </p>
</blockquote>

<h2 id="section">安装</h2>

<p>总的来说，安装还是比较简单的  </p>

<pre><code>$ wget http://nginx.org/download/nginx-1.6.2.tar.gz
$ tar zxf nginx-1.6.2.tar.gz &amp;&amp; cd nginx-1.6.2
# ./configure &amp;&amp; make &amp;&amp; make install 
</code></pre>

<p>或者只用用Linux发行版提供的软件包安装即可  </p>

<pre><code>$ audo aptitude install nginx
</code></pre>

<p>但是默认的nginx会少一些库，比如我们想将和lua结合使用，默认情况可能下就没有。为此，我们在编译的时候使用 –add-module 的参数来添加我们需要的这些模块。
比较详细的说明，nginx的<a href="http://wiki.nginx.org/Modules">wiki</a>上有对所有模块的说明。这里只是我只是列出来，我需要的几个模块。
在一个新安装的ubuntu系统上可能缺少一些文件包，这里也一并列出:  </p>

<pre><code>$ sudo install lua5.1 liblua5.1-dev  liblua5.1-socket2 liblua5.1-json
$ sudo aptitude install libpcre++-dev libpcre++0
$ sudo aptitude install libcurl-ssl-dev libssl-dev  libssl1.0.0
$ sudo aptitude install zip libzip-dev
$ ./configure --prefix=/opt/nginx --add-module=/home/work/nginx/lua-nginx-module-0.9.8 --with-http_ssl_module --with-http_addition_module --add-module=/home/work/nginx/ngx_devel_kit-0.2.19 --add-module=/home/work/nginx/redis2-nginx-module-0.11 --add-module=/home/work/nginx/set-misc-nginx-module-0.26
# make &amp;&amp; make install
</code></pre>

<p>想用lua访问redis，还需要lua正对redis的插件，参考nginx的<a href="http://wiki.nginx.org/LuaRedisParser">wiki</a>。这个过程简略如下：  </p>

<pre><code>$ cd lua-redis-parser-0.10
$ export LUA_INCLUDE_DIR=/usr/include/lua5.1
$ make CC=gcc
$ sudo make install CC=gcc
</code></pre>

<p>这样所需要的安装过程就完成了，剩下的就是配置方面的事情了。在做配置前，我们可以先用nginx默认的配置文件启动服务感受下：  </p>

<pre><code>$ cd /opt/nginx
$ sudo ./sbin/nginx -c /opt/install/conf/nginx.conf
</code></pre>

<p>当配置文件更新后，想让配置文件生效，则重新做加载配置文件：  </p>

<pre><code>$ sudo ./sbin/nginx -s reload  
</code></pre>

<p>执行 <code>-s reload</code> 后，没有提示错误信息，但是修改的内容不生效，这时候看下nginx的error日志能看到出错的地方。  </p>

<p>这样安装需要在编译时就指定好要使用什么模块，以后需要添加的模块或lua库也可以通过 <code>lua_package_path "/path/to/*.lua;;";</code>的方式使用。
可以参考<a href="http://blog.kissdata.com/2014/11/14/nginx-lua-install.html" target="_blank">nginx与lua安装教程</a>。</p>

<h2 id="section-1">配置</h2>

<h3 id="section-2">配置文件说明</h3>

<p>刚安装好的服务也会提供一份简单的配置文件，nginx.conf。此处先记录下对配置文件的一些认识：  </p>

<ul>
  <li>通大多数的配置问价一样，也是 以”#” 来做注释的 </li>
  <li>自己用到的配置文件提供events与http，样例中有关于mail等的配置，目前没有用到 </li>
  <li>在http中提供server，server中配置域名等信息，通过这个域名（dns或hosts识别）即可访问这个server所提供的服务 </li>
  <li>http中配置反向映射，负载均衡等。关于nginx和lvs负载均衡，应在出篇博客 </li>
  <li>配置文件可以拆成多个文件，用 include /path/to/*.conf 引用即可 </li>
</ul>

<p>更加详细的信息，网上有很多，这里列上<a href="http://www.cnblogs.com/xiaogangqq123/archive/2011/03/02/1969006.html">一</a>、
<a href="http://kingj.iteye.com/blog/1420187">两</a>个，如果将来需要去上查看，就不在浪费篇章。
官网<a href="http://wiki.nginx.org/Configuration">wiki</a>上有更加详细的说明。  </p>

<h3 id="lua">与lua结合</h3>

<p>先提供一个简单配置:  </p>

<pre><code>user www-data;
worker_processes  1;
events {
    worker_connections  1024;
}
http {
  include       mime.types;
    default_type  application/octet-stream;
    keepalive_timeout  65;
    server {
    listen       80;
        server_name  test.fengzi.com;

        root /data/html/test;
        index  index.html index.htm;

        location /lua {
        content_by_lua_file /data/nginx_lua_files/lua.lua;
        }
    }
}

cat lua.lua
#!/usr/bin/env lua
ngx.header.content_type = "text/html; charset=utf8"
ngx.print("hello fengzi")
ngx.say("fengzi say hello ")  
</code></pre>

<p>在/etc/hosts中配置好 127.0.0.1   test.fengzi.com，则就可以在浏览器中访问 test.fengzi.com/lua 了。  </p>

<h3 id="section-3">初始化</h3>

<pre><code>http{
    ...
    init_by_lua_file /home/work/web/access_init.lua;
    lua_shared_dict access_add_1_dict 1M;
    ...
}
</code></pre>

<p>第一个是用lua文件中代码做初始化，第二个是设置一个变量。这个两处设置都是设置为全局的变量，常驻内存，可在lua代码中直接使用 :) 。 详细信息请参考博客：<a href="http://blog.csdn.net/weiyuefei/article/details/38487475" target="_blank">ngx_lua模块中的共享内存字典项API</a> 。 </p>

<h3 id="section-4">修改不重启生效</h3>

<pre><code>location = /test {
    lua_code_cache off;
    ... ...
}
</code></pre>

<p>这个会影响nginx的性能，但是在开发机上如此配置，可以提高开发效率。如果添加或修改了一些.so之类的库文件还是要重启的</p>

<h3 id="nginx">nginx负载均衡</h3>

<p>此处提供个简单配置例子：  </p>

<pre><code>http {
 ...
    upstream webservers {
        server 192.168.1.201 weight=1 max_fails=2 fail_timeout=2;
        server 192.168.1.202 weight=1 max_fails=2 fail_timeout=2;
        #server 127.0.0.1:8080 backup;
    }
    server {
        listen       80;
        server_name  localhost;
        #charset koi8-r;
        #access_log  logs/host.access.log  main;
        location / {
            proxy_pass      http://webservers;
            proxy_set_header  X-Real-IP  $remote_addr;
        }
    }
}
</code></pre>

<p>陈明乾在其博客 <a href="http://freeloda.blog.51cto.com/2033581/1288553">Nginx 反向代理、负载均衡、页面缓存、URL重写及读写分离详解</a>中以实践的形式给出的详细的说明，解释。可多看几次  </p>

<h3 id="nginx-1">nginx备份</h3>
<p>nginx和Keepalive可以实现双机热备份，现在还都是在测试环境下，还没有做实践，先记录着，以后配置时有什么问题再记录。查阅到两篇博客
<a href="https://www.centos.bz/2012/02/nginx-keepalived-high-availability/" target="_blank">nginx+keepalived实现双机热备的高可用</a>，
<a href="http://www.2cto.com/os/201109/106387.html" target="_blank">nginx主主集群</a> 。
前一篇博客是创建一个双机热备份的过程，介绍的比较详细，后一篇则是，让nginx 的master-backup也做到负载均衡。对两篇文章的说明实现 。</p>

</div>
        <div class="more text-right"><a href="/2014/11/07/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE.html">继续阅读全文</a></div>
    </div>
    
    <div class="post-card">
        <div class="head"><a href="/2014/11/04/netty.html"><span class="title">Netty</span></a><span class="date">2014-11-04</span></div>
        <div class="content">
<blockquote>
  <p>在<a href="www.liveoak.io" target="_blank">liveoak</a>源代码的过程中，发现了使用netty，为了更加了解，参考 <a href="http://netty.io/wiki/user-guide-for-4.x.html" target="_blank">官网文档</a> 。
本来期待的是能在liveoak的基础上实现所需要的功能，但是否来被否决了。就将看的一些笔记记录在此，以后找个时间翻译下这个官网文档。  </p>
</blockquote>

<p>官网文档上提供了几个比较典型的例子:    </p>

<ul>
  <li><a href="dhttp://netty.io/4.0/xref/io/netty/example/discard/package-summary.html" target="_blank">discard</a>  </li>
  <li><a href="http://netty.io/4.0/xref/io/netty/example/echo/package-summary.html" target="_blank">echo</a>   </li>
</ul>

<p>里面的几个函数，可能会用到  </p>

<ul>
  <li>echo例子中，writeAndFlush() = write() and flush()  </li>
  <li>time例子中，channelActive替代channelRead   </li>
</ul>

<p>总体来说，有server端，有client端，而对里面的一些逻辑处理，都使用了XXHandler的代码。server端和client端的一些不同之处： </p>

<table>
<thead>
    <tr> 
        <th>server</th>
        <th> clinet</th>
    </tr>
</thead>
<tbody>
    <tr> 
        <td>ServerBootstrap</td>
        <td>Bootstrap</td>
    </tr>
    <tr> 
        <td>group(bossGroup, workerGroup) </td>
        <td> group(group)</td> 
    </tr>
    <tr> 
        <td>NioServerSocketChannel.class </td>
        <td>NioSocketChannel.class</td> 
        </tr>
    <tr> 
        <td>b.bind(PORT).sync() </td> 
        <td>b.connect(HOST, PORT).sync()</td>
    </tr>
</tbody>
</table>

<p>文档接下来探讨数据流的分割   </p>

<ul>
  <li>方案1、预先知道两端传输的字节流的长度，用buf.readableBytes()来保证接收到了足够的数据  </li>
  <li>方案2、使用多个handler来实现  </li>
</ul>

</div>
        <div class="more text-right"><a href="/2014/11/04/netty.html">继续阅读全文</a></div>
    </div>
    
</div>

<div class="nav-post-links">
        
        <span class="newer-posts-link">
            
                <a href="/page6" title="previous page">&laquo; Newer Posts</a>
            
        </span>
        

        
        <span class="older-posts-link">
            <a href="/page8" title="next page">Older Posts &raquo;</a>
        </span>
        
</div>

                    </div>
                    <div class="col-md-3" id="main-right">
                        <div>
    <h4><strong>文章分类</strong></h4>
    <hr class="small-margin colored-hr" />
    <ul class="side-cat-ul">
        
        <li><a href="/categories.html#cat-生活随记" title="生活随记">生活随记 (3)</a></li>
        
        <li><a href="/categories.html#cat-bigdata" title="bigdata">bigdata (9)</a></li>
        
        <li><a href="/categories.html#cat-web" title="web">web (9)</a></li>
        
        <li><a href="/categories.html#cat-database" title="database">database (3)</a></li>
        
        <li><a href="/categories.html#cat-linux" title="linux">linux (10)</a></li>
        
        <li><a href="/categories.html#cat-go" title="go">go (8)</a></li>
        
        <li><a href="/categories.html#cat-运维" title="运维">运维 (3)</a></li>
        
        <li><a href="/categories.html#cat-language" title="language">language (7)</a></li>
        
        <li><a href="/categories.html#cat-tools" title="tools">tools (1)</a></li>
        
        <li><a href="/categories.html#cat-iot" title="iot">iot (5)</a></li>
        
    </ul>
</div>

<hr class="small-margin colored-hr" />

<!-- google adsense -->
<!--
<div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
        style="display:inline-block;width:300px;height:600px"
        data-ad-client="ca-pub-1339945837472110"
        data-ad-slot="8220828081"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>
-->


                    </div>
                </div>
            </div>

            <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <hr class="colored-hr" />

                <p class="text-center">
                Copyright 2014 - 2016 | Gen time&#58; 2016-04-12 01:51:47 CST

                <!-- cnzz -->
                

                </p>


            </div>
        </div>
    </div>
    <div style="display:none;" class="back-to" id="toolBackTop">
        <a title="返回顶部" onclick="window.scrollTo(0,0);return false;" href="#top" class="back-top">返回顶部</a>
    </div>

    <!-- google analytics -->
    


</div>

    </body>
</html>
