<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="jgj" />
        <meta name="viewport" content="width=device-width" /> 
        <title>Ngx_lua使用代码库 | 我是疯子</title>
        
        <meta name="keywords" content="" />
        

        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- bootstrap source -->
        <!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <!-- 可选的Bootstrap主题文件（一般不用引入） -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
        <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
        <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
        <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
        <script src="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="/asset/css/kissdata.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <link href="/feed.html" rel="alternate" title="jgj" type="application/atom+xml" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="icon" href="/favicon.ico" />

        <style type="text/css">
            body {
                padding-top: 55px;
                padding-bottom: 30px;
                background-color: #EEE;
            }
        </style>

        <link rel="stylesheet" href="/asset/js/google-code-prettify/prettify.css">
        <script src="/asset/js/google-code-prettify/prettify.js"></script>

        <script type="text/javascript">
            $(document).ready(function () {

                // go to top
                var bt = $('#toolBackTop'); var sw = $(document.body)[0].clientWidth; var limitsw = (sw - 840) / 2 - 80; if (limitsw > 0){ limitsw = parseInt(limitsw); bt.css("right",limitsw); } $(window).scroll(function() { var st = $(window).scrollTop(); if(st > 30){ bt.show(); }else{ bt.hide(); } });

                // google-code-prettify
                $("pre").addClass("prettyprint linenums"); prettyPrint();

            })
        </script>

        <!-- kp747 
        
        -->
    </head>
    <body>
            <div id="header">
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand normal-a" href="javascript:void(0)" onclick="javascript:void(0)">
                    <span id="site_name">我是疯子</span>
                </a>
            </div>

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/categories.html">分类</a></li>
                    <li><a href="/guestbook.html">留言</a></li>
                    <li><a href="/about.html">关于</a></li>
                    <li><a href="/feed.html">RSS</a></li>
                    <li><a href="javascript:void(0)" class="normal-a" onclick="javascript:void(0)"><span id="site_description">在此停留片刻，偶有所得！</span></a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>


            <div class="container">
                <div class="row">
                    <div class="col-md-9" id="main-left">
                        <div class="page">
    <div class="head">
        <div class="title">Ngx_lua使用代码库</div>
        <div class="date">date: 2015-05-05</div>
    </div>
    <hr class="middle-margin" />


    <!-- google adsense -->
    <!--
    <div>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
            style="display:inline-block;width:728px;height:90px"
            data-ad-client="ca-pub-1339945837472110"
            data-ad-slot="9657522081"></ins>
        <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
    </div>
    <hr class="middle-margin" />
    -->

    <div class="content">
        <ul id="markdown-toc">
  <li><a href="#luac">lua调用C函数</a></li>
  <li><a href="#section">基础函数</a>    <ul>
      <li><a href="#section-1">初始化函数</a></li>
      <li><a href="#section-2">库函数</a></li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>使用ngx_lua重构服务端接口时，用到加密、解密算法，原来使用C来实现，有很多的位操作，使用lua来重构会比较麻烦，不如直接用使用C库形式。在开发过程中，有一些基础的函数，会在多个地方调用，通过库的形式调用，会更加优雅一些。</p>
</blockquote>

<h2 id="luac">lua调用C函数</h2>
<p>参考 <a href="http://www.cnblogs.com/stephen-liu74/archive/2012/07/23/2469902.html" target="_blank">Step By Step(Lua调用C函数)</a>，此处只是做简单说明。</p>

<pre><code>#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;lua.hpp&gt;
#include &lt;lauxlib.h&gt;
#include &lt;lualib.h&gt;
static int add(lua_State* L) {  // 以栈的形式传递参数
    double op1 = luaL_checknumber(L,1);  // 1表示Lua调用时的第一个参数(从左到右)，依此类推
    double op2 = luaL_checknumber(L,2); 
    lua_pushnumber(L,op1 + op2); // 将函数的结果压入栈中。如果有多个返回值，可以在这里多次压入栈中
    return 1;
}
static luaL_Reg testLibName[] = { // luaL_Reg结构体的第一个字段为字符串，在注册时用于通知Lua该函数的名字
{"add", add},
{NULL, NULL} // 结构体数组中的最后一个元素的两个字段均为NULL，用于提示Lua注册函数已经到达数组的末尾
};
// 其函数名必须为luaopen_xxx，其中xxx表示library名称。Lua代码require "xxx"需要与之对应
int luaopen_testLibName(lua_State* L){ 
const char* libName = "testLibName";
luaL_register(L,libName,testLibName);  // 需要强调的是，所有需要用到"xxx"的代码，不论C还是Lua，都必须保持一致，这是Lua的约定
return 1;
}
</code></pre>

<p>为了方便，通过Makefile文件执行编译：</p>

<pre><code>##### Build defaults #####
LUA_VERSION =       5.1
TARGET =            test.so
PREFIX =            /usr/local/luajit
CFLAGS =            -O3 -Wall -pedantic -DNDEBUG
CJSON_CFLAGS =      -fpic
CJSON_LDFLAGS =     -shared
LUA_INCLUDE_DIR =   $(PREFIX)/include/luajit-2.0
LUA_CMODULE_DIR =   $(PREFIX)/lib/lua/$(LUA_VERSION)
LUA_MODULE_DIR =    $(PREFIX)/share/lua/$(LUA_VERSION)
LUA_BIN_DIR =       $(PREFIX)/bin

BUILD_CFLAGS =      -I$(LUA_INCLUDE_DIR) $(CJSON_CFLAGS)
OBJS =               test.o

.PHONY: all clean
.c.o:
$(CC) -c $(CFLAGS) $(CPPFLAGS) $(BUILD_CFLAGS) -o $@ $&lt;
all: $(TARGET)

$(TARGET): $(OBJS)
$(CC) $(LDFLAGS) $(CJSON_LDFLAGS) -o $@ $(OBJS)
clean:
rm -f *.o $(TARGET)
</code></pre>

<p>在ngx_lua中使用，将生成的 test.so 放在特定的目录下，nginx.conf 以类似 <code>lua_package_cpath '/usr/local/nginx_lua/lua_so/?.so;;';</code> 的形式包含，
参考<a href="http://blog.kissdata.com/2014/11/14/nginx-lua-install.html" target="_blank">nginx与lua的安装教程</a>。<br />
上面使用 <code>lua_pushnumber</code>函数，在实际的过程中，使用的可能是 <code>lua_pushlstring</code>，更多的函数，
可以查阅 <a href="http://www.codingnow.com/2000/download/lua_manual.html" target="_blank">lua 参考手册</a></p>

<h2 id="section">基础函数</h2>
<p>实际编码过程中，会有一些逻辑，在多个地方被调用。采用基础函数的方式来实现，是比较好的选择。而其实现，也有几种方式</p>

<h3 id="section-1">初始化函数</h3>
<p>nginx.conf 的 http 模块中，通过 <code>init_by_lua_file /path/init.lua;</code> 的方式配置初始化文件，在nginx启动时，
会将文件中的内容(变量、函数、共享内存)等加载到内存，在整个nginx运行过程中均可以被使用。文件中内容为全局的，可直接使用变量、函数。<br />
但是init文件只能有一个，如果太多的东西都塞进来，文件会比较冗长，阅读不方便，且一致占用内存</p>

<h3 id="section-2">库函数</h3>
<p>通过<code>lua_package_path '/path1_to/lua_so/?.lua;/path2_to/?.lua;';</code> 的方式指定路径。有 com.lua 文件如下</p>

<pre><code>local null = ngx.null
local unpack = unpack
local setmetatable = setmetatable

local _M = { _VERSION = '0.1' }
local mt = { __index = _M }

function _M.new(self)
math.randomseed(os.time())
return setmetatable({}, mt)
end

function _M.genReturnTable(self,a)
local obj = {}
obj.dtl = "ok"
obj.str = a
return obj
end
function _M.testFun(self, a)
    -- check a !
    -- when call inner function, user _M.xx(self, ...)
    return _M.genReturnTable(self, a)
end

return _M
</code></pre>

<p>在使用调用内容，则如下</p>

<pre><code>local com = require("com")
com.testFun("testStr")
</code></pre>

<p>注意，对于lua类方法的调用，则要用<code>:</code>    </p>

    </div>
</div>



    
        <div class="comment">
    
    <!-- duoshuo -->
    
    <div class="ds-thread" data-thread-key="/2015/05/05/ngx_lua使用代码库" data-title="Ngx_lua使用代码库" data-url="http://jgj1986.github.io/2015/05/05/ngx_lua%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%A0%81%E5%BA%93.html"></div>
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-woshifengzi"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.unstable.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    

    
    <!-- disqus -->
    
    
    
</div>

    



                    </div>
                    <div class="col-md-3" id="main-right">
                        <div>
    <h4><strong>文章分类</strong></h4>
    <hr class="small-margin colored-hr" />
    <ul class="side-cat-ul">
        
        <li><a href="/categories.html#cat-生活随记" title="生活随记">生活随记 (3)</a></li>
        
        <li><a href="/categories.html#cat-bigdata" title="bigdata">bigdata (9)</a></li>
        
        <li><a href="/categories.html#cat-web" title="web">web (9)</a></li>
        
        <li><a href="/categories.html#cat-database" title="database">database (3)</a></li>
        
        <li><a href="/categories.html#cat-linux" title="linux">linux (10)</a></li>
        
        <li><a href="/categories.html#cat-go" title="go">go (8)</a></li>
        
        <li><a href="/categories.html#cat-运维" title="运维">运维 (3)</a></li>
        
        <li><a href="/categories.html#cat-language" title="language">language (7)</a></li>
        
        <li><a href="/categories.html#cat-tools" title="tools">tools (1)</a></li>
        
        <li><a href="/categories.html#cat-iot" title="iot">iot (5)</a></li>
        
    </ul>
</div>

<hr class="small-margin colored-hr" />

<!-- google adsense -->
<!--
<div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
        style="display:inline-block;width:300px;height:600px"
        data-ad-client="ca-pub-1339945837472110"
        data-ad-slot="8220828081"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>
-->


                    </div>
                </div>
            </div>

            <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <hr class="colored-hr" />

                <p class="text-center">
                Copyright 2014 - 2016 | Gen time&#58; 2016-04-12 01:51:47 CST

                <!-- cnzz -->
                

                </p>


            </div>
        </div>
    </div>
    <div style="display:none;" class="back-to" id="toolBackTop">
        <a title="返回顶部" onclick="window.scrollTo(0,0);return false;" href="#top" class="back-top">返回顶部</a>
    </div>

    <!-- google analytics -->
    


</div>

    </body>
</html>
