<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="jgj" />
        <meta name="viewport" content="width=device-width" /> 
        <title>Heka源码阅读 | 我是疯子</title>
        
        <meta name="keywords" content="" />
        

        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- bootstrap source -->
        <!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <!-- 可选的Bootstrap主题文件（一般不用引入） -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
        <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
        <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
        <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
        <script src="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="/asset/css/kissdata.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <link href="/feed.html" rel="alternate" title="jgj" type="application/atom+xml" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="icon" href="/favicon.ico" />

        <style type="text/css">
            body {
                padding-top: 55px;
                padding-bottom: 30px;
                background-color: #EEE;
            }
        </style>

        <link rel="stylesheet" href="/asset/js/google-code-prettify/prettify.css">
        <script src="/asset/js/google-code-prettify/prettify.js"></script>

        <script type="text/javascript">
            $(document).ready(function () {

                // go to top
                var bt = $('#toolBackTop'); var sw = $(document.body)[0].clientWidth; var limitsw = (sw - 840) / 2 - 80; if (limitsw > 0){ limitsw = parseInt(limitsw); bt.css("right",limitsw); } $(window).scroll(function() { var st = $(window).scrollTop(); if(st > 30){ bt.show(); }else{ bt.hide(); } });

                // google-code-prettify
                $("pre").addClass("prettyprint linenums"); prettyPrint();

            })
        </script>

        <!-- kp747 
        
        -->
    </head>
    <body>
            <div id="header">
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand normal-a" href="javascript:void(0)" onclick="javascript:void(0)">
                    <span id="site_name">我是疯子</span>
                </a>
            </div>

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/categories.html">分类</a></li>
                    <li><a href="/guestbook.html">留言</a></li>
                    <li><a href="/about.html">关于</a></li>
                    <li><a href="/feed.html">RSS</a></li>
                    <li><a href="javascript:void(0)" class="normal-a" onclick="javascript:void(0)"><span id="site_description">在此停留片刻，偶有所得！</span></a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>


            <div class="container">
                <div class="row">
                    <div class="col-md-9" id="main-left">
                        <div class="page">
    <div class="head">
        <div class="title">Heka源码阅读</div>
        <div class="date">date: 2015-12-02</div>
    </div>
    <hr class="middle-margin" />


    <!-- google adsense -->
    <!--
    <div>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
            style="display:inline-block;width:728px;height:90px"
            data-ad-client="ca-pub-1339945837472110"
            data-ad-slot="9657522081"></ins>
        <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
    </div>
    <hr class="middle-margin" />
    -->

    <div class="content">
        <ul id="markdown-toc">
  <li><a href="#section">大体流程</a></li>
  <li><a href="#section-1">加载配置文件</a></li>
  <li><a href="#section-2">启动与关闭</a></li>
  <li><a href="#section-3">数据的传递</a></li>
</ul>

<blockquote>
  <p>使用heka已经一段时间了，而里面的逻辑还是很有必要看看的。</p>
</blockquote>

<h2 id="section">大体流程</h2>

<pre><code>main (cmd/hekad/main.go)
 |  LoadHekadConfig (cmd/hekad/conf.go)
 |  setGlobalConfigs
 |  loadFullConfig
 |  LoadFromConfigFile (pipeline/config.go)
 |  Run(pipeline/pipeline_runner.go)
</code></pre>

<p>可以大体看出，加载配置文件，设置为一些全局的变量，生成相关的input、output、decoder、encoder、filter等，然后启动这些插件。</p>

<h2 id="section-1">加载配置文件</h2>

<p>加载配置文件，主要是将制定目录下的 .toml 文件 或制定的配置文件读到内存，先设置一些全局的配置如 cpu 等；然后逐个处理每个插件。</p>

<p>先做Pre-loading，判断插件是不是已经注册过的插件。这儿需要说明，使用 AvailablePlugins 来存放已经注册的插件，RegisterPlugin 函数实现后端的注册功能。 在Pre-Loading过程中，会将插件按照 Input、Output、Filter 等分到不同的组中，用于后面不同顺序启动。实际过程是调用 <code>NewPluginMaker</code> 来创建对应的插件制造者(PluginMaker)。</p>

<p>有两个特殊的插件 <code>ProtobufEncoder</code> 和 <code>ProtobufDecoder</code>，即使在没有配置的情况下也要启动。</p>

<p>接下来是Loading过程：分别去除 “Decoder”, “Encoder”, “Input”, “Filter”, “Output” 组中的pluginMaker，调用其 MakerRunner()得到相应的runner，放到不同的Runners组中。
在MakerRunner函数中，会根据类型的不同，生成不同的runner，如NewInputRunner、NewFORunner 等，这些构造函数在 pipeline/plugin_runners.go 中实现。需要说明的一点，在xxRunner的类型都定义了自己的函数，比如Start(调用Starter)函数会调用插件的 <code>Run</code>方法，所以在后续调用每个runner的Start 方法时，即调用了插件的Run方法。encode和decode插件，实现对应的Encode 和 Decode方法，而不是Run方法。</p>

<h2 id="section-2">启动与关闭</h2>

<p>pipeline_runner.go 中的 <code>Run</code>函数实现了heka的插件启动、监控、退出功能。</p>

<p>先依次启动 output、filter的插件，然后是一些heka自己的初始化，router.initMatchSlices、启动diagnostic trackers、config.router.Start，然后在启动input相关的插件。插件的启动，即调用插件的Start即Run方法。
插件都正常启动运行后，heka主线程就是等待退出信号，当有退出信号时，按照启动相反的顺序，停止 input、decode、filter、output、encode，即调用stop()方法。</p>

<h2 id="section-3">数据的传递</h2>

<p>该过程中，消息又是如何从 input一步步的传递到output中的呢？是什么要的机制保证heka能有如此高的传递速度的呢？</p>

<p>在 《go语言编程》中有实现管道的一段简单例子，</p>

<pre><code>type PipeData struct {
    value int
    handler func(int) int
    next chan int
}

func handle(queue chan *PipeData) {
    for data := range queue {
        data.next &lt;- data.handler(data.value)
    }
}
</code></pre>

<p>其基本逻辑也就是，在入口端接收到消息，做相应的处理后，写入到对应的下一个channel中。有了这样的基础知识，我们来看 <code>config.router.Start()</code> (pipeline/router.go)，有这样的一段实现</p>

<pre><code>select {
    case ...
    ...

        case pack, ok = &lt;-self.inChan:
            if !ok {
                break
            }
            pack.diagnostics.Reset()
            atomic.AddInt64(&amp;self.processMessageCount, 1)
            for _, matcher = range self.fMatchers {
                if matcher != nil {
                    atomic.AddInt32(&amp;pack.RefCount, 1)
                    matcher.inChan &lt;- pack
                }
            }
            for _, matcher = range self.oMatchers {
                if matcher != nil {
                    atomic.AddInt32(&amp;pack.RefCount, 1)
                    matcher.inChan &lt;- pack
                }
            }
            pack.Recycle()
        }
...
</code></pre>

<p>也就是，当自己inChan中有数据到达的时候，会和matcher做判断，匹配的情况下，就会将数据传到matcher的 inChan 中，这样就将数据依次传递下去了。</p>

<p>还有个细节处，<code>outputRunner</code>的Starter函数中</p>

<pre><code>if foRunner.matcher != nil {
    sampleDenom := globals.SampleDenominator
    foRunner.matcher.Start(foRunner.inChan, sampleDenom) 
} 
</code></pre>

<p>也就是，outputå自己的inChann交给对应的matcher，而router中，就是通过matcher将pack传递到outputRunner中的。</p>

<p>input的消息又是如何传到router的inChan中的呢，好好研究了一番，原来是input的数据会通过decode，传到router中，
看<code>dRunner</code>的Starter方法，有</p>

<pre><code>...
for _, p := range packs {
h.PipelineConfig().router.InChan() &lt;- p
...
</code></pre>

<p>在配置inputRunner中可能会看不到decode，实际是在inputRunner内部实现了。</p>

<p>在Encode和Decode中，使用的是指针的方式在函数间传递的，效率会比较高。</p>

<p>至于input插件的数据怎么来，output的数据怎么输出，就是插件按照自己的需求实现了。</p>

    </div>
</div>



    
        <div class="comment">
    
    <!-- duoshuo -->
    
    <div class="ds-thread" data-thread-key="/2015/12/02/heka源码阅读" data-title="Heka源码阅读" data-url="http://jgj1986.github.io/2015/12/02/heka%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB.html"></div>
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-woshifengzi"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.unstable.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    

    
    <!-- disqus -->
    
    
    
</div>

    



                    </div>
                    <div class="col-md-3" id="main-right">
                        <div>
    <h4><strong>文章分类</strong></h4>
    <hr class="small-margin colored-hr" />
    <ul class="side-cat-ul">
        
        <li><a href="/categories.html#cat-生活随记" title="生活随记">生活随记 (3)</a></li>
        
        <li><a href="/categories.html#cat-bigdata" title="bigdata">bigdata (9)</a></li>
        
        <li><a href="/categories.html#cat-web" title="web">web (9)</a></li>
        
        <li><a href="/categories.html#cat-database" title="database">database (3)</a></li>
        
        <li><a href="/categories.html#cat-linux" title="linux">linux (10)</a></li>
        
        <li><a href="/categories.html#cat-go" title="go">go (8)</a></li>
        
        <li><a href="/categories.html#cat-运维" title="运维">运维 (3)</a></li>
        
        <li><a href="/categories.html#cat-language" title="language">language (7)</a></li>
        
        <li><a href="/categories.html#cat-tools" title="tools">tools (1)</a></li>
        
        <li><a href="/categories.html#cat-iot" title="iot">iot (5)</a></li>
        
    </ul>
</div>

<hr class="small-margin colored-hr" />

<!-- google adsense -->
<!--
<div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
        style="display:inline-block;width:300px;height:600px"
        data-ad-client="ca-pub-1339945837472110"
        data-ad-slot="8220828081"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>
-->


                    </div>
                </div>
            </div>

            <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <hr class="colored-hr" />

                <p class="text-center">
                Copyright 2014 - 2016 | Gen time&#58; 2016-04-12 01:51:47 CST

                <!-- cnzz -->
                

                </p>


            </div>
        </div>
    </div>
    <div style="display:none;" class="back-to" id="toolBackTop">
        <a title="返回顶部" onclick="window.scrollTo(0,0);return false;" href="#top" class="back-top">返回顶部</a>
    </div>

    <!-- google analytics -->
    


</div>

    </body>
</html>
