<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="jgj" />
        <meta name="viewport" content="width=device-width" /> 
        <title>Mqtt基础 | 我是疯子</title>
        
        <meta name="keywords" content="" />
        

        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- bootstrap source -->
        <!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <!-- 可选的Bootstrap主题文件（一般不用引入） -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
        <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
        <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
        <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
        <script src="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="/asset/css/kissdata.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <link href="/feed.html" rel="alternate" title="jgj" type="application/atom+xml" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="icon" href="/favicon.ico" />

        <style type="text/css">
            body {
                padding-top: 55px;
                padding-bottom: 30px;
                background-color: #EEE;
            }
        </style>

        <link rel="stylesheet" href="/asset/js/google-code-prettify/prettify.css">
        <script src="/asset/js/google-code-prettify/prettify.js"></script>

        <script type="text/javascript">
            $(document).ready(function () {

                // go to top
                var bt = $('#toolBackTop'); var sw = $(document.body)[0].clientWidth; var limitsw = (sw - 840) / 2 - 80; if (limitsw > 0){ limitsw = parseInt(limitsw); bt.css("right",limitsw); } $(window).scroll(function() { var st = $(window).scrollTop(); if(st > 30){ bt.show(); }else{ bt.hide(); } });

                // google-code-prettify
                $("pre").addClass("prettyprint linenums"); prettyPrint();

            })
        </script>

        <!-- kp747 
        
        -->
    </head>
    <body>
            <div id="header">
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand normal-a" href="javascript:void(0)" onclick="javascript:void(0)">
                    <span id="site_name">我是疯子</span>
                </a>
            </div>

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/categories.html">分类</a></li>
                    <li><a href="/guestbook.html">留言</a></li>
                    <li><a href="/about.html">关于</a></li>
                    <li><a href="/feed.html">RSS</a></li>
                    <li><a href="javascript:void(0)" class="normal-a" onclick="javascript:void(0)"><span id="site_description">在此停留片刻，偶有所得！</span></a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>


            <div class="container">
                <div class="row">
                    <div class="col-md-9" id="main-left">
                        <div class="page">
    <div class="head">
        <div class="title">Mqtt基础</div>
        <div class="date">date: 2015-11-25</div>
    </div>
    <hr class="middle-margin" />


    <!-- google adsense -->
    <!--
    <div>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
            style="display:inline-block;width:728px;height:90px"
            data-ad-client="ca-pub-1339945837472110"
            data-ad-slot="9657522081"></ins>
        <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
    </div>
    <hr class="middle-margin" />
    -->

    <div class="content">
        <ul id="markdown-toc">
  <li><a href="#mqtt">MQTT的介绍</a></li>
  <li><a href="#section">发布&amp;订阅</a></li>
  <li><a href="#clientbroker-">Client&amp;Broker 以及连接的建立</a></li>
  <li><a href="#mqttpubsub--unsub">MQTT的Pub,Sub &amp; UnSub</a></li>
  <li><a href="#topic-">Topic 及最佳实践</a></li>
  <li><a href="#qos">QOS</a></li>
  <li><a href="#persistent-session-and-queuing-messages">Persistent Session and Queuing Messages</a></li>
  <li><a href="#section-1">保留消息</a></li>
  <li><a href="#lastwill">LastWill</a></li>
  <li><a href="#section-2">保持连接和客户端接管</a></li>
  <li><a href="#section-3">总结</a></li>
</ul>

<blockquote>
  <p>今天北京风大天冷 :-)  本文是对HiveMQ上<a href="http://www.hivemq.com/blog/mqtt-essentials/" target="_blank">MQTT基础要点系列文章</a>的阅读笔记。过程中有一些疑惑地方，但是还没有及时的实践。</p>
</blockquote>

<h2 id="mqtt">MQTT的介绍</h2>

<p>轻量、开源、简单等，特点，以及历史、版本等 :-)</p>

<h2 id="section">发布&amp;订阅</h2>

<p><a href="http://www.hivemq.com/blog/mqtt-essentials-part2-publish-subscribe" target="_blank">原文</a>。</p>

<p>pub、sub的模式实现空间、实践、同步上的解耦，从而具有很好的可扩展性；对于消息，支持基于对象、内容、类型的过滤；与消息队列是不同的，后者被消费前会一直保存，且消息只能被一个客户取的，队列名称要事先创建好。</p>

<p>问题：对于后面说到的内容、类型的消息过滤，应该实际的使用体验下。</p>

<h2 id="clientbroker-">Client&amp;Broker 以及连接的建立</h2>

<p><a href="http://www.hivemq.com/blog/mqtt-essentials-part-3-client-broker-connection-establishment" target="_blank">原文</a>。</p>

<p>Client&amp;Broker的基本功能，值得一提的是，broker还要有监控订阅功能。MQTT的连接，底层是基于TCP/IP协议的，该过程中client对发送一个 <code>CONNECT</code>的消息，收到一个<code>CONNACK</code>的响应消息。</p>

<p>CONNECT Message</p>

<pre><code>contains:   Example
clientId    "client-1"
cleanSession    true 
username    "jgj"       (optional)
password    "nopassword"    (optional)
lastTopic   "/jgj/will" (optional)
lastWillQos 2       (optional)
lastWillMessage "unexpected exit" (optional)
keepAlive   60
</code></pre>

<p>clientId 用来标识客户端，所用同一个clientId被两次使用的时候，第二次的会将第一次的给覆盖。<br />
新了解的是 <code>Clean Session</code>，对应设置后续章节中的 <code>persistent session</code>。<br />
<code>lastWillXX</code>的相关信息，会在 <code>Last Will</code> 章节中有具体的说明。</p>

<p>CONNACK Message</p>

<pre><code>contains:   Example
sessionPresent  false
returnCode  0
</code></pre>

<p>不同的结果会在returnCode中表现出来。</p>

<h2 id="mqttpubsub--unsub">MQTT的Pub,Sub &amp; UnSub</h2>

<p><a href="http://www.hivemq.com/blog/mqtt-essentials-part-4-mqtt-publish-subscribe-unsubscribe" target="_blank">原文</a>。</p>

<p>PUBLISH
    packetId    4314
    topicName   “topic/1”
    qos     1
    retainFlag  false
    payload     “blabla”
    dupFlag     false</p>

<p>介绍pub/sub的一些基本过程、请求时的包，值得一提的是：Publish包中包含字段 retainFlag，在后面章节 retainedMessage专门介绍。还有个字段 packetId，当qos为0时，取值多为0，其他情况，不知道是不是会按照一定的规则生成一个。sub时，请求发送<code>SUBSCRIBE</code>信息，返回<code>SUBACK</code>信息；取消订阅 unsub时，发送<code>UNSUBSCRIBE</code>信息，返回<code>UNSUBACK</code>信息。</p>

<h2 id="topic-">Topic 及最佳实践</h2>

<p><a href="http://www.hivemq.com/blog/mqtt-essentials-part-5-mqtt-topics-best-practices" target="_blank">原文</a>。</p>

<p>Topic最好名称数字和字码，中间可以用 <code>/</code> 来分隔，开头不要是 <code>/</code>。支持统配符， <code>+</code> 只匹配单个字段，<code>#</code> 可以匹配多个，如下</p>

<pre><code>myhome/groudfloor/+/temperatur
myhome/groudfloor/liveroom/temperatur  # 匹配
myhome/liveroom/temperatur         # 不匹配
myhome/groudfloor/liveroom/fridge/temperatur  # 不匹配

myhome/groudfloor/#
myhome/groudfloor/temperature   # 匹配
myhome/groudfloor/livingroom/temperature # 匹配
myhome/firstfloor/temperatur    # 不匹配
</code></pre>

<p>按照约定，以<code>$</code>符号开头的Topic一般会认为是特殊的topic，为Broker内部统计所保留的。虽然没有明确的规定，但是参考MQTT GutHub wiki上的建议，一般会有这样的一些例子</p>

<pre><code>$SYS/broker/clients/connected
$SYS/broker/clients/disconnected
$SYS/broker/clients/total
$SYS/broker/messages/sent
$SYS/broker/uptime
</code></pre>

<p>最后对Topic的命名有一些建议，</p>

<p>. 不要以<code>/</code> 开头 <br />
. 不要用空格 <br />
. 命名简洁<br />
. Ascii字符，避免使用特殊字符<br />
. 包含clientid或唯一标识符  </p>

<h2 id="qos">QOS</h2>

<p><a href="http://www.hivemq.com/blog/mqtt-essentials-part-6-mqtt-quality-of-service-levels" target="_blank">原文</a>。</p>

<p>QOS: Quality of Service。 
. 0:最多一次，请求之后就结束了<br />
. 1:最少一次，请求后存储message，等待返回消息PUBACK用于确认；若一定时间内没有收到，则再次发送<br />
. 2:只有一次，sender pub消息后，broker返回<code>PUBREC</code>；sender收到返回收再次发送<code>PUBREL</code>，broker会保留消息知道返回<code>PUBCOMP</code>   </p>

<p>qos2安全但是比较慢。</p>

<p>疑问： 如果使用QOS1或者2，publish消息后，broker收到了，但是没有订阅者，那发布者分别会有怎样的情况。</p>

<h2 id="persistent-session-and-queuing-messages">Persistent Session and Queuing Messages</h2>

<p><a href="http://www.hivemq.com/blog/mqtt-essentials-part-6-mqtt-quality-of-service-levels" target="_blank">原文</a>。</p>

<p>标题应该怎么翻译呢，持续的回话和队列，大体就是这个意思了。这个是干什么用的呢，就是会有这样的一些场景，当新的订阅者连到Topic，或者是重新连接到Topic后，以前的消息还想按照顺序都得到。
如何设置呢，在前面介绍已经提到，连接的建立时通过字段 cleanSession 来设置，而且连接连接时的返回字段中也会告知是否是 persistent 的session。</p>

<p>以后用到了，在对这个地方好好说明。</p>

<h2 id="section-1">保留消息</h2>

<p><a href="http://www.hivemq.com/blog/mqtt-essentials-part-8-retained-messages" target="_blank">原文</a>。</p>

<p>应用的场景：当新的client端连接到topic时，不知道当前的状态是怎么样，如果发布者很久不发布新的状态，那新client就要一直等着或设置为不合理的默认状态。使用RetainedMessage，会保留最后的状态，新的client连接上之后，就会有最新的状态了。</p>

<p>如果设置呢？上面提到，Publish的时候，通过retainFlag字段来设置。</p>

<h2 id="lastwill">LastWill</h2>

<p><a href="http://www.hivemq.com/blog/mqtt-essentials-part-9-last-will-and-testament" target="_blank">原文</a>。</p>

<p>应用的场景：当一些连接不优雅的断掉后，其他保持连接的订阅客户端也要收到信息，从而有相应的处理。<br />
设置：在建立连接时，通过LastWillTopic、LastWillQos、LastWillMessage字段来设置，而且多和retainedMessage一起使用。 </p>

<p>注意：是pub不优雅的断掉，订阅端收到信息。而如果是优雅的断开，保存的信息会丢弃。</p>

<p>问题: LastWillTopic和Client用到的Topic是不是同一个Topic，还是所有的LastWillTopic使用同一个？</p>

<h2 id="section-2">保持连接和客户端接管</h2>

<p><a href="http://www.hivemq.com/blog/mqtt-essentials-part-10-alive-client-take-over" target="_blank">原文</a>。</p>

<p>保持连接的必要性，流程：请求 PINGREQ，返回 PINGRESP；规定时间的3/2 时间内断开。</p>

<p>如果在client端连接断开，请求重连，而broker的之前的连接还没有断开，那么broker会关闭之前的连接到现在的新连接。</p>

<h2 id="section-3">总结</h2>

<p>这系列的文章对深入一些了解mqtt的基础、用户有非常好的帮助。应该多看看原文。</p>


    </div>
</div>



    
        <div class="comment">
    
    <!-- duoshuo -->
    
    <div class="ds-thread" data-thread-key="/2015/11/25/mqtt基础" data-title="Mqtt基础" data-url="http://jgj1986.github.io/2015/11/25/mqtt%E5%9F%BA%E7%A1%80.html"></div>
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-woshifengzi"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.unstable.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    

    
    <!-- disqus -->
    
    
    
</div>

    



                    </div>
                    <div class="col-md-3" id="main-right">
                        <div>
    <h4><strong>文章分类</strong></h4>
    <hr class="small-margin colored-hr" />
    <ul class="side-cat-ul">
        
        <li><a href="/categories.html#cat-生活随记" title="生活随记">生活随记 (3)</a></li>
        
        <li><a href="/categories.html#cat-bigdata" title="bigdata">bigdata (9)</a></li>
        
        <li><a href="/categories.html#cat-web" title="web">web (9)</a></li>
        
        <li><a href="/categories.html#cat-database" title="database">database (3)</a></li>
        
        <li><a href="/categories.html#cat-linux" title="linux">linux (10)</a></li>
        
        <li><a href="/categories.html#cat-go" title="go">go (8)</a></li>
        
        <li><a href="/categories.html#cat-运维" title="运维">运维 (3)</a></li>
        
        <li><a href="/categories.html#cat-language" title="language">language (7)</a></li>
        
        <li><a href="/categories.html#cat-tools" title="tools">tools (1)</a></li>
        
        <li><a href="/categories.html#cat-iot" title="iot">iot (5)</a></li>
        
    </ul>
</div>

<hr class="small-margin colored-hr" />

<!-- google adsense -->
<!--
<div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
        style="display:inline-block;width:300px;height:600px"
        data-ad-client="ca-pub-1339945837472110"
        data-ad-slot="8220828081"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>
-->


                    </div>
                </div>
            </div>

            <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <hr class="colored-hr" />

                <p class="text-center">
                Copyright 2014 - 2016 | Gen time&#58; 2016-04-12 01:51:47 CST

                <!-- cnzz -->
                

                </p>


            </div>
        </div>
    </div>
    <div style="display:none;" class="back-to" id="toolBackTop">
        <a title="返回顶部" onclick="window.scrollTo(0,0);return false;" href="#top" class="back-top">返回顶部</a>
    </div>

    <!-- google analytics -->
    


</div>

    </body>
</html>
