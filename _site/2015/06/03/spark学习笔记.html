<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="jgj" />
        <meta name="viewport" content="width=device-width" /> 
        <title>Spark学习笔记 | 我是疯子</title>
        
        <meta name="keywords" content="" />
        

        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- bootstrap source -->
        <!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <!-- 可选的Bootstrap主题文件（一般不用引入） -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
        <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
        <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
        <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
        <script src="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="/asset/css/kissdata.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <link href="/feed.html" rel="alternate" title="jgj" type="application/atom+xml" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="icon" href="/favicon.ico" />

        <style type="text/css">
            body {
                padding-top: 55px;
                padding-bottom: 30px;
                background-color: #EEE;
            }
        </style>

        <link rel="stylesheet" href="/asset/js/google-code-prettify/prettify.css">
        <script src="/asset/js/google-code-prettify/prettify.js"></script>

        <script type="text/javascript">
            $(document).ready(function () {

                // go to top
                var bt = $('#toolBackTop'); var sw = $(document.body)[0].clientWidth; var limitsw = (sw - 840) / 2 - 80; if (limitsw > 0){ limitsw = parseInt(limitsw); bt.css("right",limitsw); } $(window).scroll(function() { var st = $(window).scrollTop(); if(st > 30){ bt.show(); }else{ bt.hide(); } });

                // google-code-prettify
                $("pre").addClass("prettyprint linenums"); prettyPrint();

            })
        </script>

        <!-- kp747 
        
        -->
    </head>
    <body>
            <div id="header">
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand normal-a" href="javascript:void(0)" onclick="javascript:void(0)">
                    <span id="site_name">我是疯子</span>
                </a>
            </div>

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/categories.html">分类</a></li>
                    <li><a href="/guestbook.html">留言</a></li>
                    <li><a href="/about.html">关于</a></li>
                    <li><a href="/feed.html">RSS</a></li>
                    <li><a href="javascript:void(0)" class="normal-a" onclick="javascript:void(0)"><span id="site_description">在此停留片刻，偶有所得！</span></a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>


            <div class="container">
                <div class="row">
                    <div class="col-md-9" id="main-left">
                        <div class="page">
    <div class="head">
        <div class="title">Spark学习笔记</div>
        <div class="date">date: 2015-06-03</div>
    </div>
    <hr class="middle-margin" />


    <!-- google adsense -->
    <!--
    <div>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
            style="display:inline-block;width:728px;height:90px"
            data-ad-client="ca-pub-1339945837472110"
            data-ad-slot="9657522081"></ins>
        <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
    </div>
    <hr class="middle-margin" />
    -->

    <div class="content">
        <ul id="markdown-toc">
  <li><a href="#section">配置</a></li>
  <li><a href="#sparksqljson">sparksql操作json文件</a></li>
  <li><a href="#section-1">结果存放</a></li>
  <li><a href="#section-2">提交任务</a></li>
</ul>

<h3 id="section">配置</h3>

<p><a href="http://spark.apache.org/docs/latest/index.html" target="_blank">spark 1.3的官网</a>上介绍了spark集群的几种方式：
Amazon EC2<br />
Standalone Deploy mode<br />
Apache Mesos<br />
Hadoop YARN<br />
因为平时都在使用hadoop，在测试时为了更好的了解安装部署的情况，就使用yarn的方式。</p>

<p>spark有两种运行的方式，一种是提交任务到master，spark管理任务的执行(使用命令spark-submit)；还有一种就是在客户端交互的方式运行，使用命令(spark-sell或pyspark，其中pyspark是python专用的)</p>

<p>关于spark的配置，可以在启动时通过命令的方式传递，如</p>

<pre><code>./bin/spark-submit --name "My app" --master local[4] --conf spark.shuffle.spill=false     --conf "spark.executor.extraJavaOptions=-XX:+PrintGCDetails -XX:+PrintGCTimeStamps" myApp.jar
</code></pre>

<p>如果没有这种动态的配置，spark会使用 conf/spark-defaults.conf配置文件中的内容<br />
配置情况如：</p>

<pre><code>spark.master                     spark://172.16.101.13:7077
spark.eventLog.enabled           true
spark.eventLog.dir               hdfs://hadoop-master:9000/tmp/spark_events
spark.serializer                 org.apache.spark.serializer.KryoSerializer
spark.driver.memory              1g
spark.executor.extraJavaOptions  -XX:+PrintGCDetails -Dkey=value
</code></pre>

<p>网上有关于该文件的说明，这里只是说明 spark.eventLog.dir配置，后面的域名和hadoop的core-site.xml中的<code>fs.default.name</code>的value一致。<br />
有了该配置文件后，直接启动 pyspark 时，在最后会有输出：</p>

<pre><code>SparkContext available as sc, HiveContext available as sqlCtx
</code></pre>

<p>这种情况下，我们使用使用变量<code>sc</code>就可以了。本人在测试时，如果再次试图初始化(sc=SparkContext())会报错 <code>ValueError: Cannot run multiple SparkContexts at once</code></p>

<h3 id="sparksqljson">sparksql操作json文件</h3>

<p>spark使用DATAFrame，其来源可以是存在的rdd、hive表、数据源。最简单而轻言，json格式的文件就可以直接使用。总的来看，支持的比较好. 
参考<a href="http://spark.apache.org/docs/latest/sql-programming-guide.html" target="_blank">Spark SQL and DataFrame Guide</a>和<a href="http://www.cstor.cn/textdetail_8471.html" target="_blank">http://www.cstor.cn/textdetail_8471.html</a>。<br />
假设我有push上传的json格式日志，每一行都如下：</p>

<pre><code>{"event_id":1,"body":{"brand":"samsung","imsi":"454197000461112","dvid":"45yuifghjmd","cc":"HK","osv":"5.0","dtn":"SM-N9005","sr":"1920,1080","mac":"48:5A:3F:23:09:E1","platform":"android","net":"wifi"}}
</code></pre>

<p>该日志文件已经存放在hdfs的/mjyun/txt/push_json.log。</p>

<pre><code>pyspark
&gt;&gt;&gt; from pyspark.sql import SQLContext
&gt;&gt;&gt; sqlContext = SQLContext(sc)
&gt;&gt;&gt; df = sqlContext.jsonFile("/mjyun/txt/push_json.log")
&gt;&gt;&gt; df.select("event_id").show()
&gt;&gt;&gt; df.select("body.brand").show()  #json嵌套
</code></pre>

<p>求活跃设备数，即对dvid的去重数。</p>

<pre><code>pyspark
&gt;&gt;&gt; from pyspark.sql import SQLContext
&gt;&gt;&gt; sqlContext = SQLContext(sc)
&gt;&gt;&gt; event = sqlContext.jsonFile("/mjyun/txt/push_json.log")
&gt;&gt;&gt; event.registerTempTable("event")
&gt;&gt;&gt; cnt = sqlContext.sql("select count(distinct body.dvid) from event")
&gt;&gt;&gt; for value in cnt.collect():
...     print value
...
    Row(c0=964)
</code></pre>

<p>如果包含多个文件呢？在引入文件的时候，使用逗号隔开，直接包含多个文件即可，如下：</p>

<pre><code>&gt;&gt;&gt;  df = sqlContext.jsonFile("/mjyun/txt/push_json.log,/mjyun/txt/push2.json")
</code></pre>

<h3 id="section-1">结果存放</h3>

<p>假设要计算新增设备数，则需要将以前出现过的设备都做存储，然后将本次的设备和之前出现的设备做比较。这里的第一步就需要先保存结果！
如上面的文件加载到了内存后</p>

<pre><code>&gt;&gt;&gt; df.select("body.dvid","body.net").save("/mjyun/mid/devNet.parquet") 
或者(支持 json, parquet, jdbc)
&gt;&gt;&gt; df.select("body.dvid","body.net").save("/mjyun/mid/devNet.json","json")
重新加载
&gt;&gt;&gt; newdf = sqlContext.load("/mjyun/mid/devNet.json","json")
</code></pre>

<p>无锁非原子性，所以可能就会有错误。而在存储的时候，为了有更好的性能，采用分区方式存放(类似于hive分区)。<br />
例如在我们的应用的可以是 /mjyun/txt/appid=1222/ym=201506/day=02/<br />
支持数据的合并  </p>

<h3 id="section-2">提交任务</h3>

<pre><code>$ cat new_dev.py 
from pyspark import SQLContext, SparkContext, SparkConf
conf = SparkConf().setAppName("testNewDevCnt").setMaster("spark://172.16.101.13:7077")
sc = SparkContext(conf=conf)
sqlContext = SQLContext(sc)

df = sqlContext.jsonFile("/mjyun/txt/push2.json")
df.select("body.ckid").save("appDevVer.parquet")
sc.stop()

$ spark-submit ./new_dev.py 
</code></pre>

    </div>
</div>



    
        <div class="comment">
    
    <!-- duoshuo -->
    
    <div class="ds-thread" data-thread-key="/2015/06/03/spark学习笔记" data-title="Spark学习笔记" data-url="http://jgj1986.github.io/2015/06/03/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"></div>
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-woshifengzi"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.unstable.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    

    
    <!-- disqus -->
    
    
    
</div>

    



                    </div>
                    <div class="col-md-3" id="main-right">
                        <div>
    <h4><strong>文章分类</strong></h4>
    <hr class="small-margin colored-hr" />
    <ul class="side-cat-ul">
        
        <li><a href="/categories.html#cat-生活随记" title="生活随记">生活随记 (3)</a></li>
        
        <li><a href="/categories.html#cat-bigdata" title="bigdata">bigdata (9)</a></li>
        
        <li><a href="/categories.html#cat-web" title="web">web (9)</a></li>
        
        <li><a href="/categories.html#cat-database" title="database">database (3)</a></li>
        
        <li><a href="/categories.html#cat-linux" title="linux">linux (10)</a></li>
        
        <li><a href="/categories.html#cat-go" title="go">go (8)</a></li>
        
        <li><a href="/categories.html#cat-运维" title="运维">运维 (3)</a></li>
        
        <li><a href="/categories.html#cat-language" title="language">language (7)</a></li>
        
        <li><a href="/categories.html#cat-tools" title="tools">tools (1)</a></li>
        
        <li><a href="/categories.html#cat-iot" title="iot">iot (5)</a></li>
        
    </ul>
</div>

<hr class="small-margin colored-hr" />

<!-- google adsense -->
<!--
<div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
        style="display:inline-block;width:300px;height:600px"
        data-ad-client="ca-pub-1339945837472110"
        data-ad-slot="8220828081"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>
-->


                    </div>
                </div>
            </div>

            <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <hr class="colored-hr" />

                <p class="text-center">
                Copyright 2014 - 2016 | Gen time&#58; 2016-04-12 01:51:47 CST

                <!-- cnzz -->
                

                </p>


            </div>
        </div>
    </div>
    <div style="display:none;" class="back-to" id="toolBackTop">
        <a title="返回顶部" onclick="window.scrollTo(0,0);return false;" href="#top" class="back-top">返回顶部</a>
    </div>

    <!-- google analytics -->
    


</div>

    </body>
</html>
