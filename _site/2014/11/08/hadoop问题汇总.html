<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="jgj" />
        <meta name="viewport" content="width=device-width" /> 
        <title>Hadoop问题汇总 | 我是疯子</title>
        
        <meta name="keywords" content="" />
        

        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- bootstrap source -->
        <!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <!-- 可选的Bootstrap主题文件（一般不用引入） -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
        <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
        <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
        <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
        <script src="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="/asset/css/kissdata.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <link href="/feed.html" rel="alternate" title="jgj" type="application/atom+xml" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="icon" href="/favicon.ico" />

        <style type="text/css">
            body {
                padding-top: 55px;
                padding-bottom: 30px;
                background-color: #EEE;
            }
        </style>

        <link rel="stylesheet" href="/asset/js/google-code-prettify/prettify.css">
        <script src="/asset/js/google-code-prettify/prettify.js"></script>

        <script type="text/javascript">
            $(document).ready(function () {

                // go to top
                var bt = $('#toolBackTop'); var sw = $(document.body)[0].clientWidth; var limitsw = (sw - 840) / 2 - 80; if (limitsw > 0){ limitsw = parseInt(limitsw); bt.css("right",limitsw); } $(window).scroll(function() { var st = $(window).scrollTop(); if(st > 30){ bt.show(); }else{ bt.hide(); } });

                // google-code-prettify
                $("pre").addClass("prettyprint linenums"); prettyPrint();

            })
        </script>

        <!-- kp747 
        
        -->
    </head>
    <body>
            <div id="header">
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand normal-a" href="javascript:void(0)" onclick="javascript:void(0)">
                    <span id="site_name">我是疯子</span>
                </a>
            </div>

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/categories.html">分类</a></li>
                    <li><a href="/guestbook.html">留言</a></li>
                    <li><a href="/about.html">关于</a></li>
                    <li><a href="/feed.html">RSS</a></li>
                    <li><a href="javascript:void(0)" class="normal-a" onclick="javascript:void(0)"><span id="site_description">在此停留片刻，偶有所得！</span></a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>


            <div class="container">
                <div class="row">
                    <div class="col-md-9" id="main-left">
                        <div class="page">
    <div class="head">
        <div class="title">Hadoop问题汇总</div>
        <div class="date">date: 2014-11-08</div>
    </div>
    <hr class="middle-margin" />


    <!-- google adsense -->
    <!--
    <div>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
            style="display:inline-block;width:728px;height:90px"
            data-ad-client="ca-pub-1339945837472110"
            data-ad-slot="9657522081"></ins>
        <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
    </div>
    <hr class="middle-margin" />
    -->

    <div class="content">
        <ul id="markdown-toc">
  <li><a href="#map100reduce">map执行100%，reduce任务不执行</a></li>
  <li><a href="#reduce255">reduce返回255</a></li>
  <li><a href="#mapreduce">mapreduce用法</a></li>
  <li><a href="#hive">hive连接数据库</a></li>
</ul>

<p>hadoop 使用过程中遇到的问题汇总（版本2.2） </p>

<h3 id="map100reduce">map执行100%，reduce任务不执行</h3>
<ul>
  <li>
    <p>定位  </p>

    <p><code>yarn-work-resourcemanage-host-151.log</code>日志文件一直在输出： </p>

    <pre><code>  capacity.LeafQueue (LeafQueue.java:assignToQueue(946)) - default usedResources: &lt;memory:2048, vCores:1&gt; clusterResources: &lt;memory:4096, vCores:2&gt; currentCapacity 0.5 required &lt;memory:4096, vCores:1&gt; potentialNewCapacity: 1.5 (  max-capacity: 1.0)
</code></pre>
  </li>
  <li>
    <p>处理  </p>

    <p><code> yarn-site.xml </code>中<code> yarn.nodemanager.resource.memory-mb </code>设置为了<code> 4096 </code>, 如果改为2048的话，则map也不执行了。查看执行mapreduce的任务，有个启动参数 ` -D ‘mapred.job.reduce.memory.mb=’4096’’  `，将其改为2048则就可以执行了。</p>
  </li>
  <li>
    <p>分析<br />
ok，可以看到在hadoop的配置中，特别是关于分配的内存大小有很多的选项，这么多的选项都是做什么的，在什么地方使用呢。 </p>
  </li>
</ul>

<h3 id="reduce255">reduce返回255</h3>

<ul>
  <li>定位</li>
</ul>

<p>运行mapreduce时，出现如下的错误：</p>

<pre><code>14/11/22 14:45:02 INFO mapreduce.Job:  map 100% reduce 0%
14/11/22 14:45:10 INFO mapreduce.Job: Task Id : attempt_1406010920358_60903_r_000000_0, Status : FAILED
Error: java.lang.RuntimeException: PipeMapRed.waitOutputThreads(): subprocess failed with code 255
    at org.apache.hadoop.streaming.PipeMapRed.waitOutputThreads(PipeMapRed.java:320)
    at org.apache.hadoop.streaming.PipeMapRed.mapRedFinished(PipeMapRed.java:533)
    at org.apache.hadoop.streaming.PipeReducer.close(PipeReducer.java:134)
    at org.apache.hadoop.io.IOUtils.cleanup(IOUtils.java:237)
    at org.apache.hadoop.mapred.ReduceTask.runOldReducer(ReduceTask.java:477)
    at org.apache.hadoop.mapred.ReduceTask.run(ReduceTask.java:408)
    at org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:162)
    at java.security.AccessController.doPrivileged(Native Method)
    at javax.security.auth.Subject.doAs(Subject.java:415)
    at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1491)
    at org.apache.hadoop.mapred.YarnChild.main(YarnChild.java:157)
</code></pre>

<p>搜索<code>failed with code 255</code>，得到信息是reduce运行错误，返回 <code>-1</code> 。看hadoop的reduce的日志，发现时解析应用列表文件出错。</p>

<p>注：hadoop的mapreduce历史记录通过mapreduce接口网站查看，进到每个任务的<code>logs</code>中，不只是看 <code>Note</code> 的内容。如果不是通过网页，而是直接在机器上看日志，或者hadoop上的文件，目前还没有找到在什么地方存放！</p>

<ul>
  <li>处理</li>
</ul>

<p>发现时解析应用列表的json文件出错，而实际上这个文件的json内容是正确的，解析不应该出错。启动mapreduce的时候，配置项如下：</p>

<pre><code>-file $DIR_ROOT/conf/app.conf \
... ...
-cmdenv APP_CONFIG="$DIR_ROOT/conf/app.conf" \
</code></pre>

<p>经咨询，原来是 -cmdenv指定使用哪个文件是，已经用file指定路径和名称了，就不需要在指定路径了，所以做如下修改即可了</p>

<pre><code>-file $DIR_ROOT/conf/app.conf \
... ...
-cmdenv APP_CONFIG="app.conf" \
</code></pre>

<h3 id="mapreduce">mapreduce用法</h3>

<p>翻阅版本2.5.2的 <a href="http://hadoop.apache.org/docs/stable/hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html">MapReduce Tutorial</a>{_target=”_blank”}，记录一些之前没有注意的知识点。</p>

<ul>
  <li>
    <p>设定符号名</p>

    <p>bin/hadoop jar hadoop-mapreduce-examples-<ver>.jar wordcount -files dir1/dict.txt#dict1,dir2/dict.txt#dict2 -archives mytar.tgz#tgzdir input output</ver></p>
  </li>
</ul>

<p>符号名dict1代指/dir1/dict，dict2代指/dir2/dict，tgzdir代指mytar.tgz；使用-files指定了多个文件。</p>

<ul>
  <li>阐述处理流程</li>
</ul>

<p>文档中有提供了一个字数统计的例子，并简要说明了处理的流程。以前就知道 map结果给reduce，reduce做统计。其中有几个更细节的地方：<br />
1、map处理输入文件，生成中间结果，即每个&lt;wordx,1&gt;<br />
2、接下来就由mapreduce的框架，根据key来分类、排序，将排序后的结果给reduce。分组，则一个key下，就可能有多个map的中间结果，即&lt;key, (list of values)&gt;<br />
3、map可以有多个，多个合并到一起有需要排序，这个由reduce来做，必要的情况下还会有两个排序<br />
4、map可以多个，reduce也可以多个  </p>

<pre><code>All intermediate values associated with a given output key are subsequently grouped by the framework, and passed to the Reducer(s) to determine the final output. Users can control the grouping by specifying a Comparator via Job.setGroupingComparatorClass(Class).
The Mapper outputs are sorted and then partitioned per Reducer. The total number of partitions is the same as the number of reduce tasks for the job. Users can control which keys (and hence records) go to which Reducer by implementing a custom Partitioner.
</code></pre>

<ul>
  <li>启动的map、reduce数</li>
</ul>

<p>默认情况下，启动map数由输入文件块决定，即文件块的个数。比如，输入文件是10TB，块大小是128M，则整个过程要启动82,000个maps（如果配置中没有限定MRJobConfig.NUM_MAPS）。</p>

<p>比较好的reduce的个数： 0.95 or 1.75 multiplied by (<no. of="" nodes=""> * <no. of="" maximum="" containers="" per="" node="">)</no.></no.></p>

<p>我们在实际使用的时候，好像没有这么配置，而是根据预估的任务量和node数配置了。</p>

<h3 id="hive">hive连接数据库</h3>

<p>在运行一个hive命令的时候，提示连接Mysql的数据库有问题，但是在代码中没有要连接mysql数据库的地方。
原来hive配置文件<code>hive-site.xml</code>中设定的 </p>

<pre><code>&lt;property&gt;
    &lt;name&gt;hive.stats.dbconnectionstring&lt;/name&gt;
    &lt;value&gt;jdbc:mysql://192.168.1.127:3606/hive_db?createDatabaseIfNotExist=true&lt;/value&gt;
    &lt;description&gt;The default connection string for the database that stores temporary Hive statistics.&lt;/description&gt;
&lt;/property&gt;

&lt;property&gt;
    &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;
    &lt;value&gt;pwd123456&lt;/value&gt;
    &lt;description&gt;password to use against metastore database&lt;/description&gt;
&lt;/property&gt;
</code></pre>


    </div>
</div>



    
        <div class="comment">
    
    <!-- duoshuo -->
    
    <div class="ds-thread" data-thread-key="/2014/11/08/hadoop问题汇总" data-title="Hadoop问题汇总" data-url="http://jgj1986.github.io/2014/11/08/hadoop%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB.html"></div>
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-woshifengzi"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.unstable.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    

    
    <!-- disqus -->
    
    
    
</div>

    



                    </div>
                    <div class="col-md-3" id="main-right">
                        <div>
    <h4><strong>文章分类</strong></h4>
    <hr class="small-margin colored-hr" />
    <ul class="side-cat-ul">
        
        <li><a href="/categories.html#cat-生活随记" title="生活随记">生活随记 (3)</a></li>
        
        <li><a href="/categories.html#cat-bigdata" title="bigdata">bigdata (9)</a></li>
        
        <li><a href="/categories.html#cat-web" title="web">web (9)</a></li>
        
        <li><a href="/categories.html#cat-database" title="database">database (3)</a></li>
        
        <li><a href="/categories.html#cat-linux" title="linux">linux (10)</a></li>
        
        <li><a href="/categories.html#cat-go" title="go">go (8)</a></li>
        
        <li><a href="/categories.html#cat-运维" title="运维">运维 (3)</a></li>
        
        <li><a href="/categories.html#cat-language" title="language">language (7)</a></li>
        
        <li><a href="/categories.html#cat-tools" title="tools">tools (1)</a></li>
        
        <li><a href="/categories.html#cat-iot" title="iot">iot (5)</a></li>
        
    </ul>
</div>

<hr class="small-margin colored-hr" />

<!-- google adsense -->
<!--
<div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
        style="display:inline-block;width:300px;height:600px"
        data-ad-client="ca-pub-1339945837472110"
        data-ad-slot="8220828081"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>
-->


                    </div>
                </div>
            </div>

            <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <hr class="colored-hr" />

                <p class="text-center">
                Copyright 2014 - 2016 | Gen time&#58; 2016-04-12 01:51:47 CST

                <!-- cnzz -->
                

                </p>


            </div>
        </div>
    </div>
    <div style="display:none;" class="back-to" id="toolBackTop">
        <a title="返回顶部" onclick="window.scrollTo(0,0);return false;" href="#top" class="back-top">返回顶部</a>
    </div>

    <!-- google analytics -->
    


</div>

    </body>
</html>
