<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="jgj" />
        <meta name="viewport" content="width=device-width" /> 
        <title>Nginx安装与配置 | 我是疯子</title>
        
        <meta name="keywords" content="" />
        

        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- bootstrap source -->
        <!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <!-- 可选的Bootstrap主题文件（一般不用引入） -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
        <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
        <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
        <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
        <script src="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="/asset/css/kissdata.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <link href="/feed.html" rel="alternate" title="jgj" type="application/atom+xml" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="icon" href="/favicon.ico" />

        <style type="text/css">
            body {
                padding-top: 55px;
                padding-bottom: 30px;
                background-color: #EEE;
            }
        </style>

        <link rel="stylesheet" href="/asset/js/google-code-prettify/prettify.css">
        <script src="/asset/js/google-code-prettify/prettify.js"></script>

        <script type="text/javascript">
            $(document).ready(function () {

                // go to top
                var bt = $('#toolBackTop'); var sw = $(document.body)[0].clientWidth; var limitsw = (sw - 840) / 2 - 80; if (limitsw > 0){ limitsw = parseInt(limitsw); bt.css("right",limitsw); } $(window).scroll(function() { var st = $(window).scrollTop(); if(st > 30){ bt.show(); }else{ bt.hide(); } });

                // google-code-prettify
                $("pre").addClass("prettyprint linenums"); prettyPrint();

            })
        </script>

        <!-- kp747 
        
        -->
    </head>
    <body>
            <div id="header">
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand normal-a" href="javascript:void(0)" onclick="javascript:void(0)">
                    <span id="site_name">我是疯子</span>
                </a>
            </div>

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/categories.html">分类</a></li>
                    <li><a href="/guestbook.html">留言</a></li>
                    <li><a href="/about.html">关于</a></li>
                    <li><a href="/feed.html">RSS</a></li>
                    <li><a href="javascript:void(0)" class="normal-a" onclick="javascript:void(0)"><span id="site_description">在此停留片刻，偶有所得！</span></a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>


            <div class="container">
                <div class="row">
                    <div class="col-md-9" id="main-left">
                        <div class="page">
    <div class="head">
        <div class="title">Nginx安装与配置</div>
        <div class="date">date: 2014-11-07</div>
    </div>
    <hr class="middle-margin" />


    <!-- google adsense -->
    <!--
    <div>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
            style="display:inline-block;width:728px;height:90px"
            data-ad-client="ca-pub-1339945837472110"
            data-ad-slot="9657522081"></ins>
        <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
    </div>
    <hr class="middle-margin" />
    -->

    <div class="content">
        <ul id="markdown-toc">
  <li><a href="#section">安装</a></li>
  <li><a href="#section-1">配置</a>    <ul>
      <li><a href="#section-2">配置文件说明</a></li>
      <li><a href="#lua">与lua结合</a></li>
      <li><a href="#section-3">初始化</a></li>
      <li><a href="#section-4">修改不重启生效</a></li>
      <li><a href="#nginx">nginx负载均衡</a></li>
      <li><a href="#nginx-1">nginx备份</a></li>
    </ul>
  </li>
</ul>

<blockquote>
  <p><a href="http://nginx.org/">nginx</a>也火了很久了，最近因为实际的需求，要使用nginx，也就好好的了解下。  </p>
</blockquote>

<h2 id="section">安装</h2>

<p>总的来说，安装还是比较简单的  </p>

<pre><code>$ wget http://nginx.org/download/nginx-1.6.2.tar.gz
$ tar zxf nginx-1.6.2.tar.gz &amp;&amp; cd nginx-1.6.2
# ./configure &amp;&amp; make &amp;&amp; make install 
</code></pre>

<p>或者只用用Linux发行版提供的软件包安装即可  </p>

<pre><code>$ audo aptitude install nginx
</code></pre>

<p>但是默认的nginx会少一些库，比如我们想将和lua结合使用，默认情况可能下就没有。为此，我们在编译的时候使用 –add-module 的参数来添加我们需要的这些模块。
比较详细的说明，nginx的<a href="http://wiki.nginx.org/Modules">wiki</a>上有对所有模块的说明。这里只是我只是列出来，我需要的几个模块。
在一个新安装的ubuntu系统上可能缺少一些文件包，这里也一并列出:  </p>

<pre><code>$ sudo install lua5.1 liblua5.1-dev  liblua5.1-socket2 liblua5.1-json
$ sudo aptitude install libpcre++-dev libpcre++0
$ sudo aptitude install libcurl-ssl-dev libssl-dev  libssl1.0.0
$ sudo aptitude install zip libzip-dev
$ ./configure --prefix=/opt/nginx --add-module=/home/work/nginx/lua-nginx-module-0.9.8 --with-http_ssl_module --with-http_addition_module --add-module=/home/work/nginx/ngx_devel_kit-0.2.19 --add-module=/home/work/nginx/redis2-nginx-module-0.11 --add-module=/home/work/nginx/set-misc-nginx-module-0.26
# make &amp;&amp; make install
</code></pre>

<p>想用lua访问redis，还需要lua正对redis的插件，参考nginx的<a href="http://wiki.nginx.org/LuaRedisParser">wiki</a>。这个过程简略如下：  </p>

<pre><code>$ cd lua-redis-parser-0.10
$ export LUA_INCLUDE_DIR=/usr/include/lua5.1
$ make CC=gcc
$ sudo make install CC=gcc
</code></pre>

<p>这样所需要的安装过程就完成了，剩下的就是配置方面的事情了。在做配置前，我们可以先用nginx默认的配置文件启动服务感受下：  </p>

<pre><code>$ cd /opt/nginx
$ sudo ./sbin/nginx -c /opt/install/conf/nginx.conf
</code></pre>

<p>当配置文件更新后，想让配置文件生效，则重新做加载配置文件：  </p>

<pre><code>$ sudo ./sbin/nginx -s reload  
</code></pre>

<p>执行 <code>-s reload</code> 后，没有提示错误信息，但是修改的内容不生效，这时候看下nginx的error日志能看到出错的地方。  </p>

<p>这样安装需要在编译时就指定好要使用什么模块，以后需要添加的模块或lua库也可以通过 <code>lua_package_path "/path/to/*.lua;;";</code>的方式使用。
可以参考<a href="http://blog.kissdata.com/2014/11/14/nginx-lua-install.html" target="_blank">nginx与lua安装教程</a>。</p>

<h2 id="section-1">配置</h2>

<h3 id="section-2">配置文件说明</h3>

<p>刚安装好的服务也会提供一份简单的配置文件，nginx.conf。此处先记录下对配置文件的一些认识：  </p>

<ul>
  <li>通大多数的配置问价一样，也是 以”#” 来做注释的 </li>
  <li>自己用到的配置文件提供events与http，样例中有关于mail等的配置，目前没有用到 </li>
  <li>在http中提供server，server中配置域名等信息，通过这个域名（dns或hosts识别）即可访问这个server所提供的服务 </li>
  <li>http中配置反向映射，负载均衡等。关于nginx和lvs负载均衡，应在出篇博客 </li>
  <li>配置文件可以拆成多个文件，用 include /path/to/*.conf 引用即可 </li>
</ul>

<p>更加详细的信息，网上有很多，这里列上<a href="http://www.cnblogs.com/xiaogangqq123/archive/2011/03/02/1969006.html">一</a>、
<a href="http://kingj.iteye.com/blog/1420187">两</a>个，如果将来需要去上查看，就不在浪费篇章。
官网<a href="http://wiki.nginx.org/Configuration">wiki</a>上有更加详细的说明。  </p>

<h3 id="lua">与lua结合</h3>

<p>先提供一个简单配置:  </p>

<pre><code>user www-data;
worker_processes  1;
events {
    worker_connections  1024;
}
http {
  include       mime.types;
    default_type  application/octet-stream;
    keepalive_timeout  65;
    server {
    listen       80;
        server_name  test.fengzi.com;

        root /data/html/test;
        index  index.html index.htm;

        location /lua {
        content_by_lua_file /data/nginx_lua_files/lua.lua;
        }
    }
}

cat lua.lua
#!/usr/bin/env lua
ngx.header.content_type = "text/html; charset=utf8"
ngx.print("hello fengzi")
ngx.say("fengzi say hello ")  
</code></pre>

<p>在/etc/hosts中配置好 127.0.0.1   test.fengzi.com，则就可以在浏览器中访问 test.fengzi.com/lua 了。  </p>

<h3 id="section-3">初始化</h3>

<pre><code>http{
    ...
    init_by_lua_file /home/work/web/access_init.lua;
    lua_shared_dict access_add_1_dict 1M;
    ...
}
</code></pre>

<p>第一个是用lua文件中代码做初始化，第二个是设置一个变量。这个两处设置都是设置为全局的变量，常驻内存，可在lua代码中直接使用 :) 。 详细信息请参考博客：<a href="http://blog.csdn.net/weiyuefei/article/details/38487475" target="_blank">ngx_lua模块中的共享内存字典项API</a> 。 </p>

<h3 id="section-4">修改不重启生效</h3>

<pre><code>location = /test {
    lua_code_cache off;
    ... ...
}
</code></pre>

<p>这个会影响nginx的性能，但是在开发机上如此配置，可以提高开发效率。如果添加或修改了一些.so之类的库文件还是要重启的</p>

<h3 id="nginx">nginx负载均衡</h3>

<p>此处提供个简单配置例子：  </p>

<pre><code>http {
 ...
    upstream webservers {
        server 192.168.1.201 weight=1 max_fails=2 fail_timeout=2;
        server 192.168.1.202 weight=1 max_fails=2 fail_timeout=2;
        #server 127.0.0.1:8080 backup;
    }
    server {
        listen       80;
        server_name  localhost;
        #charset koi8-r;
        #access_log  logs/host.access.log  main;
        location / {
            proxy_pass      http://webservers;
            proxy_set_header  X-Real-IP  $remote_addr;
        }
    }
}
</code></pre>

<p>陈明乾在其博客 <a href="http://freeloda.blog.51cto.com/2033581/1288553">Nginx 反向代理、负载均衡、页面缓存、URL重写及读写分离详解</a>中以实践的形式给出的详细的说明，解释。可多看几次  </p>

<h3 id="nginx-1">nginx备份</h3>
<p>nginx和Keepalive可以实现双机热备份，现在还都是在测试环境下，还没有做实践，先记录着，以后配置时有什么问题再记录。查阅到两篇博客
<a href="https://www.centos.bz/2012/02/nginx-keepalived-high-availability/" target="_blank">nginx+keepalived实现双机热备的高可用</a>，
<a href="http://www.2cto.com/os/201109/106387.html" target="_blank">nginx主主集群</a> 。
前一篇博客是创建一个双机热备份的过程，介绍的比较详细，后一篇则是，让nginx 的master-backup也做到负载均衡。对两篇文章的说明实现 。</p>


    </div>
</div>



    
        <div class="comment">
    
    <!-- duoshuo -->
    
    <div class="ds-thread" data-thread-key="/2014/11/07/nginx安装与配置" data-title="Nginx安装与配置" data-url="http://jgj1986.github.io/2014/11/07/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE.html"></div>
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-woshifengzi"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.unstable.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    

    
    <!-- disqus -->
    
    
    
</div>

    



                    </div>
                    <div class="col-md-3" id="main-right">
                        <div>
    <h4><strong>文章分类</strong></h4>
    <hr class="small-margin colored-hr" />
    <ul class="side-cat-ul">
        
        <li><a href="/categories.html#cat-生活随记" title="生活随记">生活随记 (3)</a></li>
        
        <li><a href="/categories.html#cat-bigdata" title="bigdata">bigdata (9)</a></li>
        
        <li><a href="/categories.html#cat-web" title="web">web (9)</a></li>
        
        <li><a href="/categories.html#cat-database" title="database">database (3)</a></li>
        
        <li><a href="/categories.html#cat-linux" title="linux">linux (10)</a></li>
        
        <li><a href="/categories.html#cat-go" title="go">go (8)</a></li>
        
        <li><a href="/categories.html#cat-运维" title="运维">运维 (3)</a></li>
        
        <li><a href="/categories.html#cat-language" title="language">language (7)</a></li>
        
        <li><a href="/categories.html#cat-tools" title="tools">tools (1)</a></li>
        
        <li><a href="/categories.html#cat-iot" title="iot">iot (5)</a></li>
        
    </ul>
</div>

<hr class="small-margin colored-hr" />

<!-- google adsense -->
<!--
<div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
        style="display:inline-block;width:300px;height:600px"
        data-ad-client="ca-pub-1339945837472110"
        data-ad-slot="8220828081"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>
-->


                    </div>
                </div>
            </div>

            <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <hr class="colored-hr" />

                <p class="text-center">
                Copyright 2014 - 2016 | Gen time&#58; 2016-04-12 01:51:47 CST

                <!-- cnzz -->
                

                </p>


            </div>
        </div>
    </div>
    <div style="display:none;" class="back-to" id="toolBackTop">
        <a title="返回顶部" onclick="window.scrollTo(0,0);return false;" href="#top" class="back-top">返回顶部</a>
    </div>

    <!-- google analytics -->
    


</div>

    </body>
</html>
