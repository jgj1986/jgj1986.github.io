<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="jgj" />
        <meta name="viewport" content="width=device-width" /> 
        <title>Lua学习 | 我是疯子</title>
        
        <meta name="keywords" content="" />
        

        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- bootstrap source -->
        <!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <!-- 可选的Bootstrap主题文件（一般不用引入） -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
        <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
        <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
        <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
        <script src="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="/asset/css/kissdata.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <link href="/feed.html" rel="alternate" title="jgj" type="application/atom+xml" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="icon" href="/favicon.ico" />

        <style type="text/css">
            body {
                padding-top: 55px;
                padding-bottom: 30px;
                background-color: #EEE;
            }
        </style>

        <link rel="stylesheet" href="/asset/js/google-code-prettify/prettify.css">
        <script src="/asset/js/google-code-prettify/prettify.js"></script>

        <script type="text/javascript">
            $(document).ready(function () {

                // go to top
                var bt = $('#toolBackTop'); var sw = $(document.body)[0].clientWidth; var limitsw = (sw - 840) / 2 - 80; if (limitsw > 0){ limitsw = parseInt(limitsw); bt.css("right",limitsw); } $(window).scroll(function() { var st = $(window).scrollTop(); if(st > 30){ bt.show(); }else{ bt.hide(); } });

                // google-code-prettify
                $("pre").addClass("prettyprint linenums"); prettyPrint();

            })
        </script>

        <!-- kp747 
        
        -->
    </head>
    <body>
            <div id="header">
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand normal-a" href="javascript:void(0)" onclick="javascript:void(0)">
                    <span id="site_name">我是疯子</span>
                </a>
            </div>

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/categories.html">分类</a></li>
                    <li><a href="/guestbook.html">留言</a></li>
                    <li><a href="/about.html">关于</a></li>
                    <li><a href="/feed.html">RSS</a></li>
                    <li><a href="javascript:void(0)" class="normal-a" onclick="javascript:void(0)"><span id="site_description">在此停留片刻，偶有所得！</span></a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>


            <div class="container">
                <div class="row">
                    <div class="col-md-9" id="main-left">
                        <div class="page">
    <div class="head">
        <div class="title">Lua学习</div>
        <div class="date">date: 2014-11-11</div>
    </div>
    <hr class="middle-margin" />


    <!-- google adsense -->
    <!--
    <div>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
            style="display:inline-block;width:728px;height:90px"
            data-ad-client="ca-pub-1339945837472110"
            data-ad-slot="9657522081"></ins>
        <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
    </div>
    <hr class="middle-margin" />
    -->

    <div class="content">
        <ul id="markdown-toc">
  <li><a href="#section">入门</a></li>
  <li><a href="#section-1">类功能</a>    <ul>
      <li><a href="#section-2">缘起</a></li>
      <li><a href="#section-3">基础</a></li>
      <li><a href="#section-4">实现</a></li>
    </ul>
  </li>
  <li><a href="#ngxlua">ngx_lua共享内存字典项</a>    <ul>
      <li><a href="#section-5">配置</a></li>
      <li><a href="#section-6">使用</a></li>
    </ul>
  </li>
  <li><a href="#cjson-">cjson 使用</a>    <ul>
      <li><a href="#section-7">缘起</a></li>
      <li><a href="#section-8">安装</a></li>
      <li><a href="#section-9">使用</a></li>
    </ul>
  </li>
  <li><a href="#memcache">操作memcache</a>    <ul>
      <li><a href="#section-10">安装与配置</a></li>
      <li><a href="#section-11">使用</a></li>
      <li><a href="#section-12">优化</a></li>
    </ul>
  </li>
</ul>

<p>lua 使用</p>

<blockquote>
  <p>现在做的项目，要提供一些小的http接口，负责与redis交互，日志文件的落地等。从配置、修改的简易上，决定使用ngix+lua，这个过程有幸接触到lua编程。里面的一些探索过程记录在此。关于nginx的安装配置，参考 <a href="http://blog.woshifengzi.com/2014/11/07/nginx-install-conf.html" target="_blank">nginx install conf</a>。</p>
</blockquote>

<h2 id="section">入门</h2>

<p>网上关于lua的基本句法的介绍，很多都是对官网简介的翻译，可以很快在宏观上有个了解， 相比较而言<a href="http://www.lua.org/pil/" target="_blank">Progmming in Lua</a>介绍的就比较详细，觉得理解起来不顺畅，也可阅读<a href="http://wenku.baidu.com/link?url=nQcs7NfWfo0l_3L9lNT2aqAHTL2VrUgBdxCSQ4c8VlShzmfQSHs-H0Reje1gOutUtLRjBGCwr1XlEQEo4Dqj-3zWyPE0HSg6W__F0FeZaku" target="_blank">中文版</a>。</p>

<h2 id="section-1">类功能</h2>

<h3 id="section-2">缘起</h3>

<p>为实现日志落地，开发了一个初始化的类文件，有文件的打开、关闭，而打开的文件句柄设计为全局变量，这样在实际的操作函数中可直接使用该句柄，并能在特定情形下（下一小时），调用文件关闭函数将此文件关闭掉。当只落一种日志，每小时生成一个文件时，该设计比较没有问题。
可后来为了实现系统的监控功能，也设计实现个监控接口，将收到信息落地，此种情况下完全拷贝一份上面的代码也可以，但是代码重复了，比较丑陋。
为此，考虑使用常见的类，将需要的变量、函数放在类中，调用类的对象来实现。</p>

<h3 id="section-3">基础</h3>

<p>参考网上资料，使用了lua的元表功能。对于元表的连接，参考了 <a href="http://blog.csdn.net/xocoder/article/details/9028347" target="_blank">寰子的博客</a>。
引用如下， Lua查找一个表元素时的规则，其实就是如下3个步骤:</p>

<p>1.在表中查找，如果找到，返回该元素，找不到则继续
2.判断该表是否有元表，如果没有元表，返回nil，有元表则继续
3.判断元表有没有__index方法，如果__index方法为nil，则返回nil；如果__index方法是一个表，则重复1、2、3；如果__index方法是一个函数，则返回该函数的返回值</p>

<p>而元表和所谓是__index 是如何使用的呢？</p>

<pre><code>tableA.__index = tableA -- 把tableA的__index方法指向自己
setmetatable(tableB, tableA)   --把B的metatable设置为A
</code></pre>

<h3 id="section-4">实现</h3>

<p>基于此，一个简单的lua类，就可以如博客 <a href="http://blog.csdn.net/losophy/article/details/20311387" target="_blank">lua学习：lua中“类”的实现</a></p>

<pre><code>A = {x=0,y=0}  
--这句是重定义元表的索引，必须要有，  
A.__index = A   
  
--模拟构造体，一般名称为new()  
function A:new(x,y)  
    local self = {}    
    setmetatable(self, A)   --必须要有  
    self.x = x    
    self.y = y   
    return self    
end    
function A:test()  
print(self.x,self.y)  
end  
  
objA = A:new(1,2)  
objA:test()  
print(objA.x,objA.y)
</code></pre>

<h2 id="ngxlua">ngx_lua共享内存字典项</h2>

<h3 id="section-5">配置</h3>

<pre><code>http {
    ... 
    lua_shared_dict monitor_dict 1M;
    ...
}
</code></pre>

<p>这样就定义了个字典项 access_dict，分配的内存大小为1M。</p>

<h3 id="section-6">使用</h3>

<p>博客 <a href="http://blog.csdn.net/weiyuefei/article/details/38487475" target="_blank">ngx_lua模块中的共享内存字典项API</a> 中列了很多字典项的接口，以及使用说明。目前自己的代码中只用到了add 和 delete，具体如下：</p>

<pre><code>-- 首先是使用这个共享内存
local shared_dict = ngx.shared.monitor_dict
local rotate_key = "monitor_log"
while true do
    if cur_hour_level == monitor_log.hour then
        break
    else
        -- 这儿使用共享内存达到锁的目的
        -- 想shard_dict中天剑一个标识，1标示里面只能有一个这个的标识，10，标识当超过10s后没有成功就返回
        local ok, err = shared_dict:add(rotate_key, 1, 10)
        if not ok then
            ngx.sleep(0.01)
        else
            if cur_hour_level &gt; monitor_log.hour then
                monitor_log:close_file()
                monitor_log:open_file()
                if access_add_1_log_fo == nil then
                    nginx_exit("OpenFile Error")
                end
                monitor_log:hour_level_update(cur_hour_level)
            end
            --- 在共享内存中删除这个标识
            shared_dict:delete(rotate_key)
            break
        end
    end
end
</code></pre>

<h2 id="cjson-">cjson 使用</h2>

<h3 id="section-7">缘起</h3>

<p>实现了一个接口，接口返回为json格式的字符串。开始时候，使用的是默认的lua-json，用 ab 做压力测试时，发现相应速度一直提升不起来，而如果不适用json，速度就可以生气了。
网上看到的nginx和lua结合时，使用都是lua-cjson，于是换成用cjson，速度会有较大的提升</p>

<h3 id="section-8">安装</h3>

<pre><code>$ wget http://www.kyne.com.au/~mark/software/download/lua-cjson-2.1.0.tar.gz
$ tar zxf lua-cjson-2.1.0.tar.gz
$ make &amp;&amp; make install
</code></pre>

<p>在ubutun 12.04上安装的时候，提示没能找到 lua.h 文件，而已经安装了 lua5.1, liblua5.1-dev。查看vim，include的路径是 /usr/local/include下，将其换成 /usr/include/lua5.1下即可了</p>

<h3 id="section-9">使用</h3>
<p>直接给出一段代码：</p>

<pre><code>local json = require("cjson")
local json_content = json.decode(ret_msg)
json_content["ret"] = false
json_content["msg"] = msg
ngx.say(json.encode(json_content))    
</code></pre>

<p>生成带有嵌套逻辑的json</p>

<pre><code>local data = {}
data["area"] = area
data["sex"] = sex
data["birthday"] = birthday
local ret = {}
ret["statsus"] = 0
ret["msg"] = ""
ret["data"] = data      ---result as  "data": {"area":"", ...}
local cjson = require "cjson"
ngx.say(cjson.encode(ret)) 
</code></pre>

<h2 id="memcache">操作memcache</h2>

<h3 id="section-10">安装与配置</h3>

<p>假设已经有可以直接使用的memcache服务了(192.168.1.135:11211) ，此处只是对lua-resty-memcached的使用说明</p>

<pre><code>$ git clone https://github.com/openresty/lua-resty-memcached.git
$ cat ngx.conf
http {
     ...
    lua_package_path "/path/to/lua-resty-memcached/lib/resty/?.lua;;";  
    #
    server {
    ...
    }
}
</code></pre>

<h3 id="section-11">使用</h3>

<p>一个尝试通lua-resty-memcached访问memcache的简单例子</p>

<pre><code>ngx.header.content_type = 'text/html; charset=utf-8';
local memcached = require("memcached")
--此处尝试用require("resty.memcached")，失败。应该在在上面的配置中，路径已经到了 ?.lua
local memc, err = memcached:new()
if not memc then
    ngx.say("failed to instantiate memc: ", err)
    ngx.exit(701)
end

local ok, err = memc:connect("192.168.1.135", 11211)
if not ok then
    ngx.say("failed to connect mem", err)
    ngx.exit(701)
end

local res, flags, err = memc:get("key1")
if err then
    ngx.say("failed to get key1")
    ngx.exit(701)
end

ngx.say(res)
</code></pre>

<p><a href="https://github.com/openresty/lua-resty-memcached" target="_blank">agentzh的git</a>上提供了更加详细的命令说明</p>

<h3 id="section-12">优化</h3>

<p>将创建memcached、mem的连接放在这一个lua的文件中，每次有请求到来，nginx都要去创建memcache，建立连接，使用 ab 做压力测试的时候，发现性能比较低。
做优化，将memc的初始化和与memcache的连接放在 ngx的初始化文件中。实际请求时，直接调用memc:get()方法。做压力测试，在理想的性能要求内。</p>


    </div>
</div>



    
        <div class="comment">
    
    <!-- duoshuo -->
    
    <div class="ds-thread" data-thread-key="/2014/11/11/lua学习" data-title="Lua学习" data-url="http://jgj1986.github.io/2014/11/11/lua%E5%AD%A6%E4%B9%A0.html"></div>
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-woshifengzi"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.unstable.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    

    
    <!-- disqus -->
    
    
    
</div>

    



                    </div>
                    <div class="col-md-3" id="main-right">
                        <div>
    <h4><strong>文章分类</strong></h4>
    <hr class="small-margin colored-hr" />
    <ul class="side-cat-ul">
        
        <li><a href="/categories.html#cat-生活随记" title="生活随记">生活随记 (3)</a></li>
        
        <li><a href="/categories.html#cat-bigdata" title="bigdata">bigdata (9)</a></li>
        
        <li><a href="/categories.html#cat-web" title="web">web (9)</a></li>
        
        <li><a href="/categories.html#cat-database" title="database">database (3)</a></li>
        
        <li><a href="/categories.html#cat-linux" title="linux">linux (10)</a></li>
        
        <li><a href="/categories.html#cat-go" title="go">go (8)</a></li>
        
        <li><a href="/categories.html#cat-运维" title="运维">运维 (3)</a></li>
        
        <li><a href="/categories.html#cat-language" title="language">language (7)</a></li>
        
        <li><a href="/categories.html#cat-tools" title="tools">tools (1)</a></li>
        
        <li><a href="/categories.html#cat-iot" title="iot">iot (5)</a></li>
        
    </ul>
</div>

<hr class="small-margin colored-hr" />

<!-- google adsense -->
<!--
<div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
        style="display:inline-block;width:300px;height:600px"
        data-ad-client="ca-pub-1339945837472110"
        data-ad-slot="8220828081"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>
-->


                    </div>
                </div>
            </div>

            <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <hr class="colored-hr" />

                <p class="text-center">
                Copyright 2014 - 2016 | Gen time&#58; 2016-04-12 01:51:47 CST

                <!-- cnzz -->
                

                </p>


            </div>
        </div>
    </div>
    <div style="display:none;" class="back-to" id="toolBackTop">
        <a title="返回顶部" onclick="window.scrollTo(0,0);return false;" href="#top" class="back-top">返回顶部</a>
    </div>

    <!-- google analytics -->
    


</div>

    </body>
</html>
