<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="jgj" />
        <meta name="viewport" content="width=device-width" /> 
        <title>Mongodb集群安装 | 我是疯子</title>
        
        <meta name="keywords" content="" />
        

        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- bootstrap source -->
        <!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <!-- 可选的Bootstrap主题文件（一般不用引入） -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
        <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
        <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
        <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
        <script src="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="/asset/css/kissdata.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <link href="/feed.html" rel="alternate" title="jgj" type="application/atom+xml" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="icon" href="/favicon.ico" />

        <style type="text/css">
            body {
                padding-top: 55px;
                padding-bottom: 30px;
                background-color: #EEE;
            }
        </style>

        <link rel="stylesheet" href="/asset/js/google-code-prettify/prettify.css">
        <script src="/asset/js/google-code-prettify/prettify.js"></script>

        <script type="text/javascript">
            $(document).ready(function () {

                // go to top
                var bt = $('#toolBackTop'); var sw = $(document.body)[0].clientWidth; var limitsw = (sw - 840) / 2 - 80; if (limitsw > 0){ limitsw = parseInt(limitsw); bt.css("right",limitsw); } $(window).scroll(function() { var st = $(window).scrollTop(); if(st > 30){ bt.show(); }else{ bt.hide(); } });

                // google-code-prettify
                $("pre").addClass("prettyprint linenums"); prettyPrint();

            })
        </script>

        <!-- kp747 
        
        -->
    </head>
    <body>
            <div id="header">
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand normal-a" href="javascript:void(0)" onclick="javascript:void(0)">
                    <span id="site_name">我是疯子</span>
                </a>
            </div>

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/categories.html">分类</a></li>
                    <li><a href="/guestbook.html">留言</a></li>
                    <li><a href="/about.html">关于</a></li>
                    <li><a href="/feed.html">RSS</a></li>
                    <li><a href="javascript:void(0)" class="normal-a" onclick="javascript:void(0)"><span id="site_description">在此停留片刻，偶有所得！</span></a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>


            <div class="container">
                <div class="row">
                    <div class="col-md-9" id="main-left">
                        <div class="page">
    <div class="head">
        <div class="title">Mongodb集群安装</div>
        <div class="date">date: 2014-10-28</div>
    </div>
    <hr class="middle-margin" />


    <!-- google adsense -->
    <!--
    <div>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
            style="display:inline-block;width:728px;height:90px"
            data-ad-client="ca-pub-1339945837472110"
            data-ad-slot="9657522081"></ins>
        <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
    </div>
    <hr class="middle-margin" />
    -->

    <div class="content">
        <ul id="markdown-toc">
  <li><a href="#mongodb--">mongodb 集群 安装</a>    <ul>
      <li><a href="#section">说明</a></li>
      <li><a href="#replica-set">replica set</a></li>
      <li><a href="#sharding">sharding</a></li>
    </ul>
  </li>
</ul>

<h2 id="mongodb--">mongodb 集群 安装</h2>

<h3 id="section">说明</h3>
<blockquote>
  <p>使用机器<br />
192.168.1.159<br />
192.168.1.171<br />
192.168.1.189   </p>
</blockquote>

<p>准备工作
1、下载文件 </p>

<pre><code>$ wget http://downloads.mongodb.org/linux/mongodb-linux-x86_64-2.6.5.tgz  
$ tar xzf mongodb-linux-x86_64-2.6.5.tgz 
</code></pre>

<p>2、创建相应的目录<br />
3、保证磁盘空间在4G以上   </p>

<pre><code>$ mkdir ~/mongodb/data  
$ ./bin/mongod --dbpath /home/work/mongodb/data/ --replSet repset  
3379MB available in /home/work/mongodb/data/journal or use --smallfiles  
</code></pre>

<p>考虑到操作的简单，演示中操作尽可能的时候配置文件实现      </p>

<hr />

<h3 id="replica-set">replica set</h3>
<blockquote>

  <p>master: 192.168.159:27017<br />
slaver:  192.168.171:27017 <br />
arbiter: 192.168.189:27017  </p>
</blockquote>

<p><strong>master (192.168.1.159)</strong>  </p>

<pre><code>#master.conf    
dbpath=/home/work/mongodb/data/master  
logpath=/home/work/mongodb/log/master.log   
pidfilepath=/home/work/mongodb/master.pid  
directoryperdb=true  
logappend=true  
replSet=testrs  
bind_ip=192.168.1.159  
port=27017  
oplogSize=10000  
fork=true  
noprealloc=true
</code></pre>

<p>在有足够空间的前提下：  </p>

<pre><code>$ ./bin/mongod -f master.conf   
note: noprealloc may hurt performance in many applications  
about to fork child process, waiting until server is ready for connections.  
forked process: 25120  
child process started successfully, parent exiting  
</code></pre>

<p><strong>slaver (192.168.1.171)</strong>  </p>

<pre><code>#slaver.conf    
dbpath=/home/work/mongodb/data/slaver   
logpath=/home/work/mongodb/log/slaver.log   
pidfilepath=/home/work/mongodb/slaver.pid   
directoryperdb=true   
logappend=true   
replSet=testrs   
bind_ip=192.168.1.171  
port=27017   
oplogSize=3000    
fork=true   
noprealloc=true  
</code></pre>

<p>在有足够空间的前提下：  </p>

<pre><code>$ ./mongodb-linux-x86_64-2.6.5/bin/mongod -f ./slaver.conf   
note: noprealloc may hurt performance in many applications  
about to fork child process, waiting until server is ready for connections.  
forked process: 10126  
child process started successfully, parent exiting  
</code></pre>

<p><strong>arbiter (192.168.1.189)</strong>  </p>

<pre><code>#arbiter.conf    
dbpath=/home/work/mongodb/data/arbiter    
logpath=/home/work/mongodb/log/arbiter.log    
pidfilepath=/home/work/mongodb/arbiter.pid    
directoryperdb=true    
logappend=true    
replSet=testrs    
bind_ip=192.168.1.189  
port=27017    
oplogSize=3000    
fork=true    
noprealloc=true    
</code></pre>

<p>在有足够空间的前提下：  </p>

<pre><code>$ ./mongodb-linux-x86_64-2.6.5/bin/mongod -f arbiter.conf   
note: noprealloc may hurt performance in many applications  
about to fork child process, waiting until server is ready for connections.  
forked process: 7164  
child process started successfully, parent exiting  
</code></pre>

<p>相应的服务启动好之后，创建集群  </p>

<pre><code>./bin/mongo 192.168.1.159:27017  
&gt; use admin  
&gt; cfg={ _id:"testrs", members:[ {_id:0,host:'192.168.1.159:27017',priority:2}, {_id:1,host:'192.168.1.171:27017',priority:1},{_id:2,host:'192.168.1.189:27017',arbiterOnly:true}] };  
&gt; rs.initiate(cfg);  
{ "ok" : 0, "errmsg" : "couldn't initiate : new file allocation failure" }  
</code></pre>

<p>查看集群的状态命令  </p>

<pre><code>&gt; rs.status()  
</code></pre>

<p>此时停掉 192.168.1.159节点上的mongodb服务，在查看状态, 159的状态 “health” : 0, 171变为 primary节点    </p>

<pre><code>&gt; rs.status()  
{  
    "set" : "testrs",  
    "date" : ISODate("2014-10-28T06:26:52Z"),  
    "myState" : 1,  
    "members" : [  
            {  
                    "_id" : 0,  
                    "name" : "192.168.1.159:27017",  
                    "health" : 0,  
                    "state" : 8,  
                    "stateStr" : "(not reachable/healthy)",  
                    "uptime" : 0,  
                    "optime" : Timestamp(1414477402, 1),  
                    "optimeDate" : ISODate("2014-10-28T06:23:22Z"),  
                    "lastHeartbeat" : ISODate("2014-10-28T06:26:49Z"),  
                    "lastHeartbeatRecv" : ISODate("2014-10-28T06:26:18Z"),  
                    "pingMs" : 0  
            },  
            {  
                    "_id" : 1,  
                    "name" : "192.168.1.171:27017",  
                    "health" : 1,  
                    "state" : 1,  
                    "stateStr" : "PRIMARY",  
                    "uptime" : 325,  
                    "optime" : Timestamp(1414477402, 1),  
                    "optimeDate" : ISODate("2014-10-28T06:23:22Z"),  
                    "electionTime" : Timestamp(1414477588, 1),  
                    "electionDate" : ISODate("2014-10-28T06:26:28Z"),  
                    "self" : true  
            },  
            {  
                    "_id" : 2,  
                    "name" : "192.168.1.189:27017",  
                    "health" : 1,  
                    "state" : 7,  
                    "stateStr" : "ARBITER",  
                    "uptime" : 218,  
                    "lastHeartbeat" : ISODate("2014-10-28T06:26:50Z"),  
                    "lastHeartbeatRecv" : ISODate("2014-10-28T06:26:50Z"),  
                    "pingMs" : 7  
            }  
    ],  
    "ok" : 1  
}  
</code></pre>

<p>重启159上的mongdb，则159又为primary节点。  </p>

<p>参考博客, <a href="http://blog.csdn.net/luonanqin/article/details/8497860" target="_blank">Mongodb集群搭建的三种方式</a>   </p>

<p><strong>问题：</strong><br />
使用上面的执行过程，在服务启动的时候，有个提示：<br />
“note: noprealloc may hurt performance in many applications  “, 看下mongodb的官网说明，<br />
–noprealloc<br />
Disables the preallocation of data files. This shortens the start up time in some cases and can cause significant performance penalties during normal operations.  </p>

<hr />

<h3 id="sharding">sharding</h3>
<blockquote>
  <p>参考： <a href="http://www.cnblogs.com/magialmoon/archive/2013/04/10/3013121.html" target="_blank">集群搭建</a>，
<a href="http://www.cnblogs.com/magialmoon/archive/2013/04/11/3015394.html" target="_bland">sharding</a>，
<a href="http://www.cnblogs.com/magialmoon/archive/2013/04/12/3017387.html" target="_bland">性能与优化</a>   </p>
</blockquote>

<ul>
  <li>路由节点 Query Routers: <br />
          192.168.1.159:27017   </li>
  <li>配置节点 Config servers: <br />
          192.168.1.159:20001  192.168.1.171:20001  </li>
  <li>数据节点 shards:   <br />
          192.168.1.159:20002   192.168.1.171:20002   192.168.1.189:20002<br />
补充，官网上说明：The shard can be either a replica set or a standalone mongod instance  </li>
</ul>

<p><strong>配置节点：</strong>    </p>

<pre><code>#config.conf    
dbpath=/data1/mongodb/data/config  
logpath=/data1/mongodb/log/config.log    
pidfilepath=/home/work/mongodb/config.pid  
logappend=true    
bind_ip=192.168.1.159    
port=20001    
oplogSize=3000    
fork=true    
noprealloc=true   


$ ./mongod -f config.conf 
</code></pre>

<p><strong>路由节点：</strong>  </p>

<pre><code>$ ./mongos --configdb 192.168.1.159:20001,192.168.1.171:20001 --port 27017 --fork --logpath /data1/mongodb/log/route.log 
</code></pre>

<p>使用两个配置节点的时候，提示：   </p>

<pre><code>BadValue need either 1 or 3 configdbs  
</code></pre>

<p>为了测试的简单，选择只启动一个config  </p>

<pre><code>$./mongos --configdb 192.168.1.159:20001 --port 27017 --fork --logpath /data1/mongodb/log/route.log  
</code></pre>

<p><strong>各个shard启动</strong></p>

<pre><code>#slave.conf    
dbpath=/home/work/mongodb/data/shard  
logpath=/home/work/mongodb/log/shard.log    
pidfilepath=/home/work/mongodb/shard.pid    
bind_ip=192.168.1.189  
port=20002   
oplogSize=3000   
fork=true   
noprealloc=true  


$ numactl --interleave=all ./bin/mongod -f shard.conf  
</code></pre>

<p><strong>添加分片</strong>  </p>

<pre><code>$ ./mongodb-linux-x86_64-2.6.5/bin/mongo 192.168.1.159:27017  
&gt; use admin  
&gt; db.runCommand({addshard:"192.168.1.159:20002", allowLocal:true})  
{ "shardAdded" : "shard0000", "ok" : 1 }   
&gt; db.runCommand({addshard:"192.168.1.171:20002"})  
&gt; db.runCommand({addshard:"192.168.1.189:20002"})   
</code></pre>

<p><strong>查看状态</strong>  </p>

<pre><code>&gt; use config  
switched to db config  
&gt; db.shards.find()  
{ "_id" : "shard0000", "host" : "192.168.1.159:20002" }  
{ "_id" : "shard0001", "host" : "192.168.1.171:20002" }  
{ "_id" : "shard0002", "host" : "192.168.1.189:20002" }  
</code></pre>

<p><strong>移除shard</strong>  </p>

<pre><code>&gt; db.runCommand({removeShard: "192.168.1.189:20002"})  
{     
    "msg" : "draining started successfully",  
    "state" : "started",  
    "shard" : "shard0002",  
    "ok" : 1  
}  
&gt; db.runCommand({removeShard: "192.168.1.171:20002"})  
{ "ok" : 0, "errmsg" : "Can't have more than one draining shard at a time" }  
</code></pre>

<p>提示至少要有一个以上的shard, 移除后这个shard的状态   </p>

<pre><code>&gt; db.shards.find()  
{ "_id" : "shard0000", "host" : "192.168.1.159:20002" }  
{ "_id" : "shard0001", "host" : "192.168.1.171:20002" }  
{ "_id" : "shard0002", "host" : "192.168.1.189:20002", "draining" : true } 
</code></pre>

<p>再执行一次remove操作，  </p>

<pre><code>&gt; db.runCommand({removeShard: "192.168.1.189:20002"})  
{  
    "msg" : "removeshard completed successfully",  
    "state" : "completed",  
    "shard" : "shard0002",  
    "ok" : 1  
}  
</code></pre>

<p>如果是删除主节点的shard，则要执行”moveprimary”.   </p>

<p>网上还有中方法，是将shard的三个节点搭建 Replica Set，然后  </p>

<pre><code>sh.addShard("test/192.168.1.159:20002")  #192.168.159:20002 是master的ip和端口  
</code></pre>

<p>从性能上考虑，replica set是一个节点写，另外节点复制信息。当写操作的数据量比较大的时候，性能会偏低些。  </p>

<p><strong>数据库使用shard</strong>   </p>

<pre><code>&gt; use admin    
&gt; db.runCommand({"enablesharding":"dbname1"})  
</code></pre>


    </div>
</div>



    
        <div class="comment">
    
    <!-- duoshuo -->
    
    <div class="ds-thread" data-thread-key="/2014/10/28/mongodb集群安装" data-title="Mongodb集群安装" data-url="http://jgj1986.github.io/2014/10/28/mongodb%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85.html"></div>
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-woshifengzi"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.unstable.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    

    
    <!-- disqus -->
    
    
    
</div>

    



                    </div>
                    <div class="col-md-3" id="main-right">
                        <div>
    <h4><strong>文章分类</strong></h4>
    <hr class="small-margin colored-hr" />
    <ul class="side-cat-ul">
        
        <li><a href="/categories.html#cat-生活随记" title="生活随记">生活随记 (3)</a></li>
        
        <li><a href="/categories.html#cat-bigdata" title="bigdata">bigdata (9)</a></li>
        
        <li><a href="/categories.html#cat-web" title="web">web (9)</a></li>
        
        <li><a href="/categories.html#cat-database" title="database">database (3)</a></li>
        
        <li><a href="/categories.html#cat-linux" title="linux">linux (10)</a></li>
        
        <li><a href="/categories.html#cat-go" title="go">go (8)</a></li>
        
        <li><a href="/categories.html#cat-运维" title="运维">运维 (3)</a></li>
        
        <li><a href="/categories.html#cat-language" title="language">language (7)</a></li>
        
        <li><a href="/categories.html#cat-tools" title="tools">tools (1)</a></li>
        
        <li><a href="/categories.html#cat-iot" title="iot">iot (5)</a></li>
        
    </ul>
</div>

<hr class="small-margin colored-hr" />

<!-- google adsense -->
<!--
<div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
        style="display:inline-block;width:300px;height:600px"
        data-ad-client="ca-pub-1339945837472110"
        data-ad-slot="8220828081"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>
-->


                    </div>
                </div>
            </div>

            <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <hr class="colored-hr" />

                <p class="text-center">
                Copyright 2014 - 2016 | Gen time&#58; 2016-04-12 01:51:47 CST

                <!-- cnzz -->
                

                </p>


            </div>
        </div>
    </div>
    <div style="display:none;" class="back-to" id="toolBackTop">
        <a title="返回顶部" onclick="window.scrollTo(0,0);return false;" href="#top" class="back-top">返回顶部</a>
    </div>

    <!-- google analytics -->
    


</div>

    </body>
</html>
