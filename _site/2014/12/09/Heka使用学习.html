<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="jgj" />
        <meta name="viewport" content="width=device-width" /> 
        <title>Heka使用学习 | 我是疯子</title>
        
        <meta name="keywords" content="" />
        

        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- bootstrap source -->
        <!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <!-- 可选的Bootstrap主题文件（一般不用引入） -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
        <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
        <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
        <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
        <script src="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="/asset/css/kissdata.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <link href="/feed.html" rel="alternate" title="jgj" type="application/atom+xml" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="icon" href="/favicon.ico" />

        <style type="text/css">
            body {
                padding-top: 55px;
                padding-bottom: 30px;
                background-color: #EEE;
            }
        </style>

        <link rel="stylesheet" href="/asset/js/google-code-prettify/prettify.css">
        <script src="/asset/js/google-code-prettify/prettify.js"></script>

        <script type="text/javascript">
            $(document).ready(function () {

                // go to top
                var bt = $('#toolBackTop'); var sw = $(document.body)[0].clientWidth; var limitsw = (sw - 840) / 2 - 80; if (limitsw > 0){ limitsw = parseInt(limitsw); bt.css("right",limitsw); } $(window).scroll(function() { var st = $(window).scrollTop(); if(st > 30){ bt.show(); }else{ bt.hide(); } });

                // google-code-prettify
                $("pre").addClass("prettyprint linenums"); prettyPrint();

            })
        </script>

        <!-- kp747 
        
        -->
    </head>
    <body>
            <div id="header">
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand normal-a" href="javascript:void(0)" onclick="javascript:void(0)">
                    <span id="site_name">我是疯子</span>
                </a>
            </div>

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/categories.html">分类</a></li>
                    <li><a href="/guestbook.html">留言</a></li>
                    <li><a href="/about.html">关于</a></li>
                    <li><a href="/feed.html">RSS</a></li>
                    <li><a href="javascript:void(0)" class="normal-a" onclick="javascript:void(0)"><span id="site_description">在此停留片刻，偶有所得！</span></a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>


            <div class="container">
                <div class="row">
                    <div class="col-md-9" id="main-left">
                        <div class="page">
    <div class="head">
        <div class="title">Heka使用学习</div>
        <div class="date">date: 2014-12-09</div>
    </div>
    <hr class="middle-margin" />


    <!-- google adsense -->
    <!--
    <div>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
            style="display:inline-block;width:728px;height:90px"
            data-ad-client="ca-pub-1339945837472110"
            data-ad-slot="9657522081"></ins>
        <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
    </div>
    <hr class="middle-margin" />
    -->

    <div class="content">
        <ul id="markdown-toc">
  <li><a href="#section">简介</a>    <ul>
      <li><a href="#section-1">描述</a></li>
      <li><a href="#section-2">架构</a></li>
    </ul>
  </li>
  <li><a href="#section-3">安装</a>    <ul>
      <li><a href="#heka">安装Heka环境</a></li>
      <li><a href="#section-4">添加插件</a></li>
    </ul>
  </li>
  <li><a href="#section-5">使用</a>    <ul>
      <li><a href="#heka-1">配置heka</a></li>
      <li><a href="#section-6">运行</a></li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>统计分析时，难免有实时统计、以及日志的转移分发，crontab、scp等可以实现该功能，但是难免显得粗糙且维护比较复杂，而 Heka 可胜任此工作。当然，Heka不只是如此简单的功能。</p>
</blockquote>

<h2 id="section">简介</h2>

<p>Heka是一款拥有数据收集、分析、监视和报表的工具，Mozilla Service团队提供的开源项目，截止到现在，版本已经到 0.9.0。
<a href="https://hekad.readthedocs.org/en/latest" target="_blank">Heka的官方文档</a>有详细和权威的说明，本篇只是记录下使用过程中，觉得有所帮助的东西，能更加快速的认识Heka。</p>

<h3 id="section-1">描述</h3>
<p>Heka使用Go语言编写，内部对数据的过滤、转发等，都是采用指针形式，可支撑 10Gb/s 的消息数据（网上说法，自己没有实际测过！）。
目前heka可以支持多种格式的消息，官网上介绍的有：</p>

<pre><code>AMQP
Docker
FilePolling
Http
HttpListen
Kafka
Logstreamer
Process
ProcessDirectory
StatAccum
Statsd
Tcp
Udp
</code></pre>

<p>对于这些格式的消息，官方提供的处理方式可满足大部分的需求；若不满足需求，可以自行扩展或开发插件。关于插件的开发流程在下面章节介绍。<br />
Heka配置文件采用 <a href="https://github.com/toml-lang/toml" target="_blank">.toml 格式</a>。</p>

<h3 id="section-2">架构</h3>

<p>一般而言Heka中的数据流要经过5个过程，即</p>

<pre><code>Inputs
Decoders
Filters
Encoders
Outputs
</code></pre>

<p>从这几步的命名中，可以大体知道每步实现的功能。当然这5步不是必须都要有的，如果接受到的数据，没有加密或其他特殊格式，可以直接处理，那Decoders就不需要。
甚至，不想输出任何东西，不提供Outputs都可以，但是这样一来就没有了实际意义。<br />
PS：在Hekad实际处理时，当数据处理完成之后，要执行类似 <code>pack.Recycle()</code> 的操作，来释放所持有的空间，做资源的循环再利用。</p>

<h2 id="section-3">安装</h2>

<p>安装编译heka环境的过程还算比较简单，但是要下载一些网络库，这个过程需要翻墙，是个比较<strong>烦心</strong>的事。<br />
本文使用 <a href="https://github.com/goagent/goagent" target="_blank">goagent</a>翻墙，代理为 127.0.0.1:8087</p>

<h3 id="heka">安装Heka环境</h3>

<pre><code>$ export http_proxy="http://127.0.0.1:8087"
$ git clone https://github.com/mozilla-services/heka
$ cd heka
$ source build.sh  #这个过程会下载一些依赖库，并生成build目录
  
$ ctest &amp;&amp; make ctest  # 做编译测试
</code></pre>

<h3 id="section-4">添加插件</h3>

<p>Heka中真正强大的一点也就在于能通过插件扩展功能，支持各种需求。本篇不介绍插件如何实现，以及插件中的代码结构等问题，因为目前了解的还不够深，介绍的可能也会有偏差，只是介绍下插件如何编译与生效。 </p>

<p>假设我们要实现一个 hello_world 的插件，将插件的代码放在 <code>heka/externals/hello_world</code>目录下。有了这样的一个目录，我们在配置文件中指明。配置文件是cmake目录下 <code>plugin_loader.cmake</code>，
刚clone下来的heka，没有这个配置文件，手工创建一个。</p>

<pre><code>$ cat cmake/plugin_loader.cmake
add_external_plugin(svn https://url_to/heka_plugins/hello_world:local)
</code></pre>

<p>说明，heka的插件会先在本地找插件，如果没有，则根据url的地址去下载；url来源可以是git、svn或hg。<br />
完成插件的开发，并做好配置之后，就可以重新编译可执行文件</p>

<pre><code>$ cd heka
$ source build.sh
$ cpack
</code></pre>

<p>这样，在build目录下，就会有编译好的支持新插件的可执行文件。 </p>

<h2 id="section-5">使用</h2>

<p>上面编译好的build目录下，有压缩打包文件 <code>heka-0_9_0-linux-amd64.tar.gz</code>，里面即包含有运行所需要的二进制文件。
运行Heka时，需要提供配置文件，假设目录为 <code>conf/hekad.toml</code>。</p>

<h3 id="heka-1">配置heka</h3>
<p>heka的配置文件要设置好所需要的 Input/Decoder/Filter/Encoder/Output，（没有用的可以不配置），也提供整个heka所需要的全局的配置，此处提供一个简单的配置如下：</p>

<pre><code>[hekad]
cpuprof = "log/cpuprof.log"    #
memprof = "log/memprof.log"    # heka运行时cpu、mem出错的日志
maxprocs = 24
base_dir = "base_dir"
pid_file = "hekad.pid"

[LogstreamerInput]
log_directory = "/opt/nginx/logs"  # 指定input的来源，使用的是 LogstreamerInput 类型的插件
file_match = 'access\.log'         # 文件，注意，此处使用的是单引号

[PayloadEncoder]
append_newlines = false

[LogOutput]
message_matcher = "TRUE"
encoder = "PayloadEncoder"
</code></pre>

<p>可用<code>message_matcher</code>来设定各种的匹配规则，个人理解，他可以实现Filter的功能，而因为功能比较简单，就合并到Output中了。
更多的配置参考 <a href="https://hekad.readthedocs.org/en/latest/config/index.html" target="_blank">Configuring hekad</a>。</p>

<h3 id="section-6">运行</h3>

<p>提供配置所需要的目录，如log，base_dir, 使用命令启动</p>

<pre><code>./bin/hekad -config=./conf/hekad.toml
</code></pre>

<p>如果是使用上面的配置，heka会将 <code>/opt/nginx/logs/access.log</code> 在屏幕中输出，并且，每当access.log中增加一行，屏幕就会实时输出这么一行！</p>

<p>Heka中有提供了其他的数据流处理，可以多尝试使用。:)</p>


    </div>
</div>



    
        <div class="comment">
    
    <!-- duoshuo -->
    
    <div class="ds-thread" data-thread-key="/2014/12/09/Heka使用学习" data-title="Heka使用学习" data-url="http://jgj1986.github.io/2014/12/09/Heka%E4%BD%BF%E7%94%A8%E5%AD%A6%E4%B9%A0.html"></div>
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-woshifengzi"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.unstable.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    

    
    <!-- disqus -->
    
    
    
</div>

    



                    </div>
                    <div class="col-md-3" id="main-right">
                        <div>
    <h4><strong>文章分类</strong></h4>
    <hr class="small-margin colored-hr" />
    <ul class="side-cat-ul">
        
        <li><a href="/categories.html#cat-生活随记" title="生活随记">生活随记 (3)</a></li>
        
        <li><a href="/categories.html#cat-bigdata" title="bigdata">bigdata (9)</a></li>
        
        <li><a href="/categories.html#cat-web" title="web">web (9)</a></li>
        
        <li><a href="/categories.html#cat-database" title="database">database (3)</a></li>
        
        <li><a href="/categories.html#cat-linux" title="linux">linux (10)</a></li>
        
        <li><a href="/categories.html#cat-go" title="go">go (8)</a></li>
        
        <li><a href="/categories.html#cat-运维" title="运维">运维 (3)</a></li>
        
        <li><a href="/categories.html#cat-language" title="language">language (7)</a></li>
        
        <li><a href="/categories.html#cat-tools" title="tools">tools (1)</a></li>
        
        <li><a href="/categories.html#cat-iot" title="iot">iot (5)</a></li>
        
    </ul>
</div>

<hr class="small-margin colored-hr" />

<!-- google adsense -->
<!--
<div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
        style="display:inline-block;width:300px;height:600px"
        data-ad-client="ca-pub-1339945837472110"
        data-ad-slot="8220828081"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>
-->


                    </div>
                </div>
            </div>

            <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <hr class="colored-hr" />

                <p class="text-center">
                Copyright 2014 - 2016 | Gen time&#58; 2016-04-12 01:51:47 CST

                <!-- cnzz -->
                

                </p>


            </div>
        </div>
    </div>
    <div style="display:none;" class="back-to" id="toolBackTop">
        <a title="返回顶部" onclick="window.scrollTo(0,0);return false;" href="#top" class="back-top">返回顶部</a>
    </div>

    <!-- google analytics -->
    


</div>

    </body>
</html>
