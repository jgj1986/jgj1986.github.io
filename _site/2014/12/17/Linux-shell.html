<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="author" content="jgj" />
        <meta name="viewport" content="width=device-width" /> 
        <title>Linux Shell | 我是疯子</title>
        
        <meta name="keywords" content="" />
        

        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- bootstrap source -->
        <!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <!-- 可选的Bootstrap主题文件（一般不用引入） -->
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
        <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
        <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
        <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
        <script src="http://cdn.bootcss.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="/asset/css/kissdata.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <link href="/feed.html" rel="alternate" title="jgj" type="application/atom+xml" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="icon" href="/favicon.ico" />

        <style type="text/css">
            body {
                padding-top: 55px;
                padding-bottom: 30px;
                background-color: #EEE;
            }
        </style>

        <link rel="stylesheet" href="/asset/js/google-code-prettify/prettify.css">
        <script src="/asset/js/google-code-prettify/prettify.js"></script>

        <script type="text/javascript">
            $(document).ready(function () {

                // go to top
                var bt = $('#toolBackTop'); var sw = $(document.body)[0].clientWidth; var limitsw = (sw - 840) / 2 - 80; if (limitsw > 0){ limitsw = parseInt(limitsw); bt.css("right",limitsw); } $(window).scroll(function() { var st = $(window).scrollTop(); if(st > 30){ bt.show(); }else{ bt.hide(); } });

                // google-code-prettify
                $("pre").addClass("prettyprint linenums"); prettyPrint();

            })
        </script>

        <!-- kp747 
        
        -->
    </head>
    <body>
            <div id="header">
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand normal-a" href="javascript:void(0)" onclick="javascript:void(0)">
                    <span id="site_name">我是疯子</span>
                </a>
            </div>

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/categories.html">分类</a></li>
                    <li><a href="/guestbook.html">留言</a></li>
                    <li><a href="/about.html">关于</a></li>
                    <li><a href="/feed.html">RSS</a></li>
                    <li><a href="javascript:void(0)" class="normal-a" onclick="javascript:void(0)"><span id="site_description">在此停留片刻，偶有所得！</span></a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>


            <div class="container">
                <div class="row">
                    <div class="col-md-9" id="main-left">
                        <div class="page">
    <div class="head">
        <div class="title">Linux Shell</div>
        <div class="date">date: 2014-12-17</div>
    </div>
    <hr class="middle-margin" />


    <!-- google adsense -->
    <!--
    <div>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
            style="display:inline-block;width:728px;height:90px"
            data-ad-client="ca-pub-1339945837472110"
            data-ad-slot="9657522081"></ins>
        <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
    </div>
    <hr class="middle-margin" />
    -->

    <div class="content">
        <ul id="markdown-toc">
  <li><a href="#section">文件重命名</a></li>
  <li><a href="#section-1">文件内容修改</a></li>
  <li><a href="#xx">删除比xx更新的文件</a></li>
  <li><a href="#shell">Shell中一些单引号</a></li>
  <li><a href="#section-2">正则表达式反向引用</a></li>
  <li><a href="#section-3">一些指定的文件大小和</a></li>
  <li><a href="#scp">打包scp操作</a></li>
  <li><a href="#sed">sed拆分</a></li>
  <li><a href="#section-4">获取字符串长度</a></li>
  <li><a href="#ip">增加虚拟ip</a></li>
  <li><a href="#awk-">awk 输出时改变分隔符</a></li>
  <li><a href="#grep">grep的正则表达式</a></li>
  <li><a href="#awk--1">awk 几个例子</a></li>
  <li><a href="#grep-ascii">grep 非ascii</a></li>
  <li><a href="#bzip2--d">bzip2 -d文件失败的修复</a></li>
  <li><a href="#grep-1">grep两个关键字做去重</a></li>
  <li><a href="#if-grep-">非常有用的”if-grep” 结构</a></li>
  <li><a href="#section-5">控制字符</a></li>
</ul>

<blockquote>
  <p>本文记录在实际工作中用到的一些Bash Shell，可能比较偏门，但是方便以后使用</p>
</blockquote>

<h3 id="section">文件重命名</h3>

<p>参考 <a href="http://snailwarrior.blog.51cto.com/680306/139706" target="_blank">Linux批量重命名文件 </a>。<br />
我想把它们的名字的第一个1个字母变为”q”，其它的不变： </p>

<pre><code>for i in `ls`; do mv -f $i `echo $i | sed 's/^./q/'`; done
</code></pre>

<p>修改前面5个字母为zhaozh：</p>

<pre><code>for i in `ls`; do mv -f $i `echo $i | sed 's/^...../zhaozh/'`; done
</code></pre>

<p>修改后面5个字母为snail：</p>

<pre><code>for i in `ls`; do mv -f $i `echo $i | sed 's/.....$/snail/'`; done
</code></pre>

<p>在前面添加 <em>hoho</em>：</p>

<pre><code>for i in `ls`; do mv -f $i `echo "_hoho_"$i`; done
</code></pre>

<p>所有的小写字母变大写字母：</p>

<pre><code>for i in `ls`; do mv -f $i `echo $i | tr a-z A-Z`; done
</code></pre>

<p>多层目录下的文件，将TC开头的文件换乘MJ</p>

<pre><code>for i in `find ./ -name TC*`; do mv -f $i `echo $i | sed 's/\/TC/\/MJ/'`; done
</code></pre>

<p>将done改为update</p>

<pre><code>for i in `find ./ -name done`; do mv $i `echo $i | sed 's/done/update/'` ; done
</code></pre>

<h3 id="section-1">文件内容修改</h3>

<p>第一种比较笨的办法，是将修改后的内容存到另一文件中，然后替换</p>

<pre><code>for i in `find ./ -type f`; do cat $i |  sed -e "s/AAAA/BBBBB/g" -e "s/CCCCC/DDDDD/g" &gt; bak ; mv bak $i; done
</code></pre>

<p>也可以直接用 <code>sed -i</code> 命令  </p>

<h3 id="xx">删除比xx更新的文件</h3>

<pre><code>for i in `find ./ \! -newer 1390534720.snapshot ` ; do rm $i ; done   ##older with \! -newer
</code></pre>

<p>find用户 -prune是除去这个目录</p>

<h3 id="shell">Shell中一些单引号</h3>

<p>sed中单引号</p>

<pre><code>echo "dds'fa" | sed -e "s#'##g"
</code></pre>

<p>awk中单引号</p>

<pre><code>echo "ddd'fs" | awk -F"'" '{print $1}'
</code></pre>

<p>awk打印单引号</p>

<pre><code>echo "ddd'fs" | awk -F"'" '{printf("%s \047 \n",$1) }'
</code></pre>

<h3 id="section-2">正则表达式反向引用</h3>

<p>在前面匹配的时候，一定要用()表示出来</p>

<pre><code>echo "optional string v = 1;" | sed -n -r 's/optional (int32|int64) (.*)/optional \1 \2 \/\/ \1  /p'
</code></pre>

<p>vim中的()要用反斜线 </p>

<pre><code>:'&lt;,'&gt;s/get_\(.*\);/get_\1() { return \1; }/g        
:'&lt;,'&gt;s/set_\(.*\);/set_\1(int m_\1) { this-&gt;\1 = m_\1; }/g
:%s/ok|\([0-9]\)|\([0-9.]*\)/ok|\1,price|\2,imei/g
</code></pre>

<h3 id="section-3">一些指定的文件大小和</h3>

<pre><code>du -sh 21_20131001* | awk -F'M' '{sum+=$1} END {print sum}'
</code></pre>

<p>这儿使用M做awk的分隔符</p>

<h3 id="scp">打包scp操作</h3>

<p>参考 <a href="http://www.thingy-ma-jig.co.uk/blog/03-09-2008/using-tar-and-ssh-improve-scp-speeds" target="_blank">ssh tar</a>  </p>

<pre><code>(cd /lib/modules; tar zcvf - 2.6.19 ) | ssh -p 60001 root@192.168.0.254 tar zxvf - -C /lib/modules/
ssh 192.168.1.2 -T -c arcfour -o Compression=no -x "tar cf - /remote/path" | tar xf - -C .
ssh -p 60020 work@ck -T -c arcfour -o Compression=no -x "cd /home/work/pb/base_pb/201311/; tar cf - 06" | tar xf - -C .
tar czf - www.example.com/ | ssh joebloggs@otherserver.com tar xzf - -C ~/
</code></pre>

<p>一些说明  <br />
T: turn off pseudo-tty to decrease cpu load on destination.<br />
c: arcfour: use the weakest but fastest SSH encryption. Must specify “Ciphers arcfour” in sshd_config on destination.<br />
o: Compression=no: Turn off SSH compression.
x: turn off X forwarding if it is on by default.</p>

<h3 id="sed">sed拆分</h3>

<pre><code>sed -n '10001,10200'p stats_21log &gt; stats_11
for i in {1..11}; do start_line=`echo $i*1000-999 | bc`; end_line=`echo $i*1000 | bc`; sed -n "$start_line,${end_line}p" stats_21log &gt; stats_$i ; done
</code></pre>

<p>注意，计算时使用bc，sed中使用双引号</p>

<h3 id="section-4">获取字符串长度</h3>

<pre><code>log_path_len=`expr length $log_path`
datetime_path=${log_dir:${log_path_len}:50}  
</code></pre>

<p>后者可以将字符串后面的字段获取到， log_dir开头的内容时log_path  </p>

<h3 id="ip">增加虚拟ip</h3>

<pre><code>ifconfig eth0:1 192.168.100.11 netmask 255.255.255.0
ifconfig eth0:2 192.168.100.12 netmask 255.255.255.0
</code></pre>

<h3 id="awk-">awk 输出时改变分隔符</h3>

<pre><code>echo "ab cd ds" | awk '{OFS=":"; $2="*";  print $0}' //如果没有$2="*" 这条，OFS=":"就不起作用
echo a b c d|awk '{OFS=":";print $1,$2,$3,$4}'    //这样也可以
echo a b c d|awk '{OFS=":";print $1 OFS $2,$3,$4}' //也可以
echo "ab:bc:d" | awk -F':'  '{print | "cut -d : -f -"(NF-1)}'      #delete the last field
</code></pre>

<p>前N个：cut -d 分隔符 -f -N
第X个：cut -d 分隔符 -f X
最后一个：awk -F 分隔符 ‘{pint $NF}’
去除最后一个：</p>

<pre><code>awk -F 分隔符 '{print | "cut -d 分隔符 -f -"(NF-1)}'
</code></pre>

<p>去除指定字段X：</p>

<pre><code>awk -F 分隔符 ’{print | "cut -d 分隔符 -f 1-(X-1),(X+1)-"(NF)}' 
</code></pre>

<h3 id="grep">grep的正则表达式</h3>

<pre><code>grep -o "device=.*&amp;" file   --- 会时贪婪搜索
grep -o "device=.*?&amp;" file  --- shell的正则中不支持？的懒惰
grep -o "device=[^&amp;]*" file --- 得到预期的到&amp;之间的数据
</code></pre>

<h3 id="awk--1">awk 几个例子</h3>

<pre><code>awk '{a[$1]+=$2;}END{for(i in a){if(a[i]&gt;8){print i" "a[i];}}}' aa
cat */result_201* | awk -F' ' '{tmp=$1; $1="";gsub(/ /, "-"); val[$0]+=tmp}END{for(i in val) {print val[i]" "i};}' | sort -n -r &gt; total 
</code></pre>

<p>多个文件中包含设备类型及个数，合并求和 (大写转为小写)</p>

<pre><code>cat *_201406 | tr "[:upper:]" "[:lower:]" | awk '{names[$2]+=$1} END {for (i in names) {print names[i] " " i} }'
</code></pre>

<h3 id="grep-ascii">grep 非ascii</h3>

<p>打印行数，并高亮显示非ascii码字符</p>

<pre><code>grep --color='auto' -P -n "[\x80-\xFF]" file.xml
</code></pre>

<h3 id="bzip2--d">bzip2 -d文件失败的修复</h3>

<pre><code>bzip2recover file.bz2
bzip2 -d rec*.bz2 &gt; file   
</code></pre>

<h3 id="grep-1">grep两个关键字做去重</h3>

<p>想要实现功能
* file_name中包含InitGame 或UserLogin的行
* 这些行中取equdid(设备id)、channel(渠道号)这两个的内容
* 对这两个内容，做去重求和</p>

<pre><code>grep  -E "InitGame|UserLogin" file_name | grep -o -E "equdid=[^:]*|channel=[^:]*" | awk '{if(NR%2==0){print $0}else{printf "%s:",$0}}' | sort | uniq | wc -l
</code></pre>

<p>说明，<code>grep -o -E</code> 可以得到两个关键字的内容，但是输出到两行中，于是用awk在一行中输出。上面的 <code>print $0</code>（而不是用printf）就换行。</p>

<h3 id="if-grep-">非常有用的”if-grep” 结构</h3>

<pre><code>if grep -q bash test.sh 
then  # in new line
    echo "find bash in test.sh"
fi
</code></pre>

<h3 id="section-5">控制字符</h3>

<pre><code>Ctl-B  光标后退,这应该依赖于bash输入的风格
Ctl-H  backspace,删除光标前边的字符
Ctl-I  就是tab键
Ctl-J  新行
Ctl-L  clear,清屏
Ctl-M  回车
Ctl-Q  继续(等价于XON字符),这个继续的标准输入在一个终端里
Ctl-S  挂起(等价于XOFF字符),这个被挂起的stdin在一个终端里,用Ctl-Q恢复
Ctl-U  删除光标到行首的所有字符,在某些设置下,删除全行. 
Ctl-V  当输入字符时,Ctl-V允许插入控制字符.比如,下边2个例子是等价的
        echo -e '\x0a' 
        echo &lt;Ctl-V&gt;&lt;Ctl-J&gt; 
        Ctl-V 在文本编辑器中十分有用,在vim中一样. 
Ctl-W  删除当前光标到前边的最近一个空格之间的字符. 
       在某些设置下,删除到第一个非字母或数字的字符. 
Ctl-Z  终止前台工作. 
</code></pre>


    </div>
</div>



    
        <div class="comment">
    
    <!-- duoshuo -->
    
    <div class="ds-thread" data-thread-key="/2014/12/17/Linux-shell" data-title="Linux Shell" data-url="http://jgj1986.github.io/2014/12/17/Linux-shell.html"></div>
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-woshifengzi"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.unstable.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    

    
    <!-- disqus -->
    
    
    
</div>

    



                    </div>
                    <div class="col-md-3" id="main-right">
                        <div>
    <h4><strong>文章分类</strong></h4>
    <hr class="small-margin colored-hr" />
    <ul class="side-cat-ul">
        
        <li><a href="/categories.html#cat-生活随记" title="生活随记">生活随记 (3)</a></li>
        
        <li><a href="/categories.html#cat-bigdata" title="bigdata">bigdata (9)</a></li>
        
        <li><a href="/categories.html#cat-web" title="web">web (9)</a></li>
        
        <li><a href="/categories.html#cat-database" title="database">database (3)</a></li>
        
        <li><a href="/categories.html#cat-linux" title="linux">linux (10)</a></li>
        
        <li><a href="/categories.html#cat-go" title="go">go (8)</a></li>
        
        <li><a href="/categories.html#cat-运维" title="运维">运维 (3)</a></li>
        
        <li><a href="/categories.html#cat-language" title="language">language (7)</a></li>
        
        <li><a href="/categories.html#cat-tools" title="tools">tools (1)</a></li>
        
        <li><a href="/categories.html#cat-iot" title="iot">iot (5)</a></li>
        
    </ul>
</div>

<hr class="small-margin colored-hr" />

<!-- google adsense -->
<!--
<div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
        style="display:inline-block;width:300px;height:600px"
        data-ad-client="ca-pub-1339945837472110"
        data-ad-slot="8220828081"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>
-->


                    </div>
                </div>
            </div>

            <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <hr class="colored-hr" />

                <p class="text-center">
                Copyright 2014 - 2016 | Gen time&#58; 2016-04-12 01:51:47 CST

                <!-- cnzz -->
                

                </p>


            </div>
        </div>
    </div>
    <div style="display:none;" class="back-to" id="toolBackTop">
        <a title="返回顶部" onclick="window.scrollTo(0,0);return false;" href="#top" class="back-top">返回顶部</a>
    </div>

    <!-- google analytics -->
    


</div>

    </body>
</html>
